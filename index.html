<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b57d0" />
  <title>Meu Drive</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon-192.png" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    :root{
      --bg1:#071022;
      --bg2:#0b2a66;
      --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --brand:#4f7cf0;
      --brand2:#2dd4bf;
      --danger:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:22px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    html { color-scheme: dark; }
    select, option { color-scheme: dark; }

    body{
      margin:0;
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 30% 20%, rgba(79,124,240,.35), transparent 60%),
        radial-gradient(900px 600px at 80% 60%, rgba(45,212,191,.22), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{ width:min(1180px, 92vw); margin: 26px auto 40px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; margin-bottom:16px;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .appIcon{
      width:48px; height:48px; border-radius:14px; overflow:hidden;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      flex:0 0 auto; display:flex; align-items:center; justify-content:center;
    }
    .appIcon img{ width:100%; height:100%; object-fit:cover; display:block; }
    .titleWrap{ min-width:0; }
    h1{ font-size:28px; margin:0; letter-spacing:.2px; white-space:nowrap; }
    .subtitle{
      margin:4px 0 0; color:var(--muted); font-size:14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:65vw;
    }

    .userChip{
      display:none; align-items:center; gap:10px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:8px 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      max-width: 48%;
    }
    .avatar{
      width:34px; height:34px; border-radius:999px;
      background: linear-gradient(135deg, rgba(79,124,240,.9), rgba(45,212,191,.9));
      display:grid; place-items:center; font-weight:900; flex:0 0 auto;
    }
    .userMeta{ min-width:0; }
    .userName{ font-size:13px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .userEmail{ font-size:12px; color:var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Layout */
    .mainGrid{ display:grid; gap:16px; grid-template-columns: 1fr; }
    .leftCol, .rightCol{ display:flex; flex-direction:column; gap:16px; }
    @media (min-width: 980px){
      .mainGrid{ grid-template-columns: 320px 1fr; align-items:start; }
    }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .cardHead b{ font-size:14px; }
    .cardBody{ padding:14px 16px; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .field{ flex:1 1 220px; min-width:180px; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,18,32,.55);
      color: var(--txt);
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color: rgba(255,255,255,.45); }

    select{
      appearance:none; -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.75) 50%),
        linear-gradient(135deg, rgba(255,255,255,.75) 50%, transparent 50%),
        linear-gradient(to right, rgba(255,255,255,.10), rgba(255,255,255,.10));
      background-position:
        calc(100% - 18px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px),
        calc(100% - 38px) 50%;
      background-size: 6px 6px, 6px 6px, 1px 18px;
      background-repeat:no-repeat;
      padding-right: 44px;
    }
    option{ background-color:#0b1220; color:#fff; }

    .btn{
      border:0; border-radius:16px;
      padding:12px 16px; font-weight:900; cursor:pointer;
      background: rgba(255,255,255,.10);
      color: var(--txt);
      border:1px solid rgba(255,255,255,.14);
      transition: transform .06s ease, filter .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(79,124,240,.95), rgba(79,124,240,.65));
      border-color: rgba(79,124,240,.55);
    }
    .btnDanger{
      background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(239,68,68,.55));
      border-color: rgba(239,68,68,.55);
    }
    .btnSmall{
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      font-weight:900;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }

    .tabs{
      display:flex; gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px; border-radius:999px;
      width: fit-content;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      border:1px solid transparent;
      color: rgba(255,255,255,.75);
      background: transparent;
    }
    .tab.active{
      background: rgba(79,124,240,.35);
      border-color: rgba(79,124,240,.45);
      color: var(--txt);
    }

    /* Files list */
    .list{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .item{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .badge{
      width:38px; height:38px;
      border-radius:14px;
      display:grid; place-items:center;
      background: rgba(79,124,240,.22);
      border:1px solid rgba(79,124,240,.25);
      flex:0 0 auto;
      font-weight:900;
    }
    .meta{ min-width:0; }
    .name{
      font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 64vw;
    }
    .sub{
      font-size:12px;
      color: var(--muted2);
      margin-top:2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 64vw;
    }
    @media(min-width: 980px){
      .name{ max-width: 520px; }
      .sub{ max-width: 520px; }
    }
    .right{ display:flex; gap:8px; flex:0 0 auto; align-items:center; }

    .empty{
      margin-top:12px;
      color: var(--muted2);
      text-align:center;
      padding:18px 10px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
    }

    /* Gallery */
    .gallery{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
      margin-top:12px;
    }
    @media(min-width: 720px){ .gallery{ grid-template-columns: repeat(3, 1fr); } }
    @media(min-width: 1060px){ .gallery{ grid-template-columns: repeat(4, 1fr); } }

    .thumb{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      min-height: 168px;
      position:relative;
    }
    .thumbTop{
      flex:1; display:grid; place-items:center;
      background: rgba(0,0,0,.15);
      position:relative;
    }
    .thumbTop img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumbTop .fileIcon{ font-size:34px; opacity:.9; }
    .thumbBottom{ padding:10px 10px 12px; }
    .thumbName{
      font-weight:900; font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .thumbSub{
      margin-top:4px; font-size:12px;
      color:var(--muted2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .thumbActions{
      position:absolute; top:10px; right:10px;
      display:flex; gap:6px; z-index:5;
    }
    .chipBtn{
      width:36px; height:36px; border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(10,18,32,.55);
      color: rgba(255,255,255,.90);
      display:grid; place-items:center;
      cursor:pointer;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 25px rgba(0,0,0,.22);
      transition: transform .06s ease, filter .2s ease;
      user-select:none;
    }
    .chipBtn:active{ transform: translateY(1px); }
    .chipBtnDanger{
      border-color: rgba(239,68,68,.38);
      background: rgba(239,68,68,.18);
    }

    /* Folder UI */
    .folderList{ display:flex; flex-direction:column; gap:8px; }
    .folderRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
    }
    .folderRow.active{
      background: rgba(79,124,240,.20);
      border-color: rgba(79,124,240,.35);
    }
    .folderLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .folderIcon{
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      background: rgba(45,212,191,.16);
      border:1px solid rgba(45,212,191,.22);
      flex:0 0 auto;
    }
    .folderName{
      font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .folderCount{
      font-size:12px; color: var(--muted2);
      white-space:nowrap;
    }
    .folderActions{ display:flex; gap:6px; flex:0 0 auto; }
    .iconBtn{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none;
    }
    .iconBtnDanger{
      border-color: rgba(239,68,68,.38);
      background: rgba(239,68,68,.18);
    }

    /* Mobile folders: cards */
    .folderCards{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    @media(min-width: 520px){
      .folderCards{ grid-template-columns: repeat(3, 1fr); }
    }
    .folderCard{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding:12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height: 92px;
    }
    .folderCard.active{
      background: rgba(79,124,240,.20);
      border-color: rgba(79,124,240,.35);
    }
    .folderCardTop{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .folderCardName{
      font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .folderCardSub{ font-size:12px; color: var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Show sidebar on PC; cards on mobile */
    .foldersDesktop{ display:none; }
    .foldersMobile{ display:block; }
    @media(min-width: 980px){
      .foldersDesktop{ display:block; }
      .foldersMobile{ display:none; }
    }

    /* Loader overlay */
    .loaderOverlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(2,8,18,.60);
      backdrop-filter: blur(8px);
      z-index:9999;
    }
    .spinner{
      width:56px; height:56px;
      border-radius:50%;
      border: 5px solid rgba(255,255,255,.18);
      border-top-color: rgba(79,124,240,.95);
      animation: spin .9s linear infinite;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* Modal preview */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9998;
      padding: 18px;
    }
    .modalCard{
      width:min(980px, 94vw);
      max-height: 86vh;
      background: rgba(10,18,32,.86);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .modalTitle{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modalBody{
      padding: 12px;
      overflow:auto;
      display:grid;
      place-items:center;
      min-height: 40vh;
    }
    .modalBody img, .modalBody video{
      max-width: 100%;
      max-height: 70vh;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
    }
    .modalBody iframe{
      width: 100%;
      height: 70vh;
      border:0;
      border-radius: 16px;
      background: rgba(0,0,0,.25);
    }
    .mutedNote{
      font-size:12px;
      color: var(--muted2);
      margin-top:8px;
      text-align:center;
    }

    /* Views */
    .view{ transition: opacity .25s ease, transform .25s ease; }
    .hide{
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      height:0;
      overflow:hidden;
    }
  </style>
</head>

<body>
  <div id="loaderOverlay" class="loaderOverlay" aria-hidden="true">
    <div class="spinner" aria-label="Carregando"></div>
  </div>

  <!-- Modal Preview -->
  <div id="previewModal" class="modal" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalHead">
        <div class="modalTitle" id="previewTitle">Preview</div>
        <div class="row" style="gap:8px;">
          <a id="previewOpenNew" class="btn btnSmall" href="#" target="_blank" rel="noopener">Abrir em nova aba</a>
          <button id="previewClose" class="btn btnSmall">Fechar</button>
        </div>
      </div>
      <div class="modalBody" id="previewBody"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="appIcon"><img src="./icon-192.png" alt="Meu Drive"></div>
        <div class="titleWrap">
          <h1>Meu Drive ‚òÅÔ∏è</h1>
          <div class="subtitle" id="subtitleLine">Seus arquivos em um s√≥ lugar.</div>
        </div>
      </div>

      <div id="userChip" class="userChip">
        <div id="avatar" class="avatar">U</div>
        <div class="userMeta">
          <div id="userName" class="userName">Usu√°rio</div>
          <div id="userEmail" class="userEmail">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginView" class="view card">
      <div class="cardHead"><b>Entrar / Criar conta</b></div>
      <div class="cardBody">
        <div class="row">
          <div class="field">
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="seuemail@gmail.com" autocomplete="email" />
          </div>
          <div class="field">
            <label for="password">Senha</label>
            <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button id="btnLogin" class="btn btnPrimary">Entrar</button>
          <button id="btnRegister" class="btn">Criar conta</button>
        </div>
        <div class="mutedNote" style="margin-top:12px;">Dica: cada usu√°rio v√™ s√≥ os pr√≥prios arquivos.</div>
      </div>
    </div>

    <!-- APP -->
    <div id="appView" class="view hide">
      <div class="mainGrid">
        <!-- LEFT -->
        <div class="leftCol">

          <!-- Sess√£o -->
          <div class="card">
            <div class="cardHead">
              <b>Sess√£o</b>
              <button id="btnLogout" class="btn btnSmall btnDanger">Sair</button>
            </div>
            <div class="cardBody">
              <div style="color:var(--muted); font-size:12px;">Logado como:</div>
              <div id="sessionEmail" style="margin-top:6px; font-weight:900; word-break:break-word;">‚Äî</div>
            </div>
          </div>

          <!-- Pastas (PC sidebar) -->
          <div class="card foldersDesktop">
            <div class="cardHead">
              <b>Pastas</b>
              <button id="btnNewFolderDesktop" class="btn btnSmall">+ Pasta</button>
            </div>
            <div class="cardBody">
              <div id="folderListDesktop" class="folderList"></div>
              <div class="mutedNote">No PC: clique na pasta pra filtrar.</div>
            </div>
          </div>

          <!-- Pastas (Mobile cards) -->
          <div class="card foldersMobile">
            <div class="cardHead">
              <b>Pastas</b>
              <button id="btnNewFolderMobile" class="btn btnSmall">+ Pasta</button>
            </div>
            <div class="cardBody">
              <div id="folderCardsMobile" class="folderCards"></div>
              <div class="mutedNote">No celular: toque numa pasta pra abrir os arquivos.</div>
            </div>
          </div>

          <!-- Upload -->
          <div class="card">
            <div class="cardHead">
              <b>Upload</b>
              <div style="font-size:12px;color:var(--muted)">Cloudinary + Firestore</div>
            </div>
            <div class="cardBody">
              <div class="row">
                <div class="field" style="flex: 1 1 100%;">
                  <label for="fileInput">Arquivo</label>
                  <input id="fileInput" type="file" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="field" style="flex: 1 1 100%;">
                  <label for="customName">Nome do arquivo (opcional)</label>
                  <input id="customName" type="text" placeholder="Ex: Contrato aluguel 2026" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="field">
                  <label for="folderSelect">Salvar em</label>
                  <select id="folderSelect"></select>
                </div>
              </div>

              <div class="row" style="margin-top:12px;">
                <button id="btnUpload" class="btn btnPrimary">Enviar arquivo</button>
                <span id="uploadStatus" style="color:var(--muted); font-size:13px;"></span>
              </div>

              <div class="mutedNote" style="margin-top:10px;">
                Obs: se voc√™ digitar o nome sem extens√£o, eu coloco a extens√£o original automaticamente.
              </div>
            </div>
          </div>

          <!-- Filtros + modo -->
          <div class="card">
            <div class="cardHead"><b>Busca</b></div>
            <div class="cardBody">
              <div class="row">
                <div class="field">
                  <label for="searchInput">Buscar por nome</label>
                  <input id="searchInput" type="text" placeholder="Ex: contrato, foto, video..." />
                </div>
                <div class="field">
                  <label for="filterType">Filtrar por tipo</label>
                  <select id="filterType">
                    <option value="all">Todos</option>
                    <option value="image">Imagens</option>
                    <option value="video">V√≠deos</option>
                    <option value="pdf">PDFs</option>
                    <option value="other">Outros</option>
                  </select>
                </div>
              </div>

              <div class="row" style="margin-top:10px; justify-content:space-between;">
                <div class="tabs">
                  <button id="tabList" class="tab active" type="button">Lista</button>
                  <button id="tabGallery" class="tab" type="button">Galeria</button>
                </div>
                <button id="btnRefresh" class="btn btnSmall">Atualizar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="rightCol">
          <div class="card">
            <div class="cardHead">
              <div style="display:flex; flex-direction:column; gap:4px; min-width:0;">
                <b id="filesTitle">Arquivos</b>
                <div style="font-size:12px;color:var(--muted2)" id="breadcrumb">Todos</div>
              </div>
              <div style="font-size:12px;color:var(--muted)">
                <span id="countLabel">0</span> itens
              </div>
            </div>
            <div class="cardBody">
              <div id="listView" class="list"></div>
              <div id="galleryView" class="gallery" style="display:none;"></div>
              <div id="emptyState" class="empty" style="display:none;">Nenhum arquivo aqui ainda.</div>
            </div>
          </div>

          <div class="mutedNote">
            Agora as pastas s√£o ‚Äúde verdade‚Äù (collection <b>folders</b>). Depois a gente faz ‚ÄúMover‚Äù e delete Cloudinary via backend ‚úÖ
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAYAwMfCDcXALBVM1uemmJA4aWQK5MNcc0",
      authDomain: "meu-drive-beb33.firebaseapp.com",
      projectId: "meu-drive-beb33",
      storageBucket: "meu-drive-beb33.firebasestorage.app",
      messagingSenderId: "661176300748",
      appId: "1:661176300748:web:68ab970ae9e668fdb67e69"
    };

    const CLOUDINARY_CLOUD = "dilyddwkg";
    const CLOUDINARY_PRESET = "kv9sjt0g";
  </script>

  <script>
    firebase.initializeApp(FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM
    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");
    const loaderOverlay = document.getElementById("loaderOverlay");

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const btnLogin = document.getElementById("btnLogin");
    const btnRegister = document.getElementById("btnRegister");

    const userChip = document.getElementById("userChip");
    const avatarEl = document.getElementById("avatar");
    const userNameEl = document.getElementById("userName");
    const userEmailEl = document.getElementById("userEmail");
    const sessionEmail = document.getElementById("sessionEmail");
    const btnLogout = document.getElementById("btnLogout");

    const folderListDesktop = document.getElementById("folderListDesktop");
    const folderCardsMobile = document.getElementById("folderCardsMobile");
    const btnNewFolderDesktop = document.getElementById("btnNewFolderDesktop");
    const btnNewFolderMobile = document.getElementById("btnNewFolderMobile");

    const folderSelect = document.getElementById("folderSelect");

    const fileInput = document.getElementById("fileInput");
    const customNameInput = document.getElementById("customName");
    const btnUpload = document.getElementById("btnUpload");
    const uploadStatus = document.getElementById("uploadStatus");

    const searchInput = document.getElementById("searchInput");
    const filterType = document.getElementById("filterType");
    const btnRefresh = document.getElementById("btnRefresh");

    const tabList = document.getElementById("tabList");
    const tabGallery = document.getElementById("tabGallery");

    const listView = document.getElementById("listView");
    const galleryView = document.getElementById("galleryView");
    const emptyState = document.getElementById("emptyState");
    const countLabel = document.getElementById("countLabel");

    const filesTitle = document.getElementById("filesTitle");
    const breadcrumb = document.getElementById("breadcrumb");

    // Modal
    const previewModal = document.getElementById("previewModal");
    const previewTitle = document.getElementById("previewTitle");
    const previewBody = document.getElementById("previewBody");
    const previewClose = document.getElementById("previewClose");
    const previewOpenNew = document.getElementById("previewOpenNew");

    // State
    let currentUser = null;
    let allFiles = [];
    let folders = []; // [{id,name,uid,createdAt}]
    let selectedFolderId = "all"; // all | unfiled | <folderId>
    let currentMode = "list";

    // Helpers
    function showLoader(msg){
      loaderOverlay.style.display = "flex";
      loaderOverlay.setAttribute("aria-hidden", "false");
      uploadStatus.textContent = msg || "";
    }
    function hideLoader(){
      loaderOverlay.style.display = "none";
      loaderOverlay.setAttribute("aria-hidden", "true");
      uploadStatus.textContent = "";
    }
    function toast(msg){ alert(msg); }

    function setView(isLogged){
      if(isLogged){
        loginView.classList.add("hide");
        appView.classList.remove("hide");
        userChip.style.display = "flex";
      } else {
        appView.classList.add("hide");
        loginView.classList.remove("hide");
        userChip.style.display = "none";
      }
    }
    function getInitials(email){ return (email||"U").trim().charAt(0).toUpperCase(); }

    function niceType(mime){
      if(!mime) return "other";
      if(mime.startsWith("image/")) return "image";
      if(mime.startsWith("video/")) return "video";
      if(mime === "application/pdf") return "pdf";
      return "other";
    }
    function typeBadge(t){
      if(t==="image") return "üñºÔ∏è";
      if(t==="video") return "üé¨";
      if(t==="pdf") return "üìÑ";
      return "üì¶";
    }
    function bytesToSize(bytes){
      if(!bytes && bytes !== 0) return "";
      const sizes = ["B","KB","MB","GB"];
      let i = 0, v = bytes;
      while(v >= 1024 && i < sizes.length-1){ v/=1024; i++; }
      return `${v.toFixed(v >= 10 || i===0 ? 0 : 1)} ${sizes[i]}`;
    }
    function formatDate(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
        if(!d) return "";
        return d.toLocaleString("pt-BR");
      }catch{ return ""; }
    }

    // Name + extension (B)
    function getFileExtension(filename){
      const name = (filename || "").trim();
      const i = name.lastIndexOf(".");
      if(i <= 0 || i === name.length - 1) return "";
      return name.slice(i).toLowerCase();
    }
    function ensureNameWithExtension(baseName, originalFilename){
      const base = (baseName || "").trim();
      const orig = (originalFilename || "").trim();
      const origExt = getFileExtension(orig);
      const baseExt = getFileExtension(base);
      if(!base) return orig || ("arquivo" + (origExt || ""));
      if(baseExt) return base;
      return base + (origExt || "");
    }

    // Collections
    function filesCol(){ return db.collection("files"); }
    function foldersCol(){ return db.collection("folders"); }

    // Preview
    function closePreview(){
      previewModal.style.display = "none";
      previewBody.innerHTML = "";
      previewOpenNew.href = "#";
    }
    function openPreview(file){
      previewTitle.textContent = file.name || "Preview";
      previewOpenNew.href = file.url || "#";
      previewBody.innerHTML = "";

      const t = file.type;
      if(t === "image"){
        const img = document.createElement("img");
        img.src = file.url;
        img.alt = file.name || "Imagem";
        previewBody.appendChild(img);
      } else if(t === "video"){
        const video = document.createElement("video");
        video.src = file.url;
        video.controls = true;
        video.playsInline = true;
        previewBody.appendChild(video);
      } else if(t === "pdf"){
        const iframe = document.createElement("iframe");
        iframe.src = file.url;
        previewBody.appendChild(iframe);
      } else {
        const box = document.createElement("div");
        box.style.textAlign = "center";
        box.innerHTML = `
          <div style="font-size:54px;margin-bottom:10px;">${typeBadge(t)}</div>
          <div style="font-weight:900;font-size:16px;">${(file.name || "Arquivo")}</div>
          <div class="mutedNote">Sem preview nativo. Use ‚ÄúAbrir em nova aba‚Äù.</div>
        `;
        previewBody.appendChild(box);
      }
      previewModal.style.display = "flex";
    }
    previewClose.addEventListener("click", closePreview);
    previewModal.addEventListener("click", (e) => { if(e.target === previewModal) closePreview(); });

    // Folder utilities
    function getFolderLabelById(id){
      if(id === "all") return "Todos";
      if(id === "unfiled") return "Sem pasta";
      const f = folders.find(x => x.id === id);
      return f ? f.name : "Pasta";
    }
    function setSelectedFolder(id){
      selectedFolderId = id;
      breadcrumb.textContent = getFolderLabelById(id);
      filesTitle.textContent = (id === "all") ? "Arquivos" : "Arquivos";
      // atualiza select do upload
      folderSelect.value = id;
      applyFilters();
      renderFoldersUI();
    }

    function renderFoldersUI(){
      // contagem por folderId
      const counts = new Map();
      for(const f of allFiles){
        const fid = f.folderId || "unfiled";
        counts.set(fid, (counts.get(fid) || 0) + 1);
      }

      // Desktop list
      folderListDesktop.innerHTML = "";
      const desktopItems = [
        { id:"all", name:"Todos os arquivos", icon:"üìÅ" },
        { id:"unfiled", name:"Sem pasta", icon:"üóÇÔ∏è" },
        ...folders.map(x => ({ id:x.id, name:x.name, icon:"üìÅ" }))
      ];

      for(const it of desktopItems){
        const row = document.createElement("div");
        row.className = "folderRow" + (it.id === selectedFolderId ? " active" : "");
        row.addEventListener("click", () => setSelectedFolder(it.id));

        const left = document.createElement("div");
        left.className = "folderLeft";

        const icon = document.createElement("div");
        icon.className = "folderIcon";
        icon.textContent = it.icon;

        const name = document.createElement("div");
        name.className = "folderName";
        name.textContent = it.name;

        const count = document.createElement("div");
        count.className = "folderCount";
        count.textContent = `${counts.get(it.id) || 0}`;

        left.appendChild(icon);
        left.appendChild(name);

        const actions = document.createElement("div");
        actions.className = "folderActions";

        // a√ß√µes s√≥ para pastas reais
        if(it.id !== "all" && it.id !== "unfiled"){
          const btnEdit = document.createElement("button");
          btnEdit.className = "iconBtn";
          btnEdit.title = "Renomear pasta";
          btnEdit.textContent = "‚úèÔ∏è";
          btnEdit.addEventListener("click", (e) => { e.stopPropagation(); renameFolder(it.id, it.name); });

          const btnDel = document.createElement("button");
          btnDel.className = "iconBtn iconBtnDanger";
          btnDel.title = "Excluir pasta";
          btnDel.textContent = "üóëÔ∏è";
          btnDel.addEventListener("click", (e) => { e.stopPropagation(); deleteFolder(it.id, it.name); });

          actions.appendChild(btnEdit);
          actions.appendChild(btnDel);
        }

        row.appendChild(left);
        row.appendChild(count);
        row.appendChild(actions);

        folderListDesktop.appendChild(row);
      }

      // Mobile cards
      folderCardsMobile.innerHTML = "";
      const mobileItems = [
        { id:"all", name:"Todos", sub:`${allFiles.length} itens`, icon:"üìÅ" },
        { id:"unfiled", name:"Sem pasta", sub:`${counts.get("unfiled") || 0} itens`, icon:"üóÇÔ∏è" },
        ...folders.map(x => ({ id:x.id, name:x.name, sub:`${counts.get(x.id) || 0} itens`, icon:"üìÅ" }))
      ];

      for(const it of mobileItems){
        const card = document.createElement("div");
        card.className = "folderCard" + (it.id === selectedFolderId ? " active" : "");
        card.addEventListener("click", () => setSelectedFolder(it.id));

        const top = document.createElement("div");
        top.className = "folderCardTop";

        const name = document.createElement("div");
        name.className = "folderCardName";
        name.textContent = `${it.icon} ${it.name}`;

        const act = document.createElement("div");
        act.style.display = "flex";
        act.style.gap = "6px";

        if(it.id !== "all" && it.id !== "unfiled"){
          const b1 = document.createElement("button");
          b1.className = "iconBtn";
          b1.title = "Renomear";
          b1.textContent = "‚úèÔ∏è";
          b1.addEventListener("click", (e) => { e.stopPropagation(); renameFolder(it.id, it.name); });

          const b2 = document.createElement("button");
          b2.className = "iconBtn iconBtnDanger";
          b2.title = "Excluir";
          b2.textContent = "üóëÔ∏è";
          b2.addEventListener("click", (e) => { e.stopPropagation(); deleteFolder(it.id, it.name); });

          act.appendChild(b1);
          act.appendChild(b2);
        }

        top.appendChild(name);
        top.appendChild(act);

        const sub = document.createElement("div");
        sub.className = "folderCardSub";
        sub.textContent = it.sub;

        card.appendChild(top);
        card.appendChild(sub);

        folderCardsMobile.appendChild(card);
      }

      // Upload folder select
      folderSelect.innerHTML = `
        <option value="all" disabled>‚Äî selecionar pasta ‚Äî</option>
        <option value="unfiled">Sem pasta</option>
        ${folders.map(f => `<option value="${f.id}">${f.name}</option>`).join("")}
      `;
      // garantir sele√ß√£o coerente
      folderSelect.value = (selectedFolderId === "all") ? "unfiled" : selectedFolderId;
    }

    async function createFolder(){
      if(!currentUser) return;
      const name = prompt("Nome da nova pasta:");
      if(!name) return;
      const trimmed = name.trim();
      if(!trimmed) return;

      // evita duplicar por nome
      const exists = folders.some(f => f.name.toLowerCase() === trimmed.toLowerCase());
      if(exists) return toast("J√° existe uma pasta com esse nome.");

      showLoader("Criando pasta...");
      try{
        const doc = await foldersCol().add({
          uid: currentUser.uid,
          name: trimmed,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // atualiza local
        folders.unshift({ id: doc.id, uid: currentUser.uid, name: trimmed, createdAt: new Date() });
        renderFoldersUI();
        toast("Pasta criada ‚úÖ");
      }catch(err){
        console.error(err);
        toast("Erro ao criar pasta.");
      }finally{
        hideLoader();
      }
    }

    async function renameFolder(folderId, currentName){
      const newNameRaw = prompt("Novo nome da pasta:", currentName);
      if(!newNameRaw) return;
      const newName = newNameRaw.trim();
      if(!newName) return;

      const exists = folders.some(f => f.id !== folderId && f.name.toLowerCase() === newName.toLowerCase());
      if(exists) return toast("J√° existe uma pasta com esse nome.");

      showLoader("Renomeando pasta...");
      try{
        await foldersCol().doc(folderId).update({ name: newName });

        const idx = folders.findIndex(f => f.id === folderId);
        if(idx >= 0) folders[idx].name = newName;

        // opcional: atualizar label nos arquivos (folderName) ‚Äî n√£o √© obrigat√≥rio
        // Mantemos s√≥ folderId como fonte principal.

        renderFoldersUI();
        breadcrumb.textContent = getFolderLabelById(selectedFolderId);
      }catch(err){
        console.error(err);
        toast("Erro ao renomear pasta.");
      }finally{
        hideLoader();
      }
    }

    async function deleteFolder(folderId, folderName){
      const ok = confirm(`Excluir a pasta "${folderName}"?\n\nS√≥ d√° pra excluir se estiver vazia.`);
      if(!ok) return;

      showLoader("Verificando pasta...");
      try{
        // verifica se tem arquivos na pasta
        const snap = await filesCol()
          .where("uid", "==", currentUser.uid)
          .where("folderId", "==", folderId)
          .limit(1)
          .get();

        if(!snap.empty){
          return toast("Essa pasta n√£o est√° vazia. Mova os arquivos antes.");
        }

        await foldersCol().doc(folderId).delete();
        folders = folders.filter(f => f.id !== folderId);

        if(selectedFolderId === folderId){
          setSelectedFolder("all");
        } else {
          renderFoldersUI();
        }

        toast("Pasta exclu√≠da ‚úÖ");
      }catch(err){
        console.error(err);
        toast("Erro ao excluir pasta.");
      }finally{
        hideLoader();
      }
    }

    // Files UI
    function renderFiles(files){
      countLabel.textContent = String(files.length);
      emptyState.style.display = files.length ? "none" : "block";

      listView.innerHTML = "";
      galleryView.innerHTML = "";

      if(currentMode === "list"){
        listView.style.display = "flex";
        galleryView.style.display = "none";
        files.forEach(file => listView.appendChild(renderListItem(file)));
      } else {
        listView.style.display = "none";
        galleryView.style.display = "grid";
        files.forEach(file => galleryView.appendChild(renderThumb(file)));
      }
    }

    function renderListItem(file){
      const item = document.createElement("div");
      item.className = "item";

      const left = document.createElement("div");
      left.className = "left";

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = typeBadge(file.type);

      const meta = document.createElement("div");
      meta.className = "meta";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = file.name || "Arquivo";

      const sub = document.createElement("div");
      sub.className = "sub";

      const folderLabel =
        file.folderId ? getFolderLabelById(file.folderId) :
        (file.folder ? file.folder : "Sem pasta");

      const parts = [
        `üìÅ ${folderLabel}`,
        (file.size ?? null) !== null ? `üì¶ ${bytesToSize(file.size)}` : null,
        file.createdAt ? `üïí ${formatDate(file.createdAt)}` : null
      ].filter(Boolean);
      sub.textContent = parts.join(" ‚Ä¢ ");

      meta.appendChild(name);
      meta.appendChild(sub);

      left.appendChild(badge);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.className = "right";

      const btnPreview = document.createElement("button");
      btnPreview.className = "btn btnSmall";
      btnPreview.textContent = "Ver";
      btnPreview.addEventListener("click", (e) => { e.stopPropagation(); openPreview(file); });

      const btnRename = document.createElement("button");
      btnRename.className = "btn btnSmall";
      btnRename.textContent = "Renomear";
      btnRename.addEventListener("click", (e) => { e.stopPropagation(); renameFile(file); });

      const btnDelete = document.createElement("button");
      btnDelete.className = "btn btnSmall btnDanger";
      btnDelete.textContent = "Excluir";
      btnDelete.addEventListener("click", (e) => { e.stopPropagation(); deleteFile(file); });

      right.appendChild(btnPreview);
      right.appendChild(btnRename);
      right.appendChild(btnDelete);

      item.appendChild(left);
      item.appendChild(right);
      return item;
    }

    function renderThumb(file){
      const thumb = document.createElement("div");
      thumb.className = "thumb";
      thumb.addEventListener("click", () => openPreview(file));

      const actions = document.createElement("div");
      actions.className = "thumbActions";

      const aView = document.createElement("button");
      aView.className = "chipBtn";
      aView.type = "button";
      aView.title = "Ver";
      aView.textContent = "üëÅÔ∏è";
      aView.addEventListener("click", (e) => { e.stopPropagation(); openPreview(file); });

      const aRename = document.createElement("button");
      aRename.className = "chipBtn";
      aRename.type = "button";
      aRename.title = "Renomear";
      aRename.textContent = "‚úèÔ∏è";
      aRename.addEventListener("click", (e) => { e.stopPropagation(); renameFile(file); });

      const aDelete = document.createElement("button");
      aDelete.className = "chipBtn chipBtnDanger";
      aDelete.type = "button";
      aDelete.title = "Excluir";
      aDelete.textContent = "üóëÔ∏è";
      aDelete.addEventListener("click", (e) => { e.stopPropagation(); deleteFile(file); });

      actions.appendChild(aView);
      actions.appendChild(aRename);
      actions.appendChild(aDelete);

      const top = document.createElement("div");
      top.className = "thumbTop";

      if(file.type === "image"){
        const img = document.createElement("img");
        img.src = file.url;
        img.alt = file.name || "Imagem";
        top.appendChild(img);
      } else {
        const icon = document.createElement("div");
        icon.className = "fileIcon";
        icon.textContent = typeBadge(file.type);
        top.appendChild(icon);
      }

      const bottom = document.createElement("div");
      bottom.className = "thumbBottom";

      const n = document.createElement("div");
      n.className = "thumbName";
      n.textContent = file.name || "Arquivo";

      const folderLabel =
        file.folderId ? getFolderLabelById(file.folderId) :
        (file.folder ? file.folder : "Sem pasta");

      const s = document.createElement("div");
      s.className = "thumbSub";
      s.textContent = `${folderLabel} ‚Ä¢ ${bytesToSize(file.size || 0)}`;

      bottom.appendChild(n);
      bottom.appendChild(s);

      thumb.appendChild(actions);
      thumb.appendChild(top);
      thumb.appendChild(bottom);

      return thumb;
    }

    function applyFilters(){
      const q = (searchInput.value || "").trim().toLowerCase();
      const t = filterType.value;

      let filtered = allFiles.slice();

      // filtro por pasta selecionada
      if(selectedFolderId !== "all"){
        filtered = filtered.filter(f => (f.folderId || "unfiled") === selectedFolderId);
      }

      if(q){
        filtered = filtered.filter(x => (x.name||"").toLowerCase().includes(q));
      }
      if(t !== "all"){
        filtered = filtered.filter(x => x.type === t);
      }

      renderFiles(filtered);
    }

    async function loadFolders(){
      if(!currentUser) return;
      const snap = await foldersCol()
        .where("uid","==", currentUser.uid)
        .orderBy("createdAt","desc")
        .get();

      folders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderFoldersUI();
    }

    async function loadFiles(){
      if(!currentUser) return;

      showLoader("Carregando...");
      try{
        const snap = await filesCol()
          .where("uid","==", currentUser.uid)
          .orderBy("createdAt","desc")
          .get();

        allFiles = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        renderFoldersUI();
        applyFilters();
      }catch(err){
        console.error(err);
        toast("Erro ao carregar arquivos.");
      } finally {
        hideLoader();
      }
    }

    async function deleteFile(file){
      if(!currentUser) return;
      const ok = confirm(`Excluir "${file.name}"?`);
      if(!ok) return;

      showLoader("Excluindo...");
      try{
        await filesCol().doc(file.id).delete();
        allFiles = allFiles.filter(x => x.id !== file.id);
        renderFoldersUI();
        applyFilters();
      }catch(err){
        console.error(err);
        toast("Erro ao excluir.");
      } finally {
        hideLoader();
      }
    }

    async function renameFile(file){
      if(!currentUser) return;

      const current = file.name || file.originalName || "arquivo";
      const typed = prompt("Novo nome (com ou sem extens√£o):", current);
      if(!typed) return;

      const newName = ensureNameWithExtension(typed.trim(), file.originalName || file.name);

      showLoader("Renomeando...");
      try{
        await filesCol().doc(file.id).update({ name: newName });

        const idx = allFiles.findIndex(x => x.id === file.id);
        if(idx >= 0) allFiles[idx].name = newName;

        applyFilters();
      }catch(err){
        console.error(err);
        toast("Erro ao renomear.");
      }finally{
        hideLoader();
      }
    }

    // Upload Cloudinary
    async function uploadToCloudinary(file, folderPath){
      const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/auto/upload`;
      const form = new FormData();
      form.append("file", file);
      form.append("upload_preset", CLOUDINARY_PRESET);

      // organiza no Cloudinary por uid/pasta
      form.append("folder", folderPath);

      const res = await fetch(url, { method:"POST", body: form });
      const data = await res.json();
      if(!res.ok){
        console.error("Cloudinary error:", data);
        throw new Error(data?.error?.message || "Erro no Cloudinary");
      }
      return data;
    }

    async function doUpload(){
      if(!currentUser) return;

      const f = fileInput.files?.[0];
      if(!f){
        toast("Escolha um arquivo primeiro.");
        return;
      }

      // folderId selecionado no upload
      let fid = folderSelect.value || "unfiled";
      if(fid === "all") fid = "unfiled";

      const folderName = (fid === "unfiled") ? "Sem pasta" : (folders.find(x => x.id === fid)?.name || "Pasta");
      const cloudFolder = `${currentUser.uid}/${folderName}`;

      const typed = (customNameInput?.value || "").trim();
      const displayName = ensureNameWithExtension(typed, f.name);

      btnUpload.disabled = true;
      showLoader("Enviando...");
      uploadStatus.textContent = "Enviando...";

      try{
        const cloud = await uploadToCloudinary(f, cloudFolder);

        const record = {
          uid: currentUser.uid,
          name: displayName,
          originalName: f.name,
          folderId: fid,          // ‚úÖ novo: pasta real
          folderName: folderName, // opcional (ajuda no futuro)
          type: niceType(f.type),
          mime: f.type || "",
          size: cloud.bytes ?? f.size ?? 0,
          url: cloud.secure_url || cloud.url,
          public_id: cloud.public_id || "",
          resource_type: cloud.resource_type || "",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await filesCol().add(record);

        fileInput.value = "";
        if(customNameInput) customNameInput.value = "";
        uploadStatus.textContent = "Upload conclu√≠do ‚úÖ";

        await loadFiles();
      }catch(err){
        console.error(err);
        toast(`Erro no upload: ${err.message || err}`);
      } finally {
        btnUpload.disabled = false;
        hideLoader();
      }
    }

    // Auth
    btnLogin.addEventListener("click", async () => {
      const email = (emailEl.value || "").trim();
      const pass = passEl.value || "";
      if(!email || !pass) return toast("Preencha email e senha.");

      showLoader("Entrando...");
      try{ await auth.signInWithEmailAndPassword(email, pass); }
      catch(err){ console.error(err); toast(err?.message || "Erro ao entrar."); }
      finally{ hideLoader(); }
    });

    btnRegister.addEventListener("click", async () => {
      const email = (emailEl.value || "").trim();
      const pass = passEl.value || "";
      if(!email || !pass) return toast("Preencha email e senha.");

      showLoader("Criando conta...");
      try{ await auth.createUserWithEmailAndPassword(email, pass); }
      catch(err){ console.error(err); toast(err?.message || "Erro ao criar conta."); }
      finally{ hideLoader(); }
    });

    btnLogout.addEventListener("click", async () => {
      showLoader("Saindo...");
      try{ await auth.signOut(); }
      catch(err){ console.error(err); toast("Erro ao sair."); }
      finally{ hideLoader(); }
    });

    // Folder buttons
    btnNewFolderDesktop.addEventListener("click", createFolder);
    btnNewFolderMobile.addEventListener("click", createFolder);

    // Upload
    btnUpload.addEventListener("click", doUpload);

    // Tabs
    tabList.addEventListener("click", () => {
      currentMode = "list";
      tabList.classList.add("active");
      tabGallery.classList.remove("active");
      applyFilters();
    });
    tabGallery.addEventListener("click", () => {
      currentMode = "gallery";
      tabGallery.classList.add("active");
      tabList.classList.remove("active");
      applyFilters();
    });

    // Filters
    searchInput.addEventListener("input", applyFilters);
    filterType.addEventListener("change", applyFilters);
    btnRefresh.addEventListener("click", async () => {
      await loadFolders();
      await loadFiles();
    });

    folderSelect.addEventListener("change", (e) => {
      // s√≥ altera pasta padr√£o do upload, n√£o a navega√ß√£o
      // (o filtro √© controlado clicando na UI de pastas)
    });

    // Auth state
    auth.onAuthStateChanged(async (user) => {
      showLoader("Validando sess√£o...");
      try{
        currentUser = user || null;

        if(currentUser){
          const email = currentUser.email || "‚Äî";
          setView(true);

          sessionEmail.textContent = email;
          userEmailEl.textContent = email;
          userNameEl.textContent = (email.split("@")[0] || "Usu√°rio");
          avatarEl.textContent = getInitials(email);

          // default
          selectedFolderId = "all";
          breadcrumb.textContent = "Todos";

          await loadFolders();
          await loadFiles();
        } else {
          setView(false);
          allFiles = [];
          folders = [];
          listView.innerHTML = "";
          galleryView.innerHTML = "";
          emptyState.style.display = "none";
        }
      } finally {
        hideLoader();
      }
    });

    // PWA
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("./service-worker.js").catch(console.warn);
    }
  </script>
</body>
</html>
