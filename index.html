<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meu Drive</title>

  <meta name="theme-color" content="#0b57d0" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon-192.png" />

  <style>
    :root{
      --bg1:#071022;
      --bg2:#0b2a66;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --brand:#4f7cf0;
      --brand2:#2dd4bf;
      --danger:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 30% 20%, rgba(79,124,240,.35), transparent 60%),
        radial-gradient(900px 600px at 80% 60%, rgba(45,212,191,.22), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Fix geral pro ‚Äúlist√£o branco‚Äù no Chrome/Android */
    html { color-scheme: dark; }
    select, option { color-scheme: dark; }

    .wrap{
      width:min(980px, 92vw);
      margin: 26px auto 40px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .appIcon{
      width:48px; height:48px; border-radius:14px;
      overflow:hidden;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
    }
    .appIcon img{ width:100%; height:100%; object-fit:cover; display:block; }

    .titleWrap{ min-width:0; }
    h1{
      font-size:28px;
      margin:0;
      letter-spacing:.2px;
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .subtitle{
      margin:4px 0 0;
      color:var(--muted);
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .userChip{
      display:none;
      align-items:center;
      gap:10px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:8px 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      max-width: 46%;
    }
    .avatar{
      width:34px; height:34px; border-radius:999px;
      background: linear-gradient(135deg, rgba(79,124,240,.9), rgba(45,212,191,.9));
      display:grid; place-items:center;
      font-weight:800;
      flex:0 0 auto;
    }
    .userMeta{ min-width:0; }
    .userName{
      font-size:13px; font-weight:800;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .userEmail{
      font-size:12px; color:var(--muted2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead b{ font-size:14px; }
    .cardBody{ padding:14px 16px; }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .field{
      flex:1 1 220px;
      min-width: 180px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,18,32,.55);
      color: var(--txt);
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color: rgba(255,255,255,.45); }

    /* Deixa o dropdown ‚Äúdark‚Äù (o list√£o branco some aqui na maioria dos casos) */
    select{
      appearance:none;
      -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.75) 50%),
        linear-gradient(135deg, rgba(255,255,255,.75) 50%, transparent 50%),
        linear-gradient(to right, rgba(255,255,255,.10), rgba(255,255,255,.10));
      background-position:
        calc(100% - 18px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px),
        calc(100% - 38px) 50%;
      background-size: 6px 6px, 6px 6px, 1px 18px;
      background-repeat:no-repeat;
      padding-right: 44px;
    }
    option{
      background-color: #0b1220;   /* <<< aqui √© o principal */
      color: #fff;
    }

    .btn{
      border:0;
      border-radius:16px;
      padding:12px 16px;
      font-weight:800;
      cursor:pointer;
      background: rgba(255,255,255,.10);
      color: var(--txt);
      border:1px solid rgba(255,255,255,.14);
      transition: transform .06s ease, filter .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(79,124,240,.95), rgba(79,124,240,.65));
      border-color: rgba(79,124,240,.55);
    }
    .btnDanger{
      background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(239,68,68,.55));
      border-color: rgba(239,68,68,.55);
    }
    .btnSmall{
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      font-weight:800;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    .tabs{
      display:flex;
      gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px;
      border-radius:999px;
      width: fit-content;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      border:1px solid transparent;
      color: rgba(255,255,255,.75);
      background: transparent;
    }
    .tab.active{
      background: rgba(79,124,240,.35);
      border-color: rgba(79,124,240,.45);
      color: var(--txt);
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }

    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .left{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .badge{
      width:38px; height:38px;
      border-radius:14px;
      display:grid; place-items:center;
      background: rgba(79,124,240,.22);
      border:1px solid rgba(79,124,240,.25);
      flex:0 0 auto;
      font-weight:900;
    }
    .meta{
      min-width:0;
    }
    .name{
      font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 52vw;
    }
    .sub{
      font-size:12px;
      color: var(--muted2);
      margin-top:2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 52vw;
    }

    .right{ display:flex; gap:8px; flex:0 0 auto; }

    .empty{
      margin-top:12px;
      color: var(--muted2);
      text-align:center;
      padding:18px 10px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
    }

    /* Views + anima√ß√£o */
    .view{
      transition: opacity .25s ease, transform .25s ease;
    }
    .hide{
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      height:0;
      overflow:hidden;
    }

    /* Loader overlay */
    .loaderOverlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(2,8,18,.60);
      backdrop-filter: blur(8px);
      z-index:9999;
    }
    .spinner{
      width:56px; height:56px;
      border-radius:50%;
      border: 5px solid rgba(255,255,255,.18);
      border-top-color: rgba(79,124,240,.95);
      animation: spin .9s linear infinite;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
      .card.span2{ grid-column: 1 / -1; }
      .name{ max-width: 360px; }
      .sub{ max-width: 360px; }
    }
  </style>
</head>

<body>
  <div class="loaderOverlay" id="loaderOverlay" aria-hidden="true">
    <div class="spinner" aria-label="Carregando"></div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="appIcon">
          <img src="./icon-192.png" alt="Meu Drive" />
        </div>
        <div class="titleWrap">
          <h1>Meu Drive <span style="opacity:.8">‚òÅÔ∏è</span></h1>
          <div class="subtitle" id="subtitle">Seus arquivos em um s√≥ lugar.</div>
        </div>
      </div>

      <div class="userChip" id="userChip">
        <div class="avatar" id="avatar">M</div>
        <div class="userMeta">
          <div class="userName" id="userName">Usu√°rio</div>
          <div class="userEmail" id="userEmail">‚Äî</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- AUTH VIEW -->
      <div class="card view" id="authView">
        <div class="cardHead">
          <b>Acesso</b>
          <span style="font-size:12px;color:var(--muted)" id="pwaStatus">PWA: checando‚Ä¶</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="field">
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="seuemail@gmail.com" autocomplete="email" />
            </div>
            <div class="field">
              <label for="password">Senha</label>
              <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn btnPrimary" id="btnLogin" style="flex:1;">Entrar</button>
            <button class="btn" id="btnRegister" style="flex:1;">Criar conta</button>
          </div>

          <div style="margin-top:12px;color:var(--muted2);font-size:12px;">
            Dica: instale como app (PWA) pra abrir mais r√°pido e ficar com cara de aplicativo.
          </div>
        </div>
      </div>

      <!-- ACCOUNT -->
      <div class="card view hide" id="accountCard">
        <div class="cardHead">
          <b>Sess√£o</b>
          <span style="font-size:12px;color:var(--muted)">Conectado</span>
        </div>
        <div class="cardBody">
          <div style="font-weight:900; margin-bottom:10px;">
            Logado como: <span id="loggedEmail" style="color:rgba(255,255,255,.85)"></span>
          </div>
          <button class="btn btnDanger" id="btnLogout" style="width:100%;">Sair</button>
        </div>
      </div>

      <!-- UPLOAD -->
      <div class="card view hide" id="uploadCard">
        <div class="cardHead">
          <b>Upload</b>
          <span style="font-size:12px;color:var(--muted)">Cloudinary + Firestore</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="field" style="flex:2 1 260px;">
              <label for="fileInput">Arquivo</label>
              <input id="fileInput" type="file" />
            </div>

            <div class="field">
              <label for="folderSelect">Pasta</label>
              <select id="folderSelect">
                <option value="Imagens">Imagens</option>
                <option value="V√≠deos">V√≠deos</option>
                <option value="PDFs">PDFs</option>
                <option value="Outros">Outros</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn btnPrimary" id="btnUpload" style="flex:1;">Enviar arquivo</button>

            <div class="field" style="flex:1;">
              <label for="typeFilter">Filtrar por</label>
              <select id="typeFilter">
                <option value="Todos">Todos</option>
                <option value="Imagens">Imagens</option>
                <option value="V√≠deos">V√≠deos</option>
                <option value="PDFs">PDFs</option>
                <option value="Outros">Outros</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div class="field" style="flex:2 1 260px;">
              <label for="searchInput">Buscar por nome</label>
              <input id="searchInput" placeholder="Ex: contrato, foto, v√≠deo..." />
            </div>

            <div class="tabs">
              <button class="tab active" id="tabList">Lista</button>
              <button class="tab" id="tabGallery">Galeria</button>
            </div>
          </div>
        </div>
      </div>

      <!-- FILES -->
      <div class="card view hide span2" id="filesCard">
        <div class="cardHead">
          <b>Arquivos</b>
          <span style="font-size:12px;color:var(--muted)" id="countLabel">0 arquivo(s)</span>
        </div>
        <div class="cardBody">
          <div id="filesList" class="list"></div>
          <div id="emptyState" class="empty" style="display:none;">Nenhum arquivo ainda (ou filtros escondendo tudo).</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" style="
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background: rgba(2,8,18,.65); backdrop-filter: blur(8px); z-index:9998; padding:16px;
  ">
    <div style="
      width:min(920px, 100%);
      max-height:min(82vh, 100%);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
    ">
      <div style="
        display:flex; align-items:center; justify-content:space-between; gap:12px;
        padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.10);
        background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      ">
        <div style="min-width:0;">
          <div id="previewTitle" style="font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
          <div id="previewSub" style="font-size:12px; color:rgba(255,255,255,.70);"></div>
        </div>

        <div style="display:flex; gap:8px; flex:0 0 auto;">
          <a id="previewOpen" class="btn btnSmall" target="_blank" rel="noopener">Abrir</a>
          <button id="previewClose" class="btn btnSmall btnDanger">Fechar</button>
        </div>
      </div>

      <div id="previewBody" style="padding:12px; max-height:72vh; overflow:auto;"></div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /************************************************************
     * CONFIGS
     ************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyAYAwMfCDcXALBVM1uemmJA4aWQK5MNcc0",
      authDomain: "meu-drive-beb33.firebaseapp.com",
      projectId: "meu-drive-beb33",
      storageBucket: "meu-drive-beb33.firebasestorage.app",
      messagingSenderId: "661176300748",
      appId: "1:661176300748:web:68ab970ae9e668fdb67e69"
    };

    // Cloudinary (unsigned upload)
    const CLOUD_NAME = "dilyddwkg";
    const UPLOAD_PRESET = "kv9sjt0g";

    /************************************************************
     * INIT
     ************************************************************/
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /************************************************************
     * ELEMENTS
     ************************************************************/
    const loaderOverlay = document.getElementById("loaderOverlay");
    const authView = document.getElementById("authView");
    const accountCard = document.getElementById("accountCard");
    const uploadCard = document.getElementById("uploadCard");
    const filesCard = document.getElementById("filesCard");

    const userChip = document.getElementById("userChip");
    const avatar = document.getElementById("avatar");
    const userName = document.getElementById("userName");
    const userEmail = document.getElementById("userEmail");
    const loggedEmail = document.getElementById("loggedEmail");

    const pwaStatus = document.getElementById("pwaStatus");

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const btnLogin = document.getElementById("btnLogin");
    const btnRegister = document.getElementById("btnRegister");
    const btnLogout = document.getElementById("btnLogout");

    const fileInput = document.getElementById("fileInput");
    const folderSelect = document.getElementById("folderSelect");
    const btnUpload = document.getElementById("btnUpload");

    const tabList = document.getElementById("tabList");
    const tabGallery = document.getElementById("tabGallery");

    const typeFilter = document.getElementById("typeFilter");
    const searchInput = document.getElementById("searchInput");

    const filesList = document.getElementById("filesList");
    const emptyState = document.getElementById("emptyState");
    const countLabel = document.getElementById("countLabel");

    // Preview refs
    const previewModal = document.getElementById("previewModal");
    const previewTitle = document.getElementById("previewTitle");
    const previewSub = document.getElementById("previewSub");
    const previewBody = document.getElementById("previewBody");
    const previewOpen = document.getElementById("previewOpen");
    const previewClose = document.getElementById("previewClose");

    /************************************************************
     * HELPERS
     ************************************************************/
    function showLoader(on){
      loaderOverlay.style.display = on ? "flex" : "none";
    }

    function setViewLoggedIn(user){
      // anima suave
      authView.classList.add("hide");
      accountCard.classList.remove("hide");
      uploadCard.classList.remove("hide");
      filesCard.classList.remove("hide");

      userChip.style.display = "flex";

      const em = user.email || "‚Äî";
      loggedEmail.textContent = em;
      userEmail.textContent = em;

      // Nome/Avatar
      const display = user.displayName || (em.split("@")[0] || "Usu√°rio");
      userName.textContent = display;
      avatar.textContent = (display[0] || "M").toUpperCase();
    }

    function setViewLoggedOut(){
      authView.classList.remove("hide");
      accountCard.classList.add("hide");
      uploadCard.classList.add("hide");
      filesCard.classList.add("hide");

      userChip.style.display = "none";
      filesList.innerHTML = "";
      emptyState.style.display = "none";
      countLabel.textContent = "0 arquivo(s)";
    }

    function fmtBytes(bytes){
      if(!bytes && bytes !== 0) return "";
      const sizes = ["B","KB","MB","GB"];
      let i = 0, v = bytes;
      while(v >= 1024 && i < sizes.length-1){ v/=1024; i++; }
      return `${v.toFixed(i===0?0:1)} ${sizes[i]}`;
    }

    function guessFolderByMime(file){
      const t = (file.type || "").toLowerCase();
      if(t.startsWith("image/")) return "Imagens";
      if(t.startsWith("video/")) return "V√≠deos";
      if(t.includes("pdf")) return "PDFs";
      return "Outros";
    }

    function badgeFor(folder){
      if(folder === "Imagens") return "üñºÔ∏è";
      if(folder === "V√≠deos") return "üé¨";
      if(folder === "PDFs") return "üìÑ";
      return "üì¶";
    }

    function closePreview(){
      previewModal.style.display = "none";
      previewBody.innerHTML = "";
    }
    previewClose.addEventListener("click", closePreview);
    previewModal.addEventListener("click", (e) => { if(e.target === previewModal) closePreview(); });
    document.addEventListener("keydown", (e) => { if(e.key === "Escape") closePreview(); });

    function openPreview(file){
      // file: { name, url, folder, resourceType, type, bytes }
      previewTitle.textContent = file.name || "Arquivo";
      previewSub.textContent = `${file.folder || "‚Äî"} ‚Ä¢ ${fmtBytes(file.bytes) || ""}`.trim();
      previewOpen.href = file.url || "#";

      const url = file.url || "";
      const ext = (file.name || "").split(".").pop().toLowerCase();
      const mime = (file.type || "").toLowerCase();
      const resource = (file.resourceType || "").toLowerCase();

      previewBody.innerHTML = "";

      const wrap = document.createElement("div");
      wrap.style.display = "grid";
      wrap.style.placeItems = "center";
      wrap.style.padding = "6px";

      // Imagem
      if(resource === "image" || mime.startsWith("image/") || ["png","jpg","jpeg","webp","gif"].includes(ext)){
        const img = document.createElement("img");
        img.src = url;
        img.alt = file.name || "Preview";
        img.style.maxWidth = "100%";
        img.style.borderRadius = "16px";
        img.style.border = "1px solid rgba(255,255,255,.12)";
        img.style.boxShadow = "0 12px 40px rgba(0,0,0,.35)";
        wrap.appendChild(img);
        previewBody.appendChild(wrap);
      }
      // V√≠deo
      else if(resource === "video" || mime.startsWith("video/") || ["mp4","webm","mov","mkv"].includes(ext)){
        const video = document.createElement("video");
        video.src = url;
        video.controls = true;
        video.style.width = "100%";
        video.style.maxHeight = "62vh";
        video.style.borderRadius = "16px";
        video.style.border = "1px solid rgba(255,255,255,.12)";
        wrap.appendChild(video);
        previewBody.appendChild(wrap);
      }
      // PDF
      else if(mime.includes("pdf") || ext === "pdf"){
        const iframe = document.createElement("iframe");
        iframe.src = url;
        iframe.style.width = "100%";
        iframe.style.height = "62vh";
        iframe.style.border = "1px solid rgba(255,255,255,.12)";
        iframe.style.borderRadius = "16px";
        previewBody.appendChild(iframe);
      }
      // Outros
      else{
        const box = document.createElement("div");
        box.style.width = "100%";
        box.style.padding = "14px";
        box.style.borderRadius = "16px";
        box.style.border = "1px solid rgba(255,255,255,.12)";
        box.style.background = "rgba(255,255,255,.05)";
        box.innerHTML = `
          <div style="font-weight:900; margin-bottom:6px;">Esse tipo de arquivo n√£o tem preview aqui.</div>
          <div style="color:rgba(255,255,255,.7); font-size:13px;">
            Voc√™ pode abrir/baixar clicando em <b>Abrir</b>.
          </div>
        `;
        previewBody.appendChild(box);
      }

      previewModal.style.display = "flex";
    }

    /************************************************************
     * RENDER + LOAD FILES
     ************************************************************/
    let currentUser = null;
    let allFiles = [];
    let viewMode = "list"; // list | gallery

    function applyFilters(){
      const q = (searchInput.value || "").trim().toLowerCase();
      const f = typeFilter.value;

      let items = allFiles.slice();

      if(f && f !== "Todos"){
        items = items.filter(x => (x.folder || "Outros") === f);
      }
      if(q){
        items = items.filter(x => (x.name || "").toLowerCase().includes(q));
      }

      countLabel.textContent = `${items.length} arquivo(s)`;
      filesList.innerHTML = "";
      emptyState.style.display = items.length ? "none" : "block";

      if(viewMode === "gallery"){
        // Gallery simples (grid)
        filesList.style.display = "grid";
        filesList.style.gridTemplateColumns = "repeat(auto-fit, minmax(170px, 1fr))";
        filesList.style.gap = "12px";
      }else{
        filesList.style.display = "flex";
        filesList.style.flexDirection = "column";
      }

      items.forEach(file => {
        if(viewMode === "gallery"){
          const card = document.createElement("div");
          card.style.background = "rgba(255,255,255,.06)";
          card.style.border = "1px solid rgba(255,255,255,.10)";
          card.style.borderRadius = "18px";
          card.style.overflow = "hidden";
          card.style.cursor = "pointer";

          const top = document.createElement("div");
          top.style.height = "120px";
          top.style.display = "grid";
          top.style.placeItems = "center";
          top.style.background = "rgba(10,18,32,.50)";

          if((file.resourceType === "image") && file.url){
            const img = document.createElement("img");
            img.src = file.url;
            img.alt = file.name || "imagem";
            img.style.width = "100%";
            img.style.height = "120px";
            img.style.objectFit = "cover";
            top.innerHTML = "";
            top.appendChild(img);
          }else{
            top.innerHTML = `<div style="font-size:34px">${badgeFor(file.folder || "Outros")}</div>`;
          }

          const bottom = document.createElement("div");
          bottom.style.padding = "10px";
          bottom.innerHTML = `
            <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              ${file.name || "Arquivo"}
            </div>
            <div style="font-size:12px; color:rgba(255,255,255,.60); margin-top:4px;">
              ${file.folder || "Outros"} ‚Ä¢ ${fmtBytes(file.bytes) || ""}
            </div>
          `;

          card.appendChild(top);
          card.appendChild(bottom);

          card.addEventListener("click", () => openPreview(file));
          filesList.appendChild(card);
          return;
        }

        // LIST MODE
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        left.className = "left";

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = badgeFor(file.folder || "Outros");

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <div class="name">${file.name || "Arquivo"}</div>
          <div class="sub">${file.folder || "Outros"} ‚Ä¢ ${fmtBytes(file.bytes) || ""}</div>
        `;

        left.appendChild(badge);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "right";

        const btnPrev = document.createElement("button");
        btnPrev.className = "btn btnSmall";
        btnPrev.textContent = "Preview";
        btnPrev.addEventListener("click", () => openPreview(file));

        const btnOpen = document.createElement("a");
        btnOpen.className = "btn btnSmall";
        btnOpen.textContent = "Abrir";
        btnOpen.href = file.url || "#";
        btnOpen.target = "_blank";
        btnOpen.rel = "noopener";

        const btnDel = document.createElement("button");
        btnDel.className = "btn btnSmall btnDanger";
        btnDel.textContent = "Remover";
        btnDel.addEventListener("click", () => removeFile(file));

        right.appendChild(btnPrev);
        right.appendChild(btnOpen);
        right.appendChild(btnDel);

        row.appendChild(left);
        row.appendChild(right);
        filesList.appendChild(row);
      });
    }

    async function loadFiles(){
      if(!currentUser) return;
      showLoader(true);

      try{
        const snap = await db.collection("files")
          .where("uid", "==", currentUser.uid)
          .orderBy("createdAt", "desc")
          .get();

        allFiles = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        applyFilters();
      }catch(err){
        console.error(err);
        alert("Erro ao carregar arquivos.");
      }finally{
        showLoader(false);
      }
    }

    /************************************************************
     * AUTH
     ************************************************************/
    btnLogin.addEventListener("click", async () => {
      const email = (emailEl.value || "").trim();
      const pass = passEl.value || "";
      if(!email || !pass) return alert("Preencha email e senha.");
      showLoader(true);
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        alert("Erro: " + (e.message || e.code));
      }finally{
        showLoader(false);
      }
    });

    btnRegister.addEventListener("click", async () => {
      const email = (emailEl.value || "").trim();
      const pass = passEl.value || "";
      if(!email || !pass) return alert("Preencha email e senha.");
      showLoader(true);
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
      }catch(e){
        alert("Erro: " + (e.message || e.code));
      }finally{
        showLoader(false);
      }
    });

    btnLogout.addEventListener("click", async () => {
      showLoader(true);
      try{
        await auth.signOut();
      }catch(e){
        alert("Erro: " + (e.message || e.code));
      }finally{
        showLoader(false);
      }
    });

    auth.onAuthStateChanged(async (user) => {
      showLoader(true);
      try{
        if(user){
          currentUser = user;
          setViewLoggedIn(user);
          await loadFiles();
        }else{
          currentUser = null;
          setViewLoggedOut();
        }
      }finally{
        showLoader(false);
      }
    });

    /************************************************************
     * UPLOAD
     ************************************************************/
    fileInput.addEventListener("change", () => {
      const f = fileInput.files && fileInput.files[0];
      if(!f) return;
      folderSelect.value = guessFolderByMime(f);
    });

    async function uploadToCloudinary(file, folderName){
      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;

      const form = new FormData();
      form.append("file", file);
      form.append("upload_preset", UPLOAD_PRESET);

      // organiza no Cloudinary (n√£o √© obrigat√≥rio)
      const safeFolder = (folderName || "Outros").replace(/[^\w√Ä-√ø -]/g, "").trim();
      form.append("folder", `meu-drive/${currentUser.uid}/${safeFolder}`);

      const res = await fetch(url, { method:"POST", body: form });
      const data = await res.json();
      if(!res.ok){
        const msg = data?.error?.message || "Erro no upload";
        throw new Error(msg);
      }
      return data;
    }

    btnUpload.addEventListener("click", async () => {
      if(!currentUser) return alert("Voc√™ precisa estar logado.");
      const file = fileInput.files && fileInput.files[0];
      if(!file) return alert("Escolha um arquivo primeiro.");

      showLoader(true);

      try{
        const folder = folderSelect.value || guessFolderByMime(file);
        const result = await uploadToCloudinary(file, folder);

        const doc = {
          uid: currentUser.uid,
          name: file.name,
          bytes: file.size || null,
          type: file.type || "",
          folder,
          url: result.secure_url,
          publicId: result.public_id,
          resourceType: result.resource_type, // image | video | raw
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection("files").add(doc);

        fileInput.value = "";
        await loadFiles();
      }catch(e){
        console.error(e);
        alert("Erro no upload: " + (e.message || "tente novamente"));
      }finally{
        showLoader(false);
      }
    });

    async function removeFile(file){
      if(!currentUser) return;
      const ok = confirm(`Remover "${file.name}" da lista?`);
      if(!ok) return;

      showLoader(true);
      try{
        await db.collection("files").doc(file.id).delete();
        // Observa√ß√£o: deletar do Cloudinary exige backend (n√£o d√° seguro no client).
        await loadFiles();
      }catch(e){
        console.error(e);
        alert("Erro ao remover: " + (e.message || e.code));
      }finally{
        showLoader(false);
      }
    }

    /************************************************************
     * UI (tabs + filtros)
     ************************************************************/
    tabList.addEventListener("click", () => {
      viewMode = "list";
      tabList.classList.add("active");
      tabGallery.classList.remove("active");
      applyFilters();
    });

    tabGallery.addEventListener("click", () => {
      viewMode = "gallery";
      tabGallery.classList.add("active");
      tabList.classList.remove("active");
      applyFilters();
    });

    typeFilter.addEventListener("change", applyFilters);
    searchInput.addEventListener("input", applyFilters);

    /************************************************************
     * PWA status + SW
     ************************************************************/
    function updatePwaStatus(){
      const isStandalone =
        window.matchMedia("(display-mode: standalone)").matches ||
        window.navigator.standalone === true;
      pwaStatus.textContent = isStandalone ? "PWA: instalado ‚úÖ" : "PWA: pode instalar üì≤";
    }
    updatePwaStatus();
    window.matchMedia("(display-mode: standalone)").addEventListener("change", updatePwaStatus);

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(console.error);
      });
    }
  </script>
</body>
</html>
