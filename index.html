<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b57d0" />
  <title>Meu Drive</title>

  <link rel="manifest" href="./manifest.json" />

  <style>
    :root{
      --bg1:#061024;
      --bg2:#0b57d0;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.10);
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --primary:#4b86ff;
      --primary2:#2b6bff;
      --danger:#ff4b4b;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 30% 10%, rgba(46, 130, 255, .35), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(51, 255, 166, .18), transparent 55%),
        linear-gradient(180deg, var(--bg1), #071a3a 60%, #05204a);
      padding: 22px 14px 30px;
    }

    .container{
      max-width: 980px;
      margin: 0 auto;
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .appIcon{
      width:44px; height:44px;
      border-radius: 14px;
      background: linear-gradient(135deg, #2d6bff, #2ac7ff 55%, #49ff8b);
      display:grid;
      place-items:center;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
    }
    .appIcon img{ width:100%; height:100%; object-fit:cover; }
    .brand h1{
      font-size: 26px;
      margin:0;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:baseline;
    }
    .brand small{
      font-size: 14px;
      color: var(--muted);
      font-weight: 500;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 13px;
      user-select:none;
      backdrop-filter: blur(10px);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .cardHeader{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .cardHeader h2{
      margin:0;
      font-size: 15px;
      letter-spacing:.2px;
      color: rgba(255,255,255,.90);
      font-weight: 700;
    }
    .cardBody{ padding: 14px 16px 16px; }

    .row{ display:flex; gap:10px; align-items:center; }
    .rowWrap{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    input, select, button{
      font: inherit;
    }

    .input{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
    }
    .input::placeholder{ color: rgba(255,255,255,.55); }
    .input:focus{ border-color: rgba(75,134,255,.55); }

    .btn{
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      color: var(--text);
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      min-width: 140px;
    }
    .btn:hover{ background: rgba(255,255,255,.14); }
    .btn:active{ transform: scale(.98); }

    .btnPrimary{
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      border-color: rgba(255,255,255,.12);
    }
    .btnPrimary:hover{ filter: brightness(1.05); }
    .btnDanger{
      background: rgba(255,75,75,.14);
      border-color: rgba(255,75,75,.28);
      color: rgba(255,255,255,.92);
    }
    .btnSmall{ min-width: auto; padding: 10px 12px; border-radius: 12px; }

    .seg{
      display:flex;
      gap:10px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 6px;
      width: fit-content;
    }
    .seg button{
      padding: 10px 14px;
      border: none;
      border-radius: 999px;
      cursor:pointer;
      background: transparent;
      color: var(--muted);
      transition: background .2s ease, color .2s ease;
      font-weight: 700;
      letter-spacing:.2px;
    }
    .seg button.active{
      background: rgba(255,255,255,.12);
      color: var(--text);
    }

    /* Views + anima√ß√£o */
    .viewWrap{
      position: relative;
      min-height: 320px;
    }
    .view{
      opacity: 1;
      transform: translateY(0);
      transition: opacity .22s ease, transform .22s ease;
    }
    .view.hidden{
      opacity: 0;
      transform: translateY(10px);
      pointer-events:none;
      position:absolute;
      inset:0;
    }

    /* Loader overlay */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(2,8,18,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9999;
    }
    .overlay.show{ display:flex; }
    .spinner{
      width: 54px;
      height: 54px;
      border-radius: 999px;
      border: 4px solid rgba(255,255,255,.18);
      border-top-color: rgba(75,134,255,.95);
      animation: spin .8s linear infinite;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Header do usu√°rio */
    .userHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .userInfo{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 0;
    }
    .avatar{
      width: 42px; height:42px;
      border-radius: 999px;
      background: linear-gradient(135deg, #2d6bff, #49ff8b);
      display:grid;
      place-items:center;
      font-weight: 900;
      color: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.20);
      flex: 0 0 auto;
      overflow:hidden;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; }
    .userText{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .userText b{
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .userText span{
      font-size: 12px;
      color: var(--muted);
    }

    /* Lista de arquivos */
    .fileList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 12px;
    }
    .fileItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
    }
    .fileLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .fileBadge{
      width: 38px; height: 38px;
      border-radius: 14px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.12);
      display:grid;
      place-items:center;
      font-weight: 900;
      color: rgba(255,255,255,.80);
      flex:0 0 auto;
    }
    .fileMeta{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .fileMeta b{
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .fileMeta span{
      font-size: 12px;
      color: var(--muted);
    }
    .fileActions{
      display:flex;
      gap:8px;
      flex:0 0 auto;
    }

    .empty{
      padding: 14px;
      text-align:center;
      color: var(--muted);
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      margin-top: 12px;
      background: rgba(0,0,0,.12);
    }

    /* Galeria */
    .gallery{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 520px){
      .gallery{ grid-template-columns: repeat(2, 1fr); }
    }
    .thumb{
      position: relative;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      aspect-ratio: 1 / 1;
      cursor:pointer;
    }
    .thumb img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }
    .thumb .tag{
      position:absolute;
      left:10px;
      bottom:10px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.16);
      color: rgba(255,255,255,.90);
      font-size: 11px;
      padding: 6px 9px;
      border-radius: 999px;
      backdrop-filter: blur(8px);
    }
  </style>
</head>

<body>
  <div class="overlay" id="overlay">
    <div class="spinner" aria-label="Carregando"></div>
  </div>

  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="appIcon">
          <!-- se quiser, troca pelo seu icon-192.png -->
          <img src="./icon-192.png" alt="√çcone" />
        </div>
        <div>
          <h1>Meu Drive <small>Seus arquivos em um s√≥ lugar</small></h1>
          <div class="pill" id="pwaStatus">PWA: verificando‚Ä¶</div>
        </div>
      </div>

      <div class="pill" id="netStatus">Online</div>
    </div>

    <div class="grid">
      <!-- ESQUERDA: Auth + App -->
      <div class="card">
        <div class="cardHeader">
          <h2>Conta</h2>
          <div class="pill" id="sessionLabel">Sess√£o: ‚Äî</div>
        </div>

        <div class="cardBody viewWrap">
          <!-- LOGIN VIEW -->
          <div class="view" id="loginView">
            <div style="display:flex; flex-direction:column; gap:10px;">
              <input class="input" id="email" type="email" placeholder="Email" autocomplete="email" />
              <input class="input" id="password" type="password" placeholder="Senha" autocomplete="current-password" />
              <div class="row">
                <button class="btn btnPrimary" id="btnLogin">Entrar</button>
                <button class="btn" id="btnRegister">Criar conta</button>
              </div>
              <div class="pill" style="width:fit-content;">Dica: instale o app pelo menu do Chrome ‚Üí ‚ÄúInstalaria/Instalar app‚Äù.</div>
            </div>
          </div>

          <!-- APP VIEW -->
          <div class="view hidden" id="appView">
            <div class="userHeader">
              <div class="userInfo">
                <div class="avatar" id="avatar">
                  <span id="avatarText">U</span>
                </div>
                <div class="userText">
                  <b id="userEmail">‚Äî</b>
                  <span id="userUid">‚Äî</span>
                </div>
              </div>
              <button class="btn btnDanger btnSmall" id="btnLogout">Sair</button>
            </div>

            <div style="height:12px"></div>

            <div class="card" style="background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10); box-shadow:none;">
              <div class="cardHeader">
                <h2>Upload</h2>
                <div class="pill" id="uploadHint">Cloudinary + Firestore</div>
              </div>
              <div class="cardBody">
                <div class="rowWrap">
                  <input class="input" style="flex:1" id="fileInput" type="file" />
                  <select class="input" style="min-width:180px" id="folderSelect"></select>
                </div>

                <div style="height:10px"></div>

                <div class="rowWrap">
                  <button class="btn btnPrimary" id="btnUpload">Enviar arquivo</button>

                  <input class="input" style="flex:1; min-width: 220px" id="newFolder" placeholder="Criar nova pasta (ex: Docs)" />
                  <button class="btn" id="btnAddFolder">Adicionar pasta</button>
                </div>

                <div style="height:10px"></div>
                <div class="pill" id="uploadStatus">Aguardando‚Ä¶</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="seg">
              <button id="tabList" class="active">Lista</button>
              <button id="tabGallery">Galeria</button>
            </div>

            <div id="listWrap" class="fileList"></div>
            <div id="galleryWrap" class="gallery" style="display:none;"></div>

            <div id="emptyState" class="empty" style="display:none;">Nenhum arquivo ainda.</div>
          </div>
        </div>
      </div>

      <!-- DIREITA: Painel -->
      <div class="card">
        <div class="cardHeader">
          <h2>Painel</h2>
          <div class="pill" id="filesCount">0 arquivo(s)</div>
        </div>
        <div class="cardBody">
          <div class="rowWrap">
            <input class="input" id="searchInput" placeholder="Buscar por nome‚Ä¶" style="flex:1" />
            <select class="input" id="typeFilter" style="min-width:180px">
              <option value="all">Todos</option>
              <option value="image">Imagens</option>
              <option value="video">V√≠deos</option>
              <option value="raw">PDFs/Docs</option>
              <option value="other">Outros</option>
            </select>
          </div>

          <div style="height:12px"></div>
          <div class="pill">Dica: cada usu√°rio v√™ s√≥ os pr√≥prios arquivos (por UID no Firestore).</div>

          <div style="height:12px"></div>
          <div class="card" style="background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10); box-shadow:none;">
            <div class="cardHeader"><h2>Observa√ß√µes</h2></div>
            <div class="cardBody" style="color: var(--muted); line-height:1.5;">
              <div>‚Ä¢ Se aparecer ‚ÄúMissing or insufficient permissions‚Äù, √© regra do Firestore (precisa permitir ler/escrever com login).</div>
              <div>‚Ä¢ Deletar do Cloudinary com seguran√ßa exige backend (n√£o d√° pra colocar segredo no front-end).</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /************************************************************
     * 1) COLE SUAS CONFIGS AQUI (n√£o vou colar keys por seguran√ßa)
     ************************************************************/
  const firebaseConfig = {
  apiKey: "AIzaSyAYAwMfCDcXALBVM1uemmJA4aWQK5MNcc0",
  authDomain: "meu-drive-beb33.firebaseapp.com",
  projectId: "meu-drive-beb33",
  storageBucket: "meu-drive-beb33.firebasestorage.app",
  messagingSenderId: "661176300748",
  appId: "1:661176300748:web:68ab970ae9e668fdb67e69"
};

    // Cloudinary (unsigned upload)
    const CLOUD_NAME = "dilyddwkg";
    const UPLOAD_PRESET = "kv9sjt0g";

    /************************************************************/
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // UI refs
    const overlay = document.getElementById("overlay");
    const pwaStatus = document.getElementById("pwaStatus");
    const netStatus = document.getElementById("netStatus");
    const sessionLabel = document.getElementById("sessionLabel");

    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const btnLogin = document.getElementById("btnLogin");
    const btnRegister = document.getElementById("btnRegister");
    const btnLogout = document.getElementById("btnLogout");

    const userEmail = document.getElementById("userEmail");
    const userUid = document.getElementById("userUid");
    const avatar = document.getElementById("avatar");
    const avatarText = document.getElementById("avatarText");

    const fileInput = document.getElementById("fileInput");
    const btnUpload = document.getElementById("btnUpload");
    const uploadStatus = document.getElementById("uploadStatus");

    const folderSelect = document.getElementById("folderSelect");
    const newFolder = document.getElementById("newFolder");
    const btnAddFolder = document.getElementById("btnAddFolder");

    const tabList = document.getElementById("tabList");
    const tabGallery = document.getElementById("tabGallery");
    const listWrap = document.getElementById("listWrap");
    const galleryWrap = document.getElementById("galleryWrap");
    const emptyState = document.getElementById("emptyState");

    const filesCount = document.getElementById("filesCount");
    const searchInput = document.getElementById("searchInput");
    const typeFilter = document.getElementById("typeFilter");

    let currentUser = null;
    let allFiles = [];
    let unsubscribe = null;

    // Helpers
    function showOverlay(show){
      overlay.classList.toggle("show", !!show);
    }
    function toast(text){
      alert(text);
    }

    function showLogin(){
      appView.classList.add("hidden");
      loginView.classList.remove("hidden");
    }
    function showApp(){
      loginView.classList.add("hidden");
      appView.classList.remove("hidden");
    }

    // PWA install detection
    function updatePwaLabel(){
      // Chrome mobile geralmente exp√µe display-mode
      const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
      pwaStatus.textContent = isStandalone ? "PWA: instalado ‚úÖ" : "PWA: pode instalar üì≤";
    }
    updatePwaLabel();
    window.addEventListener("appinstalled", updatePwaLabel);

    // Online status
    function updateOnline(){
      const ok = navigator.onLine;
      netStatus.textContent = ok ? "Online" : "Offline";
      netStatus.style.opacity = ok ? "1" : ".7";
    }
    updateOnline();
    window.addEventListener("online", updateOnline);
    window.addEventListener("offline", updateOnline);

    // Pastas (localStorage por usu√°rio)
    function foldersKey(uid){ return `simpledrive_folders_${uid}`; }
    function getFolders(uid){
      const base = ["Imagens", "V√≠deos", "PDFs", "Outros"];
      try{
        const raw = localStorage.getItem(foldersKey(uid));
        const arr = raw ? JSON.parse(raw) : [];
        const merged = [...new Set([...base, ...arr])];
        return merged;
      }catch{
        return base;
      }
    }
    function saveFolders(uid, folders){
      localStorage.setItem(foldersKey(uid), JSON.stringify(folders));
    }
    function renderFolders(){
      if(!currentUser) return;
      const folders = getFolders(currentUser.uid);
      folderSelect.innerHTML = "";
      folders.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f;
        opt.textContent = f;
        folderSelect.appendChild(opt);
      });
    }

    btnAddFolder.addEventListener("click", () => {
      if(!currentUser) return;
      const name = (newFolder.value || "").trim();
      if(!name) return;
      const folders = getFolders(currentUser.uid);
      if(!folders.includes(name)) folders.push(name);
      saveFolders(currentUser.uid, folders);
      newFolder.value = "";
      renderFolders();
    });

    // Tabs
    function setTab(which){
      const listOn = which === "list";
      tabList.classList.toggle("active", listOn);
      tabGallery.classList.toggle("active", !listOn);

      listWrap.style.display = listOn ? "" : "none";
      galleryWrap.style.display = listOn ? "none" : "";
    }
    tabList.addEventListener("click", () => setTab("list"));
    tabGallery.addEventListener("click", () => setTab("gallery"));

    // Auth
    btnLogin.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const pass = passEl.value;
      if(!email || !pass) return toast("Preencha email e senha.");
      showOverlay(true);
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        toast("Firebase: " + (e?.message || "Erro ao entrar"));
      }finally{
        showOverlay(false);
      }
    });

    btnRegister.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const pass = passEl.value;
      if(!email || !pass) return toast("Preencha email e senha.");
      showOverlay(true);
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
      }catch(e){
        toast("Firebase: " + (e?.message || "Erro ao criar conta"));
      }finally{
        showOverlay(false);
      }
    });

    btnLogout.addEventListener("click", async () => {
      showOverlay(true);
      try{
        if(unsubscribe) unsubscribe();
        unsubscribe = null;
        await auth.signOut();
      }catch(e){
        toast("Firebase: " + (e?.message || "Erro ao sair"));
      }finally{
        showOverlay(false);
      }
    });

    // Watch session (loader s√≥ aqui, n√£o fica preso)
    showOverlay(true);
    auth.onAuthStateChanged(async (user) => {
      currentUser = user || null;

      if(!currentUser){
        sessionLabel.textContent = "Sess√£o: deslogado";
        showLogin();
        // limpa dados
        allFiles = [];
        renderFiles();
        showOverlay(false);
        return;
      }

      sessionLabel.textContent = "Sess√£o: ativa ‚úÖ";
      userEmail.textContent = currentUser.email || "‚Äî";
      userUid.textContent = "UID: " + currentUser.uid.slice(0, 10) + "‚Ä¶";

      // avatar simples (iniciais)
      const letter = (currentUser.email || "U").trim()[0].toUpperCase();
      avatarText.textContent = letter;

      renderFolders();
      showApp();

      // come√ßa a ouvir arquivos do usu√°rio
      if(unsubscribe) unsubscribe();
      unsubscribe = db.collection("files")
        .where("uid", "==", currentUser.uid)
        .orderBy("createdAt", "desc")
        .onSnapshot((snap) => {
          allFiles = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          renderFiles();
        }, (err) => {
          console.error(err);
          toast("Firestore: " + (err?.message || "Erro de permiss√£o (rules)"));
        });

      showOverlay(false);
    });

    // Upload Cloudinary (corrigido)
    async function uploadToCloudinary(file, folderName){
      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;

      const form = new FormData();
      form.append("file", file);
      form.append("upload_preset", UPLOAD_PRESET);
      form.append("folder", `meu-drive/${folderName}`);

      const res = await fetch(url, { method:"POST", body: form });
      const data = await res.json();

      if(!res.ok){
        const msg = data?.error?.message || "Falha no upload (Cloudinary)";
        throw new Error(msg);
      }
      return data;
    }

    function guessType(resourceType, file){
      // Cloudinary retorna resource_type: image/video/raw
      if(resourceType === "image") return "image";
      if(resourceType === "video") return "video";
      if(resourceType === "raw") return "raw";
      // fallback
      const mime = (file?.type || "").toLowerCase();
      if(mime.startsWith("image/")) return "image";
      if(mime.startsWith("video/")) return "video";
      if(mime.includes("pdf")) return "raw";
      return "other";
    }

    btnUpload.addEventListener("click", async () => {
      if(!currentUser) return toast("Fa√ßa login primeiro.");
      const file = fileInput.files?.[0];
      if(!file) return toast("Escolha um arquivo.");
      const folderName = folderSelect.value || "Outros";

      showOverlay(true);
      uploadStatus.textContent = "Enviando‚Ä¶";

      try{
        const up = await uploadToCloudinary(file, folderName);

        // salva no Firestore (cole√ß√£o root: files)
        const doc = {
          uid: currentUser.uid,
          email: currentUser.email || "",
          name: up.original_filename || file.name,
          url: up.secure_url,
          publicId: up.public_id,
          resourceType: up.resource_type, // image/video/raw
          folder: folderName,
          bytes: up.bytes || file.size || 0,
          format: up.format || "",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection("files").add(doc);

        uploadStatus.textContent = "Upload conclu√≠do ‚úÖ";
        fileInput.value = "";
      }catch(e){
        console.error(e);
        uploadStatus.textContent = "Erro no upload ‚ùå";
        toast("Erro no upload: " + (e?.message || "desconhecido"));
      }finally{
        showOverlay(false);
      }
    });

    // Render list + gallery
    function iconFor(type){
      if(type==="image") return "üñºÔ∏è";
      if(type==="video") return "üé¨";
      if(type==="raw") return "üìÑ";
      return "üì¶";
    }

    function applyFilters(files){
      const q = (searchInput.value || "").trim().toLowerCase();
      const tf = typeFilter.value;

      return files.filter(f => {
        const type = (f.resourceType || "").toLowerCase();
        const guessed = type || "other";

        const matchesType =
          tf === "all" ||
          (tf === "other" ? !["image","video","raw"].includes(guessed) : guessed === tf);

        const text = `${f.name||""} ${f.folder||""}`.toLowerCase();
        const matchesQuery = !q || text.includes(q);

        return matchesType && matchesQuery;
      });
    }

    function renderFiles(){
      const filtered = applyFilters(allFiles);
      filesCount.textContent = `${filtered.length} arquivo(s)`;

      // empty
      const isEmpty = filtered.length === 0;
      emptyState.style.display = isEmpty ? "" : "none";

      // LIST
      listWrap.innerHTML = "";
      filtered.forEach(f => {
        const type = guessType(f.resourceType);
        const item = document.createElement("div");
        item.className = "fileItem";

        const left = document.createElement("div");
        left.className = "fileLeft";

        const badge = document.createElement("div");
        badge.className = "fileBadge";
        badge.textContent = iconFor(type);

        const meta = document.createElement("div");
        meta.className = "fileMeta";

        const title = document.createElement("b");
        title.textContent = f.name || "Arquivo";

        const sub = document.createElement("span");
        const folder = f.folder ? `‚Ä¢ ${f.folder}` : "";
        sub.textContent = `${(f.resourceType || "other").toUpperCase()} ${folder}`;

        meta.appendChild(title);
        meta.appendChild(sub);

        left.appendChild(badge);
        left.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "fileActions";

        const openBtn = document.createElement("button");
        openBtn.className = "btn btnSmall";
        openBtn.textContent = "Abrir";
        openBtn.onclick = () => window.open(f.url, "_blank");

        const delBtn = document.createElement("button");
        delBtn.className = "btn btnSmall btnDanger";
        delBtn.textContent = "Remover";
        delBtn.onclick = async () => {
          if(!confirm("Remover da lista? (Cloudinary ainda n√£o √© apagado por seguran√ßa)")) return;
          try{
            await db.collection("files").doc(f.id).delete();
          }catch(e){
            toast("Erro ao remover: " + (e?.message || "desconhecido"));
          }
        };

        actions.appendChild(openBtn);
        actions.appendChild(delBtn);

        item.appendChild(left);
        item.appendChild(actions);
        listWrap.appendChild(item);
      });

      // GALLERY
      galleryWrap.innerHTML = "";
      filtered
        .filter(f => (f.resourceType || "").toLowerCase() === "image")
        .forEach(f => {
          const t = document.createElement("div");
          t.className = "thumb";
          const img = document.createElement("img");
          img.src = f.url;
          img.alt = f.name || "imagem";
          const tag = document.createElement("div");
          tag.className = "tag";
          tag.textContent = f.folder || "Imagens";
          t.appendChild(img);
          t.appendChild(tag);
          t.onclick = () => window.open(f.url, "_blank");
          galleryWrap.appendChild(t);
        });
    }

    searchInput.addEventListener("input", renderFiles);
    typeFilter.addEventListener("change", renderFiles);

    // Service worker
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("./service-worker.js").catch(console.error);
    }
  </script>
</body>
</html>
