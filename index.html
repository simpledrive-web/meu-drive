<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Meu Drive</title>

  <style>
    :root{
      --bg1:#071022;
      --bg2:#0b2a66;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --brand:#4f7cf0;
      --brand2:#2dd4bf;
      --danger:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 30% 20%, rgba(79,124,240,.35), transparent 60%),
        radial-gradient(900px 600px at 80% 60%, rgba(45,212,191,.22), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* fix ‚Äúlist√£o branco‚Äù */
    html { color-scheme: dark; }
    select, option { color-scheme: dark; }

    .wrap{
      width:min(1080px, 92vw);
      margin: 22px auto 40px;
    }

    /* TOP */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
    }
    .appIcon{
      width:48px; height:48px; border-radius:14px;
      overflow:hidden;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
    }
    .appIcon img{ width:100%; height:100%; object-fit:cover; display:block; }
    .titleWrap{ min-width:0; }
    h1{
      font-size:28px; margin:0; letter-spacing:.2px;
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .subtitle{
      margin:4px 0 0;
      color:var(--muted);
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 460px;
    }

    .userChip{
      display:none; /* aparece quando logar */
      align-items:center;
      gap:10px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:8px 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      max-width: 520px;
      flex: 1 1 360px;
      justify-content:space-between;
    }
    .userLeft{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .avatar{
      width:36px; height:36px; border-radius:999px;
      background: linear-gradient(135deg, rgba(79,124,240,.9), rgba(45,212,191,.9));
      display:grid; place-items:center;
      font-weight:900;
      flex:0 0 auto;
    }
    .userMeta{ min-width:0; }
    .hello{
      font-size:13px; font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .userEmailSmall{
      font-size:12px; color:var(--muted2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      display:none; /* n√£o mostrar email no topo (se quiser, muda pra block) */
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 0.95fr 1.05fr; }
    }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead b{ font-size:14px; }
    .cardBody{ padding:14px 16px; }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-end;
    }

    .field{
      flex:1 1 220px;
      min-width: 180px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,18,32,.55);
      color: var(--txt);
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color: rgba(255,255,255,.45); }

    select{
      appearance:none;
      -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.75) 50%),
        linear-gradient(135deg, rgba(255,255,255,.75) 50%, transparent 50%),
        linear-gradient(to right, rgba(255,255,255,.10), rgba(255,255,255,.10));
      background-position:
        calc(100% - 18px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px),
        calc(100% - 38px) 50%;
      background-size: 6px 6px, 6px 6px, 1px 18px;
      background-repeat:no-repeat;
      padding-right: 44px;
    }
    option{
      background-color: #0b1220;
      color: #fff;
    }

    .btn{
      border:0;
      border-radius:16px;
      padding:12px 16px;
      font-weight:900;
      cursor:pointer;
      background: rgba(255,255,255,.10);
      color: var(--txt);
      border:1px solid rgba(255,255,255,.14);
      transition: transform .06s ease, filter .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(79,124,240,.95), rgba(79,124,240,.65));
      border-color: rgba(79,124,240,.55);
    }
    .btnDanger{
      background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(239,68,68,.55));
      border-color: rgba(239,68,68,.55);
    }
    .btnGhost{
      background: rgba(255,255,255,.06);
    }
    .btnSmall{
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      font-weight:900;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    .tabs{
      display:flex;
      gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px;
      border-radius:999px;
      width: fit-content;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      border:1px solid transparent;
      color: rgba(255,255,255,.75);
      background: transparent;
    }
    .tab.active{
      background: rgba(79,124,240,.35);
      border-color: rgba(79,124,240,.45);
      color: var(--txt);
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }

    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .left{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }

    .thumb{
      width:44px; height:44px;
      border-radius:14px;
      overflow:hidden;
      background: rgba(79,124,240,.18);
      border:1px solid rgba(79,124,240,.22);
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumb span{ opacity:.9; }

    .meta{ min-width:0; }
    .name{
      font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 52vw;
    }
    .sub{
      font-size:12px;
      color: var(--muted2);
      margin-top:2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 52vw;
    }
    .right{ display:flex; gap:8px; flex:0 0 auto; flex-wrap:wrap; justify-content:flex-end; }

    .empty{
      margin-top:12px;
      color: var(--muted2);
      text-align:center;
      padding:18px 10px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
    }

    .view{ transition: opacity .25s ease, transform .25s ease; }
    .hide{
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      height:0;
      overflow:hidden;
    }

    .loaderOverlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(2,8,18,.60);
      backdrop-filter: blur(8px);
      z-index:9999;
    }
    .spinner{
      width:56px; height:56px;
      border-radius:50%;
      border: 5px solid rgba(255,255,255,.18);
      border-top-color: rgba(79,124,240,.95);
      animation: spin .9s linear infinite;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* modal preview */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(2,8,18,.72);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10000;
      padding: 18px;
    }
    .modal{
      width: min(920px, 96vw);
      max-height: 86vh;
      overflow:hidden;
      border-radius: 22px;
      background: rgba(15,24,40,.86);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding: 12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalTitle{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70%;
    }
    .modalBody{
      padding: 14px;
      overflow:auto;
    }
    .modalBody img, .modalBody video, .modalBody iframe{
      width:100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
    }
    .modalBody video{ max-height: 70vh; }
    .pill{
      font-size:12px;
      color: var(--muted);
      padding: 6px 10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      background: rgba(255,255,255,.06);
    }
    .muted{ color: var(--muted2); font-size: 12px; }

    /* auth view */
    .authGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 980px){
      .authGrid{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="loaderOverlay" id="loader">
    <div class="spinner"></div>
  </div>

  <div class="modalOverlay" id="previewOverlay" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <div style="min-width:0">
          <div class="modalTitle" id="previewTitle">Preview</div>
          <div class="muted" id="previewMeta"></div>
        </div>
        <div class="right">
          <a class="btn btnSmall btnGhost" id="previewOpenTab" target="_blank" rel="noopener">Abrir em nova guia</a>
          <button class="btn btnSmall btnDanger" id="previewClose">Fechar</button>
        </div>
      </div>
      <div class="modalBody" id="previewBody"></div>
    </div>
  </div>

  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="appIcon">
          <!-- Logo: pode trocar por sua imagem -->
          <img id="logoImg" alt="Logo" src="https://raw.githubusercontent.com/simpledrive-web/meu-drive/main/logo.png"
               onerror="this.style.display='none'; this.parentElement.textContent='MD'; this.parentElement.style.fontWeight='900';">
        </div>
        <div class="titleWrap">
          <h1>Meu Drive ‚òÅÔ∏è</h1>
          <div class="subtitle">Seus arquivos em um s√≥ lugar.</div>
        </div>
      </div>

      <div class="userChip" id="userChip">
        <div class="userLeft">
          <div class="avatar" id="avatar">MD</div>
          <div class="userMeta">
            <div class="hello" id="hello">üëã Ol√°, ...</div>
            <div class="userEmailSmall" id="userEmailSmall"></div>
          </div>
        </div>
        <button class="btn btnDanger btnSmall" id="btnLogout">Sair</button>
      </div>
    </div>

    <!-- AUTH VIEW -->
    <div id="authView" class="view">
      <div class="authGrid">

        <div class="card">
          <div class="cardHead"><b>Entrar</b><span class="pill">Email + senha</span></div>
          <div class="cardBody">
            <div class="row">
              <div class="field">
                <label for="loginEmail">Email</label>
                <input id="loginEmail" type="email" placeholder="seuemail@gmail.com" autocomplete="email">
              </div>
              <div class="field">
                <label for="loginPass">Senha</label>
                <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
              </div>
            </div>
            <div class="row" style="margin-top:12px;">
              <button class="btn btnPrimary" id="btnLogin">Entrar</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardHead"><b>Criar conta</b><span class="pill">Nome + Email + senha</span></div>
          <div class="cardBody">
            <div class="row">
              <div class="field">
                <label for="regName">Nome</label>
                <input id="regName" type="text" placeholder="Ex: Isaias" autocomplete="name">
              </div>
              <div class="field">
                <label for="regEmail">Email</label>
                <input id="regEmail" type="email" placeholder="seuemail@gmail.com" autocomplete="email">
              </div>
              <div class="field">
                <label for="regPass">Senha</label>
                <input id="regPass" type="password" placeholder="Crie uma senha" autocomplete="new-password">
              </div>
            </div>
            <div class="row" style="margin-top:12px;">
              <button class="btn btnPrimary" id="btnRegister">Criar conta</button>
            </div>
            <div class="muted" style="margin-top:10px;">
              O nome ficar√° vis√≠vel no topo como: <b>üëã Ol√°, Seu Nome</b>.
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- APP VIEW -->
    <div id="appView" class="view hide" aria-hidden="true">
      <div class="grid">

        <!-- LEFT: upload + filtros -->
        <div class="card">
          <div class="cardHead">
            <b>Upload</b>
            <span style="font-size:12px;color:var(--muted)">Cloudinary + Firestore</span>
          </div>

          <div class="cardBody">
            <div class="row">
              <div class="field">
                <label for="fileInput">Arquivo</label>
                <input id="fileInput" type="file" />
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <div class="field">
                <label for="folderSelect">Pasta</label>
                <select id="folderSelect"></select>
              </div>

              <div class="field">
                <label for="customName">Nome do arquivo (opcional)</label>
                <input id="customName" type="text" placeholder="Ex: Contrato aluguel 2026" />
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn btnPrimary" id="btnUpload">Enviar arquivo</button>
              <button class="btn btnGhost" id="btnNewFolder">+ Nova pasta</button>
            </div>

            <hr style="border:0;border-top:1px solid rgba(255,255,255,.10); margin:14px 0;">

            <div class="row">
              <div class="field">
                <label for="searchInput">Buscar por nome</label>
                <input id="searchInput" type="text" placeholder="Ex: contrato, foto, v√≠deo..." />
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <div class="field">
                <label for="filterFolder">Filtrar por pasta</label>
                <select id="filterFolder"></select>
              </div>

              <div class="field">
                <label for="filterType">Filtrar por tipo</label>
                <select id="filterType">
                  <option value="all">Todos</option>
                  <option value="image">Imagens</option>
                  <option value="video">V√≠deos</option>
                  <option value="pdf">PDF</option>
                  <option value="other">Outros</option>
                </select>
              </div>
            </div>

          </div>
        </div>

        <!-- RIGHT: arquivos -->
        <div class="card">
          <div class="cardHead">
            <b>Arquivos</b>
            <div class="tabs">
              <button class="tab active" id="tabList">Lista</button>
              <button class="tab" id="tabGallery">Galeria</button>
            </div>
          </div>

          <div class="cardBody">
            <div id="filesList" class="list"></div>
            <div id="filesEmpty" class="empty" style="display:none;">Nenhum arquivo ainda.</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /*************************************************************
     * 1) COLE SEU firebaseConfig AQUI
     * Pegue em: Firebase Console -> Config do Projeto -> Seus apps -> Web
     *************************************************************/
    const firebaseConfig = {
  apiKey: "AIzaSyAYAwMfCDcXALBVM1uemmJA4aWQK5MNcc0",
  authDomain: "meu-drive-beb33.firebaseapp.com",
  projectId: "meu-drive-beb33",
  storageBucket: "meu-drive-beb33.firebasestorage.app",
  messagingSenderId: "661176300748",
  appId: "1:661176300748:web:68ab970ae9e668fdb67e69"
};
    /*************************************************************
     * 2) Cloudinary (seus dados)
     *************************************************************/
    const CLOUD_NAME = "dilyddwkg";
    const UPLOAD_PRESET = "kv9sjt0g";
    const CLOUD_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;

    /*************************************************************/
    const $ = (id)=>document.getElementById(id);
    const loader = $('loader');
    const authView = $('authView');
    const appView = $('appView');
    const userChip = $('userChip');
    const hello = $('hello');
    const avatar = $('avatar');
    const userEmailSmall = $('userEmailSmall');

    const loginEmail = $('loginEmail');
    const loginPass = $('loginPass');
    const btnLogin = $('btnLogin');

    const regName = $('regName');
    const regEmail = $('regEmail');
    const regPass = $('regPass');
    const btnRegister = $('btnRegister');

    const btnLogout = $('btnLogout');

    const fileInput = $('fileInput');
    const folderSelect = $('folderSelect');
    const customName = $('customName');
    const btnUpload = $('btnUpload');
    const btnNewFolder = $('btnNewFolder');

    const searchInput = $('searchInput');
    const filterFolder = $('filterFolder');
    const filterType = $('filterType');

    const tabList = $('tabList');
    const tabGallery = $('tabGallery');
    const filesList = $('filesList');
    const filesEmpty = $('filesEmpty');

    const previewOverlay = $('previewOverlay');
    const previewTitle = $('previewTitle');
    const previewMeta = $('previewMeta');
    const previewBody = $('previewBody');
    const previewClose = $('previewClose');
    const previewOpenTab = $('previewOpenTab');

    let app, auth, db;
    let currentUser = null;

    // caches
    let folders = []; // {id,name}
    let files = [];   // file docs
    let viewMode = "list"; // list | gallery

    function showLoader(on){ loader.style.display = on ? 'flex' : 'none'; }

    function safeInitFirebase(){
      try{
        if(!firebaseConfig || !firebaseConfig.apiKey){
          alert("‚ö†Ô∏è Falta colar o firebaseConfig. Cole o config do Firebase no topo do index.html e recarregue.");
          return false;
        }
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        return true;
      }catch(e){
        console.error(e);
        alert("Erro ao iniciar Firebase. Veja o console.");
        return false;
      }
    }

    function setView(isLogged){
      if(isLogged){
        authView.classList.add('hide');
        authView.setAttribute('aria-hidden','true');
        appView.classList.remove('hide');
        appView.setAttribute('aria-hidden','false');
        userChip.style.display = 'flex';
      }else{
        authView.classList.remove('hide');
        authView.setAttribute('aria-hidden','false');
        appView.classList.add('hide');
        appView.setAttribute('aria-hidden','true');
        userChip.style.display = 'none';
      }
    }

    function initialsFromName(name){
      if(!name) return "MD";
      const parts = name.trim().split(/\s+/).slice(0,2);
      return parts.map(p=>p[0]?.toUpperCase()).join('') || "MD";
    }

    function setHello(name){
      const clean = (name || "Usu√°rio").trim();
      hello.textContent = `üëã Ol√°, ${clean}`;
      avatar.textContent = initialsFromName(clean);
    }

    function fmtBytes(bytes){
      if(!bytes && bytes !== 0) return "";
      const units = ['B','KB','MB','GB'];
      let b = bytes, i = 0;
      while(b >= 1024 && i < units.length-1){ b/=1024; i++; }
      return `${b.toFixed(b>=10 || i===0 ? 0 : 1)} ${units[i]}`;
    }

    function detectKind(fileDoc){
      // kind: image | video | pdf | other
      const t = (fileDoc.type || "").toLowerCase();
      if(t.startsWith("image/")) return "image";
      if(t.startsWith("video/")) return "video";
      if(t === "application/pdf") return "pdf";
      // fallback by resourceType if cloudinary
      if(fileDoc.resourceType === "image") return "image";
      if(fileDoc.resourceType === "video") return "video";
      return "other";
    }

    function iconFor(kind){
      if(kind === "image") return "üñºÔ∏è";
      if(kind === "video") return "üé¨";
      if(kind === "pdf") return "üìÑ";
      return "üì¶";
    }

    function openPreview(fileDoc){
      const kind = detectKind(fileDoc);
      previewTitle.textContent = fileDoc.displayName || fileDoc.originalName || "Arquivo";
      previewMeta.textContent = `${fileDoc.folderName || "Sem pasta"} ‚Ä¢ ${kind.toUpperCase()} ‚Ä¢ ${fmtBytes(fileDoc.size || 0)}`;
      previewOpenTab.href = fileDoc.url || "#";

      previewBody.innerHTML = "";

      if(kind === "image"){
        const img = document.createElement("img");
        img.src = fileDoc.url;
        img.alt = fileDoc.displayName || "imagem";
        previewBody.appendChild(img);
      }else if(kind === "video"){
        const v = document.createElement("video");
        v.src = fileDoc.url;
        v.controls = true;
        previewBody.appendChild(v);
      }else if(kind === "pdf"){
        // iframe funciona bem no desktop; no celular √†s vezes abre viewer do navegador
        const iframe = document.createElement("iframe");
        iframe.src = fileDoc.url;
        iframe.style.height = "70vh";
        iframe.loading = "lazy";
        previewBody.appendChild(iframe);
      }else{
        const box = document.createElement("div");
        box.className = "empty";
        box.innerHTML = `Esse tipo n√£o tem preview aqui.<br><br><a class="btn btnSmall btnPrimary" target="_blank" rel="noopener" href="${fileDoc.url}">Abrir arquivo</a>`;
        previewBody.appendChild(box);
      }

      previewOverlay.style.display = "flex";
      previewOverlay.setAttribute("aria-hidden","false");
    }

    function closePreview(){
      previewOverlay.style.display = "none";
      previewOverlay.setAttribute("aria-hidden","true");
      previewBody.innerHTML = "";
    }

    previewClose.addEventListener("click", closePreview);
    previewOverlay.addEventListener("click", (e)=>{
      if(e.target === previewOverlay) closePreview();
    });

    function setTabs(){
      if(viewMode === "list"){
        tabList.classList.add("active");
        tabGallery.classList.remove("active");
      }else{
        tabGallery.classList.add("active");
        tabList.classList.remove("active");
      }
      renderFiles();
    }

    tabList.addEventListener("click", ()=>{ viewMode="list"; setTabs(); });
    tabGallery.addEventListener("click", ()=>{ viewMode="gallery"; setTabs(); });

    /*************************************************************
     * FIRESTORE HELPERS
     *************************************************************/
    function col(name){ return db.collection(name); }
    function nowTS(){ return firebase.firestore.FieldValue.serverTimestamp(); }

    async function ensureDefaultFolders(uid){
      // cria algumas pastas padr√£o se ainda n√£o existir nenhuma
      const snap = await col("folders").where("uid","==",uid).get();
      if(!snap.empty) return;

      const defaults = ["Imagens","V√≠deos","PDF","Outros"];
      const batch = db.batch();
      defaults.forEach(n=>{
        const ref = col("folders").doc();
        batch.set(ref, { uid, name:n, createdAt: nowTS() });
      });
      await batch.commit();
    }

    async function loadFolders(){
      folders = [];
      const snap = await col("folders").where("uid","==",currentUser.uid).get();
      snap.forEach(d=> folders.push({ id:d.id, ...d.data() }));
      // ordena client-side
      folders.sort((a,b)=> (a.name||"").localeCompare(b.name||"", "pt-BR"));
      renderFolderSelects();
    }

    function renderFolderSelects(){
      // upload select
      folderSelect.innerHTML = "";
      // filter select
      filterFolder.innerHTML = "";

      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "Todas";
      filterFolder.appendChild(allOpt);

      if(folders.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Sem pastas";
        folderSelect.appendChild(opt);
        return;
      }

      folders.forEach(f=>{
        const o1 = document.createElement("option");
        o1.value = f.id;
        o1.textContent = f.name;
        folderSelect.appendChild(o1);

        const o2 = document.createElement("option");
        o2.value = f.id;
        o2.textContent = f.name;
        filterFolder.appendChild(o2);
      });
    }

    async function createFolder(){
      const name = (prompt("Nome da nova pasta:") || "").trim();
      if(!name) return;

      try{
        showLoader(true);
        await col("folders").add({ uid: currentUser.uid, name, createdAt: nowTS() });
        await loadFolders();
        alert("Pasta criada ‚úÖ");
      }catch(e){
        console.error(e);
        alert("Erro ao criar pasta");
      }finally{
        showLoader(false);
      }
    }

    async function loadFiles(){
      files = [];
      // evitar query que exige √≠ndice: pega todos do usu√°rio e filtra no front
      const snap = await col("files").where("uid","==",currentUser.uid).get();
      snap.forEach(d => files.push({ id:d.id, ...d.data() }));
      // ordena por createdAt desc client-side
      files.sort((a,b)=>{
        const ta = a.createdAt?.seconds || 0;
        const tb = b.createdAt?.seconds || 0;
        return tb - ta;
      });
      renderFiles();
    }

    function applyFilters(list){
      const q = (searchInput.value || "").trim().toLowerCase();
      const fFolder = filterFolder.value || "all";
      const fType = filterType.value || "all";

      return list.filter(item=>{
        const name = (item.displayName || item.originalName || "").toLowerCase();
        const okSearch = !q || name.includes(q);

        const okFolder = (fFolder === "all") || (item.folderId === fFolder);
        const kind = detectKind(item);
        const okType = (fType === "all") || (kind === fType);

        return okSearch && okFolder && okType;
      });
    }

    function renderFiles(){
      const filtered = applyFilters(files);

      filesList.innerHTML = "";
      filesEmpty.style.display = filtered.length ? "none" : "block";

      filtered.forEach(fileDoc=>{
        const kind = detectKind(fileDoc);

        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        left.className = "left";

        const thumb = document.createElement("div");
        thumb.className = "thumb";

        if(viewMode === "gallery" && kind === "image" && fileDoc.url){
          const img = document.createElement("img");
          img.src = fileDoc.url;
          img.alt = "thumb";
          img.onerror = ()=>{ thumb.innerHTML = `<span>${iconFor(kind)}</span>`; };
          thumb.appendChild(img);
        }else{
          thumb.innerHTML = `<span>${iconFor(kind)}</span>`;
        }

        const meta = document.createElement("div");
        meta.className = "meta";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = fileDoc.displayName || fileDoc.originalName || "Arquivo";

        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = `${fileDoc.folderName || "Sem pasta"} ‚Ä¢ ${kind.toUpperCase()} ‚Ä¢ ${fmtBytes(fileDoc.size || 0)}`;

        meta.appendChild(name);
        meta.appendChild(sub);

        left.appendChild(thumb);
        left.appendChild(meta);

        // clique abre preview (sem nova janela)
        left.style.cursor = "pointer";
        left.addEventListener("click", ()=> openPreview(fileDoc));

        const right = document.createElement("div");
        right.className = "right";

        const btnPreview = document.createElement("button");
        btnPreview.className = "btn btnSmall btnPrimary";
        btnPreview.textContent = "Ver";
        btnPreview.addEventListener("click", ()=> openPreview(fileDoc));

        const btnRename = document.createElement("button");
        btnRename.className = "btn btnSmall btnGhost";
        btnRename.textContent = "Renomear";
        btnRename.addEventListener("click", ()=> renameFile(fileDoc));

        const btnMove = document.createElement("button");
        btnMove.className = "btn btnSmall btnGhost";
        btnMove.textContent = "Mover";
        btnMove.addEventListener("click", ()=> moveFile(fileDoc));

        const btnDel = document.createElement("button");
        btnDel.className = "btn btnSmall btnDanger";
        btnDel.textContent = "Excluir";
        btnDel.addEventListener("click", ()=> deleteFile(fileDoc));

        right.appendChild(btnPreview);
        right.appendChild(btnRename);
        right.appendChild(btnMove);
        right.appendChild(btnDel);

        row.appendChild(left);
        row.appendChild(right);

        filesList.appendChild(row);
      });
    }

    async function renameFile(fileDoc){
      const current = fileDoc.displayName || fileDoc.originalName || "";
      const newName = (prompt("Novo nome do arquivo:", current) || "").trim();
      if(!newName || newName === current) return;

      try{
        showLoader(true);
        await col("files").doc(fileDoc.id).update({ displayName: newName });
        await loadFiles();
        alert("Renomeado ‚úÖ");
      }catch(e){
        console.error(e);
        alert("Erro ao renomear");
      }finally{
        showLoader(false);
      }
    }

    async function moveFile(fileDoc){
      if(!folders.length){
        alert("Voc√™ n√£o tem pastas ainda.");
        return;
      }

      // lista de op√ß√µes
      const map = folders.map((f,idx)=> `${idx+1}) ${f.name}`).join("\n");
      const idxStr = prompt("Mover para qual pasta?\n\n" + map + "\n\nDigite o n√∫mero:");
      const idx = parseInt(idxStr,10);
      if(!idx || idx < 1 || idx > folders.length) return;

      const dest = folders[idx-1];
      if(dest.id === fileDoc.folderId) return;

      try{
        showLoader(true);
        await col("files").doc(fileDoc.id).update({
          folderId: dest.id,
          folderName: dest.name
        });
        await loadFiles();
        alert("Movido ‚úÖ");
      }catch(e){
        console.error(e);
        alert("Erro ao mover");
      }finally{
        showLoader(false);
      }
    }

    async function deleteFile(fileDoc){
      const ok = confirm(`Excluir "${fileDoc.displayName || fileDoc.originalName}"?`);
      if(!ok) return;

      try{
        showLoader(true);
        // aqui remove s√≥ do Firestore (r√°pido).
        // Remover tamb√©m do Cloudinary exigiria backend (por seguran√ßa).
        await col("files").doc(fileDoc.id).delete();
        await loadFiles();
        alert("Exclu√≠do ‚úÖ");
      }catch(e){
        console.error(e);
        alert("Erro ao excluir");
      }finally{
        showLoader(false);
      }
    }

    /*************************************************************
     * CLOUDINARY UPLOAD
     *************************************************************/
    async function uploadToCloudinary(file){
      const form = new FormData();
      form.append("file", file);
      form.append("upload_preset", UPLOAD_PRESET);

      const res = await fetch(CLOUD_UPLOAD_URL, { method:"POST", body: form });
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error("Cloudinary upload falhou: " + txt);
      }
      return await res.json();
    }

    async function handleUpload(){
      const file = fileInput.files && fileInput.files[0];
      if(!file){ alert("Escolha um arquivo."); return; }

      const folderId = folderSelect.value;
      const folderObj = folders.find(f=>f.id === folderId);
      const folderName = folderObj ? folderObj.name : "Sem pasta";

      const displayName = (customName.value || "").trim();
      const finalName = displayName || file.name;

      try{
        showLoader(true);

        const up = await uploadToCloudinary(file);

        const doc = {
          uid: currentUser.uid,
          folderId: folderId || null,
          folderName,
          url: up.secure_url,
          publicId: up.public_id,
          resourceType: up.resource_type,
          type: file.type || "",
          size: file.size || 0,
          originalName: file.name || "",
          displayName: finalName,
          createdAt: nowTS()
        };

        await col("files").add(doc);

        // reset
        fileInput.value = "";
        customName.value = "";

        await loadFiles();
        alert("Upload conclu√≠do ‚úÖ");
      }catch(e){
        console.error(e);
        alert("Erro no upload. Veja o console.");
      }finally{
        showLoader(false);
      }
    }

    /*************************************************************
     * AUTH + PERFIL (Nome no topo)
     *************************************************************/
    async function saveUserProfile(uid, name, email){
      await col("users").doc(uid).set({
        name,
        email,
        createdAt: nowTS()
      }, { merge:true });
    }

    async function loadUserProfile(uid){
      const doc = await col("users").doc(uid).get();
      if(doc.exists){
        return doc.data();
      }
      return null;
    }

    async function afterLogin(user){
      currentUser = user;

      // pega nome do Firestore
      const profile = await loadUserProfile(user.uid);

      let name = profile?.name || user.displayName || "Usu√°rio";
      setHello(name);

      // email pequeno oculto por padr√£o (se quiser mostrar, mude CSS display)
      userEmailSmall.textContent = user.email || "";
      setView(true);

      // garantir pastas padr√£o (uma vez)
      await ensureDefaultFolders(user.uid);

      // carregar dados
      await loadFolders();
      await loadFiles();

      // garantir selects
      filterType.value = "all";
      filterFolder.value = "all";
      viewMode = "list";
      setTabs();
    }

    btnLogin.addEventListener("click", async ()=>{
      try{
        showLoader(true);
        const email = (loginEmail.value||"").trim();
        const pass = (loginPass.value||"").trim();
        if(!email || !pass){ alert("Preencha email e senha."); return; }

        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        console.error(e);
        alert("Erro no login: " + (e.message || "verifique os dados"));
      }finally{
        showLoader(false);
      }
    });

    btnRegister.addEventListener("click", async ()=>{
      try{
        showLoader(true);
        const name = (regName.value||"").trim();
        const email = (regEmail.value||"").trim();
        const pass = (regPass.value||"").trim();

        if(!name || !email || !pass){
          alert("Preencha Nome, Email e Senha.");
          return;
        }

        const cred = await auth.createUserWithEmailAndPassword(email, pass);

        // opcional: tamb√©m salva no Auth displayName
        await cred.user.updateProfile({ displayName: name });

        // salva no Firestore
        await saveUserProfile(cred.user.uid, name, email);

        alert("Conta criada ‚úÖ Agora √© s√≥ usar!");
        // limpa campos
        regName.value = ""; regEmail.value=""; regPass.value="";
      }catch(e){
        console.error(e);
        alert("Erro ao criar conta: " + (e.message || ""));
      }finally{
        showLoader(false);
      }
    });

    btnLogout.addEventListener("click", async ()=>{
      try{
        await auth.signOut();
      }catch(e){
        console.error(e);
      }
    });

    /*************************************************************
     * EVENTOS UI
     *************************************************************/
    btnNewFolder.addEventListener("click", createFolder);
    btnUpload.addEventListener("click", handleUpload);
    [searchInput, filterFolder, filterType].forEach(el=>{
      el.addEventListener("input", renderFiles);
      el.addEventListener("change", renderFiles);
    });

    /*************************************************************
     * START
     *************************************************************/
    (function start(){
      if(!safeInitFirebase()) return;

      auth.onAuthStateChanged(async (user)=>{
        try{
          if(user){
            showLoader(true);
            await afterLogin(user);
          }else{
            currentUser = null;
            setView(false);
          }
        }catch(e){
          console.error(e);
          alert("Erro ao carregar sua conta. Veja o console.");
          setView(false);
        }finally{
          showLoader(false);
        }
      });
    })();
  </script>
</body>
</html>
