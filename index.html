<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Meu Drive</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      padding: 20px;
      margin: 0;
    }

    h2 {
      margin-top: 0;
    }

    .box {
      background: #fff;
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 14px;
      max-width: 900px;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    input {
      padding: 8px;
      font-size: 14px;
    }

    button {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fafafa;
    }

    button:hover {
      background: #eee;
    }

    .danger {
      background: #d11;
      color: #fff;
      border: none;
    }

    .danger:hover {
      background: #b00;
    }

    .file {
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    a {
      color: #0b57d0;
      text-decoration: none;
      font-weight: 500;
    }

    .small {
      font-size: 12px;
      opacity: 0.7;
    }

    img {
      display: block;
    }
  </style>
</head>
<body>

<h2>Meu Drive ‚òÅÔ∏è (sincronizado)</h2>

<!-- LOGIN -->
<div class="box" id="authBox">
  <div class="row">
    <input id="email" type="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Senha">
    <button id="btnLogin">Entrar</button>
    <button id="btnSignup">Criar conta</button>
  </div>
  <p class="small" id="authStatus"></p>
</div>

<!-- APP -->
<div class="box" id="appBox" style="display:none;">
  <div class="row">
    <strong id="userLabel"></strong>
    <button id="btnLogout">Sair</button>
  </div>

  <hr>

  <div class="row">
    <input type="file" id="fileInput">
    <button id="btnUpload">Enviar arquivo</button>
    <span class="small" id="status"></span>
  </div>

  <div id="list"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    query,
    where,
    orderBy,
    onSnapshot,
    deleteDoc,
    doc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  /* üî• FIREBASE CONFIG */
  const firebaseConfig = {
    apiKey: "AIzaSyAYAwMfCDcXALBVM1uemmJA4aWQK5MNcc0",
    authDomain: "meu-drive-beb33.firebaseapp.com",
    projectId: "meu-drive-beb33",
    storageBucket: "meu-drive-beb33.firebasestorage.app",
    messagingSenderId: "661176300748",
    appId: "1:661176300748:web:68ab970ae9e668fdb67e69"
  };

  /* ‚òÅÔ∏è CLOUDINARY CONFIG */
  const cloudName = "dilyddwkg";
  const uploadPreset = "kv9sjt0g";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const authBox = document.getElementById("authBox");
  const appBox = document.getElementById("appBox");
  const authStatus = document.getElementById("authStatus");
  const userLabel = document.getElementById("userLabel");
  const statusEl = document.getElementById("status");
  const listEl = document.getElementById("list");

  document.getElementById("btnSignup").onclick = async () => {
    authStatus.textContent = "";
    const email = emailInput.value.trim();
    const pass = passInput.value.trim();
    if (!email || !pass) return authStatus.textContent = "Preencha email e senha.";
    try {
      await createUserWithEmailAndPassword(auth, email, pass);
    } catch (e) {
      authStatus.textContent = e.message;
    }
  };

  document.getElementById("btnLogin").onclick = async () => {
    authStatus.textContent = "";
    const email = emailInput.value.trim();
    const pass = passInput.value.trim();
    if (!email || !pass) return authStatus.textContent = "Preencha email e senha.";
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (e) {
      authStatus.textContent = e.message;
    }
  };

  document.getElementById("btnLogout").onclick = () => signOut(auth);

  async function uploadToCloudinary(file) {
    const url = `https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`;
    const fd = new FormData();
    fd.append("file", file);
    fd.append("upload_preset", uploadPreset);

    const res = await fetch(url, { method: "POST", body: fd });
    const data = await res.json();
    if (!data.secure_url) throw new Error("Falha no upload.");
    return data;
  }

  document.getElementById("btnUpload").onclick = async () => {
    const user = auth.currentUser;
    if (!user) return alert("Fa√ßa login.");

    const file = fileInput.files[0];
    if (!file) return alert("Escolha um arquivo.");

    statusEl.textContent = "Enviando...";

    try {
      const up = await uploadToCloudinary(file);

      await addDoc(collection(db, "files"), {
        uid: user.uid,
        name: up.original_filename || file.name,
        url: up.secure_url,
        bytes: up.bytes ?? file.size,
        publicId: up.public_id,
        format: up.format,
        resourceType: up.resource_type,
        createdAt: serverTimestamp()
      });

      statusEl.textContent = "Upload conclu√≠do!";
      fileInput.value = "";
    } catch (e) {
      statusEl.textContent = "Erro no upload.";
      alert(e.message);
    }
  };

  let unsubscribe = null;

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      authBox.style.display = "block";
      appBox.style.display = "none";
      if (unsubscribe) unsubscribe();
      return;
    }

    authBox.style.display = "none";
    appBox.style.display = "block";
    userLabel.textContent = `Logado como: ${user.email}`;

    const q = query(
      collection(db, "files"),
      where("uid", "==", user.uid),
      orderBy("createdAt", "desc")
    );

    if (unsubscribe) unsubscribe();
    unsubscribe = onSnapshot(q, (snap) => {
      listEl.innerHTML = "";

      if (snap.empty) {
        listEl.innerHTML = "<p class='small'>Nenhum arquivo ainda.</p>";
        return;
      }

      snap.forEach((d) => {
        const f = d.data();

        const div = document.createElement("div");
        div.className = "file";

        const left = document.createElement("div");

        const thumbUrl =
          (f.resourceType === "image" && f.publicId && f.format)
            ? `https://res.cloudinary.com/${cloudName}/image/upload/w_120,h_120,c_fill,q_auto,f_auto/${f.publicId}.${f.format}`
            : null;

        left.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center;">
            ${
              thumbUrl
                ? `<img src="${thumbUrl}" style="width:72px;height:72px;object-fit:cover;border-radius:10px;">`
                : `<div style="width:72px;height:72px;border-radius:10px;border:1px solid #ddd;display:flex;align-items:center;justify-content:center;font-size:28px;">üìÑ</div>`
            }
            <div>
              <a href="${f.url}" target="_blank">${f.name}</a><br>
              <span class="small">${f.bytes ? (f.bytes/1024).toFixed(1) + " KB" : ""}</span>
            </div>
          </div>
        `;

        const del = document.createElement("button");
        del.className = "danger";
        del.textContent = "Remover da lista";
        del.onclick = () => deleteDoc(doc(db, "files", d.id));

        div.appendChild(left);
        div.appendChild(del);
        listEl.appendChild(div);
      });
    });
  });
</script>

</body>
</html>
