<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meu Drive</title>

  <style>
    :root{
      --bg1:#071022;
      --bg2:#0b2a66;
      --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --brand:#4f7cf0;
      --brand2:#2dd4bf;
      --danger:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:22px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 30% 20%, rgba(79,124,240,.35), transparent 60%),
        radial-gradient(900px 600px at 80% 60%, rgba(45,212,191,.22), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Fix geral pro ‚Äúlist√£o branco‚Äù (Chrome/Android) */
    html { color-scheme: dark; }
    select, option { color-scheme: dark; }

    .wrap{ width:min(1050px, 92vw); margin: 20px auto 40px; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:16px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; min-width:0;
    }
    .appIcon{
      width:44px; height:44px; border-radius:14px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      flex:0 0 auto;
      display:grid; place-items:center;
      font-weight:900;
      letter-spacing:.5px;
    }
    .titleWrap{ min-width:0; }
    h1{ font-size:28px; margin:0; display:flex; gap:8px; align-items:center; white-space:nowrap; }
    .subtitle{ margin:4px 0 0; color:var(--muted); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Topo alinhado e-mail/nome (sem passar por cima do t√≠tulo) */
    .userChip{
      display:none;
      align-items:center;
      gap:10px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:8px 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      max-width: 52%;
      min-width: 220px;
    }
    .avatar{
      width:34px; height:34px; border-radius:999px;
      background: linear-gradient(135deg, rgba(79,124,240,.9), rgba(45,212,191,.9));
      display:grid; place-items:center;
      font-weight:900;
      flex:0 0 auto;
    }
    .userMeta{ min-width:0; line-height:1.1; }
    .userName{
      font-size:13px; font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .userEmail{
      font-size:12px; color:var(--muted2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .btn{
      border:0;
      border-radius:16px;
      padding:12px 16px;
      font-weight:800;
      cursor:pointer;
      background: rgba(255,255,255,.10);
      color: var(--txt);
      border:1px solid rgba(255,255,255,.14);
      transition: transform .06s ease, filter .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{ background: linear-gradient(135deg, rgba(79,124,240,.95), rgba(79,124,240,.65)); border-color: rgba(79,124,240,.55); }
    .btnDanger{ background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(239,68,68,.55)); border-color: rgba(239,68,68,.55); }
    .btnSmall{
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      font-weight:900;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:16px; }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead b{ font-size:14px; }
    .cardBody{ padding:14px 16px; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    .field{ flex:1 1 220px; min-width: 180px; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,18,32,.55);
      color: var(--txt);
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color: rgba(255,255,255,.45); }

    select{
      appearance:none;
      -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.75) 50%),
        linear-gradient(135deg, rgba(255,255,255,.75) 50%, transparent 50%),
        linear-gradient(to right, rgba(255,255,255,.10), rgba(255,255,255,.10));
      background-position:
        calc(100% - 18px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px),
        calc(100% - 38px) 50%;
      background-size: 6px 6px, 6px 6px, 1px 18px;
      background-repeat:no-repeat;
      padding-right: 44px;
    }
    option{ background-color:#0b1220; color:#fff; }

    .tabs{
      display:flex;
      gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px;
      border-radius:999px;
      width: fit-content;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      border:1px solid transparent;
      color: rgba(255,255,255,.75);
      background: transparent;
    }
    .tab.active{
      background: rgba(79,124,240,.35);
      border-color: rgba(79,124,240,.45);
      color: var(--txt);
    }

    .list{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .badge{
      width:42px; height:42px;
      border-radius:14px;
      display:grid; place-items:center;
      background: rgba(79,124,240,.22);
      border:1px solid rgba(79,124,240,.25);
      flex:0 0 auto;
      font-weight:900;
      overflow:hidden;
    }
    .thumb{
      width:42px; height:42px;
      border-radius:14px;
      object-fit:cover;
      display:block;
    }
    .meta{ min-width:0; }
    .name{
      font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 52vw;
    }
    .sub{
      font-size:12px;
      color: var(--muted2);
      margin-top:2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 52vw;
    }
    .right{ display:flex; gap:8px; flex:0 0 auto; flex-wrap:wrap; justify-content:flex-end; }

    .empty{
      margin-top:12px;
      color: var(--muted2);
      text-align:center;
      padding:18px 10px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
    }

    .gallery{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .gItem{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:hidden;
      cursor:pointer;
    }
    .gTop{
      aspect-ratio: 4/3;
      width:100%;
      background: rgba(0,0,0,.18);
      display:grid;
      place-items:center;
      position:relative;
    }
    .gTop img, .gTop video{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .gMeta{ padding:10px; }
    .gName{ font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .gSub{ font-size:12px; color:var(--muted2); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Modal preview */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(2,8,18,.70);
      backdrop-filter: blur(8px);
      z-index:9999;
      padding:16px;
    }
    .modalCard{
      width:min(900px, 95vw);
      max-height: 92vh;
      overflow:auto;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: var(--shadow);
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalBody{ padding:14px; }
    .previewBox{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      overflow:hidden;
    }
    .previewBox img, .previewBox video, .previewBox iframe{
      width:100%;
      height: min(70vh, 520px);
      display:block;
      object-fit:contain;
      background: rgba(0,0,0,.35);
    }

    /* Auth */
    .authWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    .hint{ font-size:12px; color:var(--muted2); margin-top:8px; }

    /* Loader */
    .loaderOverlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(2,8,18,.60);
      backdrop-filter: blur(8px);
      z-index:99999;
    }
    .spinner{
      width:56px; height:56px;
      border-radius:50%;
      border: 5px solid rgba(255,255,255,.18);
      border-top-color: rgba(79,124,240,.95);
      animation: spin .9s linear infinite;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
      .card.span2{ grid-column: 1 / -1; }
      .gallery{ grid-template-columns: repeat(3, 1fr); }
      .name{ max-width: 360px; }
      .sub{ max-width: 360px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="appIcon" id="logoIcon">MD</div>
        <div class="titleWrap">
          <h1>Meu Drive <span style="opacity:.8">‚òÅÔ∏è</span></h1>
          <div class="subtitle">Seus arquivos em um s√≥ lugar.</div>
        </div>
      </div>

      <div class="userChip" id="userChip">
        <div class="avatar" id="avatar">U</div>
        <div class="userMeta">
          <div class="userName" id="userName">üëã Ol√°</div>
          <div class="userEmail" id="userEmail">‚Äî</div>
        </div>
        <button class="btn btnSmall btnDanger" id="btnLogout">Sair</button>
      </div>
    </div>

    <!-- AUTH -->
    <div class="grid" id="authView">
      <div class="card">
        <div class="cardHead">
          <b>Entrar</b>
          <span style="font-size:12px;color:var(--muted2)">Login</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="field">
              <label for="loginEmail">Email</label>
              <input id="loginEmail" type="email" placeholder="seuemail@gmail.com" />
            </div>
            <div class="field">
              <label for="loginPass">Senha</label>
              <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btnPrimary" id="btnLogin">Entrar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <b>Criar conta</b>
          <span style="font-size:12px;color:var(--muted2)">Nome + Email + Senha</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="field">
              <label for="signupName">Nome (vis√≠vel no topo)</label>
              <input id="signupName" type="text" placeholder="Ex: Isaias" />
              <div class="hint">O topo vai mostrar: <b>üëã Ol√°, Seu Nome</b></div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label for="signupEmail">Email</label>
              <input id="signupEmail" type="email" placeholder="seuemail@gmail.com" />
            </div>
            <div class="field">
              <label for="signupPass">Senha</label>
              <input id="signupPass" type="password" placeholder="Crie uma senha" />
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btnPrimary" id="btnSignup">Criar conta</button>
          </div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div class="grid" id="appView" style="display:none;">
      <!-- Upload + filtros -->
      <div class="card">
        <div class="cardHead">
          <b>Upload</b>
          <span style="font-size:12px;color:var(--muted2)">Cloudinary + Firestore</span>
        </div>
        <div class="cardBody">

          <div class="row">
            <div class="field">
              <label for="fileInput">Arquivo</label>
              <input id="fileInput" type="file" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label for="folderSelect">Pasta</label>
              <select id="folderSelect"></select>
            </div>
            <div class="field">
              <label for="customName">Nome do arquivo (opcional)</label>
              <input id="customName" type="text" placeholder="Ex: Contrato aluguel 2026" />
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btnPrimary" id="btnUpload">Enviar arquivo</button>
            <button class="btn" id="btnNewFolder">+ Nova pasta</button>
          </div>

          <hr style="margin:16px 0;border:0;border-top:1px solid rgba(255,255,255,.10)" />

          <div class="row">
            <div class="field">
              <label for="searchInput">Buscar por nome</label>
              <input id="searchInput" type="text" placeholder="Ex: contrato, foto, v√≠deo..." />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label for="filterFolder">Filtrar por pasta</label>
              <select id="filterFolder"></select>
            </div>
            <div class="field">
              <label for="filterType">Filtrar por tipo</label>
              <select id="filterType">
                <option value="all">Todos</option>
                <option value="image">Imagens</option>
                <option value="video">V√≠deos</option>
                <option value="raw">PDF/Outros</option>
              </select>
            </div>
          </div>

        </div>
      </div>

      <!-- Arquivos -->
      <div class="card">
        <div class="cardHead">
          <b>Arquivos</b>
          <div class="tabs">
            <button class="tab active" id="tabList">Lista</button>
            <button class="tab" id="tabGallery">Galeria</button>
          </div>
        </div>
        <div class="cardBody">
          <div id="listView"></div>
          <div id="galleryView" style="display:none;"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- Preview Modal -->
  <div class="modal" id="modal">
    <div class="modalCard">
      <div class="modalHead">
        <div style="min-width:0">
          <div style="font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="modalTitle">Arquivo</div>
          <div style="font-size:12px;color:var(--muted2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="modalSub">‚Äî</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btnSmall" id="btnModalRename">Renomear</button>
          <button class="btn btnSmall" id="btnModalMove">Mover</button>
          <a class="btn btnSmall" id="btnModalOpen" target="_blank" rel="noopener">Abrir</a>
          <button class="btn btnSmall btnDanger" id="btnModalDelete">Excluir</button>
          <button class="btn btnSmall" id="btnModalClose">Fechar</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="previewBox" id="previewBox"></div>
      </div>
    </div>
  </div>

  <div class="loaderOverlay" id="loader">
    <div class="spinner"></div>
  </div>

  <script type="module">
    // =========================
    // CONFIG (edite s√≥ aqui)
    // =========================
    const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAYAwMfCDcXALBVM1uemmJA4aWQK5MNcc0",
  authDomain: "meu-drive-beb33.firebaseapp.com",
  projectId: "meu-drive-beb33",
  storageBucket: "meu-drive-beb33.firebasestorage.app",
  messagingSenderId: "661176300748",
  appId: "1:661176300748:web:68ab970ae9e668fdb67e69"
};

    const CLOUDINARY_CLOUD_NAME = "dilyddwkg";
    const CLOUDINARY_UNSIGNED_PRESET = "kv9sjt0g"; // unsigned preset
    // =========================

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      updateProfile,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc,
      addDoc, updateDoc, deleteDoc,
      onSnapshot, query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // --- helpers UI
    const $ = (id) => document.getElementById(id);
    const showLoader = (v) => { $("loader").style.display = v ? "flex" : "none"; };
    const toast = (msg) => alert(msg);

    // --- init
    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- state
    let currentUser = null;
    let folders = []; // {id, name}
    let files = [];   // {id, name, url, type, folderId, folderName, createdAt}
    let selectedFile = null;
    let unsubFolders = null;
    let unsubFiles = null;

    // --- DOM refs
    const authView = $("authView");
    const appView = $("appView");
    const userChip = $("userChip");

    // =========================
    // AUTH
    // =========================
    $("btnLogin").addEventListener("click", async () => {
      try{
        showLoader(true);
        const email = $("loginEmail").value.trim();
        const pass = $("loginPass").value.trim();
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(e){
        console.error(e);
        toast("Erro no login. Veja o console.");
      }finally{
        showLoader(false);
      }
    });

    $("btnSignup").addEventListener("click", async () => {
      try{
        showLoader(true);
        const name = $("signupName").value.trim();
        const email = $("signupEmail").value.trim();
        const pass = $("signupPass").value.trim();
        if(!name) return toast("Digite seu nome.");
        if(!email) return toast("Digite seu email.");
        if(pass.length < 6) return toast("Senha precisa ter pelo menos 6 caracteres.");

        const cred = await createUserWithEmailAndPassword(auth, email, pass);

        // Nome no Auth (pra ficar bonitinho)
        await updateProfile(cred.user, { displayName: name });

        // Perfil no Firestore (users/{uid})
        await setDoc(doc(db, "users", cred.user.uid), {
          uid: cred.user.uid,
          name,
          email,
          createdAt: serverTimestamp(),
        }, { merge:true });

      }catch(e){
        console.error(e);
        toast("Erro ao criar conta. Veja o console.");
      }finally{
        showLoader(false);
      }
    });

    $("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (u) => {
      currentUser = u || null;

      if(!currentUser){
        // cleanup
        if(unsubFolders) unsubFolders();
        if(unsubFiles) unsubFiles();
        folders = [];
        files = [];
        selectedFile = null;

        userChip.style.display = "none";
        appView.style.display = "none";
        authView.style.display = "grid";
        return;
      }

      authView.style.display = "none";
      appView.style.display = "grid";
      userChip.style.display = "flex";

      await loadProfileAndHeader();
      listenFolders();
      listenFiles();
    });

    async function loadProfileAndHeader(){
      try{
        // tenta pegar do Auth
        let displayName = currentUser.displayName || "";
        const email = currentUser.email || "";

        // tenta pegar do Firestore (se o Auth estiver vazio)
        if(!displayName){
          const snap = await getDoc(doc(db, "users", currentUser.uid));
          if(snap.exists()){
            displayName = (snap.data().name || "");
          }
        }

        const finalName = displayName || (email ? email.split("@")[0] : "Usu√°rio");
        $("userName").textContent = `üëã Ol√°, ${capitalize(finalName)}`;
        $("userEmail").textContent = email || "‚Äî";
        $("avatar").textContent = (finalName || "U").trim().slice(0,1).toUpperCase();

      }catch(e){
        console.error(e);
        toast("Erro ao carregar sua conta. Veja o console.");
      }
    }

    function capitalize(s){
      if(!s) return s;
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    // =========================
    // FOLDERS
    // =========================
    $("btnNewFolder").addEventListener("click", async () => {
      const name = prompt("Nome da nova pasta:");
      if(!name) return;

      try{
        showLoader(true);
        await addDoc(collection(db, "folders"), {
          uid: currentUser.uid,
          name: name.trim(),
          createdAt: serverTimestamp(),
        });
      }catch(e){
        console.error(e);
        toast("Erro ao criar pasta");
      }finally{
        showLoader(false);
      }
    });

    function listenFolders(){
      if(unsubFolders) unsubFolders();

      const qFolders = query(
        collection(db, "folders"),
        where("uid", "==", currentUser.uid)
      );

      unsubFolders = onSnapshot(qFolders, (snap) => {
        folders = snap.docs
          .map(d => ({ id: d.id, ...(d.data()||{}) }))
          .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

        renderFolderSelects();
      }, (err)=>{
        console.error(err);
        // Se der permiss√£o aqui, √© rules
      });
    }

    function renderFolderSelects(){
      // Upload select
      $("folderSelect").innerHTML = "";
      // Filter select
      $("filterFolder").innerHTML = "";

      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "Todas";
      $("filterFolder").appendChild(allOpt);

      const defaultFolders = [
        { id:"images", name:"Imagens" },
        { id:"videos", name:"V√≠deos" },
        { id:"docs", name:"Documentos" },
        { id:"others", name:"Outros" },
      ];

      const merged = [
        ...defaultFolders,
        ...folders.filter(f => !defaultFolders.some(d => d.name.toLowerCase() === (f.name||"").toLowerCase()))
      ];

      for(const f of merged){
        const o1 = document.createElement("option");
        o1.value = f.id;
        o1.textContent = f.name;
        $("folderSelect").appendChild(o1);

        const o2 = document.createElement("option");
        o2.value = f.id;
        o2.textContent = f.name;
        $("filterFolder").appendChild(o2);
      }
    }

    // =========================
    // FILES (Firestore)
    // =========================
    function listenFiles(){
      if(unsubFiles) unsubFiles();

      const qFiles = query(
        collection(db, "files"),
        where("uid", "==", currentUser.uid)
      );

      unsubFiles = onSnapshot(qFiles, (snap) => {
        files = snap.docs.map(d => ({ id:d.id, ...(d.data()||{}) }));

        // ordena no client (pra n√£o pedir index composto)
        files.sort((a,b)=>{
          const ta = a.createdAt?.seconds || 0;
          const tb = b.createdAt?.seconds || 0;
          return tb - ta;
        });

        renderFiles();
      }, (err)=>{
        console.error(err);
      });
    }

    // =========================
    // UPLOAD (Cloudinary unsigned)
    // =========================
    $("btnUpload").addEventListener("click", async () => {
      const f = $("fileInput").files?.[0];
      if(!f) return toast("Escolha um arquivo.");

      try{
        showLoader(true);

        const folderId = $("folderSelect").value;
        const folderName = ($("folderSelect").selectedOptions?.[0]?.textContent || "‚Äî");

        const custom = $("customName").value.trim();
        const baseName = custom || f.name;

        const res = await uploadToCloudinary(f);
        // res: { secure_url, resource_type, format, bytes, public_id, original_filename }

        const type = res.resource_type || guessTypeFromFile(f);

        await addDoc(collection(db, "files"), {
          uid: currentUser.uid,
          name: baseName,
          originalName: f.name,
          url: res.secure_url,
          type, // image | video | raw
          bytes: res.bytes || null,
          folderId,
          folderName,
          createdAt: serverTimestamp(),
        });

        $("fileInput").value = "";
        $("customName").value = "";

      }catch(e){
        console.error(e);
        toast("Erro no upload. Veja o console.");
      }finally{
        showLoader(false);
      }
    });

    function guessTypeFromFile(file){
      const t = (file.type || "").toLowerCase();
      if(t.startsWith("image/")) return "image";
      if(t.startsWith("video/")) return "video";
      return "raw";
    }

    async function uploadToCloudinary(file){
      const url = `https://api.cloudinary.com/v1_1/${encodeURIComponent(CLOUDINARY_CLOUD_NAME)}/upload`;
      const fd = new FormData();
      fd.append("file", file);
      fd.append("upload_preset", CLOUDINARY_UNSIGNED_PRESET);
      fd.append("resource_type", "auto");

      const r = await fetch(url, { method:"POST", body: fd });
      if(!r.ok){
        const txt = await r.text().catch(()=> "");
        throw new Error("Cloudinary upload failed: " + txt);
      }
      return await r.json();
    }

    // =========================
    // FILTERS + RENDER
    // =========================
    $("searchInput").addEventListener("input", renderFiles);
    $("filterFolder").addEventListener("change", renderFiles);
    $("filterType").addEventListener("change", renderFiles);

    $("tabList").addEventListener("click", () => switchView("list"));
    $("tabGallery").addEventListener("click", () => switchView("gallery"));

    function switchView(v){
      const isList = v === "list";
      $("tabList").classList.toggle("active", isList);
      $("tabGallery").classList.toggle("active", !isList);
      $("listView").style.display = isList ? "block" : "none";
      $("galleryView").style.display = isList ? "none" : "block";
      renderFiles();
    }

    function renderFiles(){
      const search = $("searchInput").value.trim().toLowerCase();
      const ff = $("filterFolder").value;
      const ft = $("filterType").value;

      let filtered = [...files];

      if(search){
        filtered = filtered.filter(x => (x.name||"").toLowerCase().includes(search));
      }
      if(ff && ff !== "all"){
        filtered = filtered.filter(x => x.folderId === ff);
      }
      if(ft && ft !== "all"){
        filtered = filtered.filter(x => x.type === ft);
      }

      const isList = $("tabList").classList.contains("active");
      if(isList) renderList(filtered);
      else renderGallery(filtered);
    }

    function iconForType(type){
      if(type === "image") return "üñºÔ∏è";
      if(type === "video") return "üé¨";
      return "üìÑ";
    }

    function prettyBytes(n){
      if(!n && n !== 0) return "";
      const units = ["B","KB","MB","GB"];
      let i=0; let v=n;
      while(v >= 1024 && i < units.length-1){ v/=1024; i++; }
      return `${v.toFixed(i===0?0:1)} ${units[i]}`;
    }

    function renderList(arr){
      const box = $("listView");
      if(!arr.length){
        box.innerHTML = `<div class="empty">Nenhum arquivo ainda.</div>`;
        return;
      }

      const html = arr.map(file => {
        const sub = `${file.folderName||"‚Äî"} ‚Ä¢ ${file.type||"‚Äî"} ${file.bytes?("‚Ä¢ "+prettyBytes(file.bytes)):""}`;
        const isImg = file.type === "image";

        return `
          <div class="item">
            <div class="left" data-open="${file.id}">
              <div class="badge">
                ${isImg ? `<img class="thumb" alt="" src="${escapeHtml(file.url)}" data-thumb="${file.id}">`
                        : `<span>${iconForType(file.type)}</span>`}
              </div>
              <div class="meta">
                <div class="name">${escapeHtml(file.name||"Sem nome")}</div>
                <div class="sub">${escapeHtml(sub)}</div>
              </div>
            </div>
            <div class="right">
              <button class="btn btnSmall" data-rename="${file.id}">Renomear</button>
              <button class="btn btnSmall" data-move="${file.id}">Mover</button>
              <a class="btn btnSmall" href="${escapeHtml(file.url)}" target="_blank" rel="noopener">Abrir</a>
              <button class="btn btnSmall btnDanger" data-delete="${file.id}">Excluir</button>
            </div>
          </div>
        `;
      }).join("");

      box.innerHTML = `<div class="list">${html}</div>`;

      // FIX do erro "style of null": thumb pode falhar -> troca por √≠cone sem mexer em style de null
      box.querySelectorAll("img.thumb").forEach(img=>{
        img.addEventListener("error", ()=>{
          const badge = img.closest(".badge");
          if(!badge) return; // <- NUNCA mexe em null
          badge.innerHTML = `<span>${iconForType("image")}</span>`;
        }, { once:true });
      });

      // a√ß√µes
      box.querySelectorAll("[data-open]").forEach(el=>{
        el.addEventListener("click", ()=> openModal(el.getAttribute("data-open")));
      });
      box.querySelectorAll("[data-rename]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{ e.stopPropagation(); renameFile(btn.dataset.rename); });
      });
      box.querySelectorAll("[data-move]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{ e.stopPropagation(); moveFile(btn.dataset.move); });
      });
      box.querySelectorAll("[data-delete]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{ e.stopPropagation(); deleteFile(btn.dataset.delete); });
      });
    }

    function renderGallery(arr){
      const box = $("galleryView");
      if(!arr.length){
        box.innerHTML = `<div class="empty">Nenhum arquivo ainda.</div>`;
        return;
      }

      const html = arr.map(file => {
        const sub = `${file.folderName||"‚Äî"} ‚Ä¢ ${file.type||"‚Äî"}`;
        const isImg = file.type === "image";
        const isVideo = file.type === "video";

        return `
          <div class="gItem" data-open="${file.id}">
            <div class="gTop">
              ${
                isImg ? `<img alt="" src="${escapeHtml(file.url)}" data-gthumb="${file.id}">`
                : isVideo ? `<video src="${escapeHtml(file.url)}" muted playsinline></video>`
                : `<div style="font-size:40px">${iconForType(file.type)}</div>`
              }
            </div>
            <div class="gMeta">
              <div class="gName">${escapeHtml(file.name||"Sem nome")}</div>
              <div class="gSub">${escapeHtml(sub)}</div>
            </div>
          </div>
        `;
      }).join("");

      box.innerHTML = `<div class="gallery">${html}</div>`;

      // thumb error safe
      box.querySelectorAll("img[data-gthumb]").forEach(img=>{
        img.addEventListener("error", ()=>{
          const top = img.parentElement;
          if(!top) return;
          top.innerHTML = `<div style="font-size:40px">${iconForType("image")}</div>`;
        }, { once:true });
      });

      box.querySelectorAll("[data-open]").forEach(el=>{
        el.addEventListener("click", ()=> openModal(el.getAttribute("data-open")));
      });
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // Actions: rename/move/delete
    // =========================
    async function renameFile(id){
      const f = files.find(x=>x.id===id);
      if(!f) return;
      const newName = prompt("Novo nome:", f.name || "");
      if(!newName) return;

      try{
        showLoader(true);
        await updateDoc(doc(db,"files",id), { name: newName.trim() });
      }catch(e){
        console.error(e);
        toast("Erro ao renomear. Veja o console.");
      }finally{
        showLoader(false);
      }
    }

    async function moveFile(id){
      const f = files.find(x=>x.id===id);
      if(!f) return;

      const options = [...$("folderSelect").options].map(o=>({id:o.value, name:o.textContent}));
      const list = options.map((o,i)=> `${i+1}) ${o.name}`).join("\n");
      const pick = prompt("Mover para qual pasta?\n\n" + list + "\n\nDigite o n√∫mero:");
      const idx = Number(pick) - 1;
      if(Number.isNaN(idx) || idx < 0 || idx >= options.length) return;

      try{
        showLoader(true);
        await updateDoc(doc(db,"files",id), {
          folderId: options[idx].id,
          folderName: options[idx].name
        });
      }catch(e){
        console.error(e);
        toast("Erro ao mover. Veja o console.");
      }finally{
        showLoader(false);
      }
    }

    async function deleteFile(id){
      const f = files.find(x=>x.id===id);
      if(!f) return;
      if(!confirm(`Excluir "${f.name}"?`)) return;

      try{
        showLoader(true);
        await deleteDoc(doc(db,"files",id));
      }catch(e){
        console.error(e);
        toast("Erro ao excluir. Veja o console.");
      }finally{
        showLoader(false);
      }
    }

    // =========================
    // MODAL PREVIEW (sem abrir outra janela)
    // =========================
    const modal = $("modal");
    $("btnModalClose").addEventListener("click", closeModal);
    modal.addEventListener("click", (e)=> { if(e.target === modal) closeModal(); });

    $("btnModalRename").addEventListener("click", ()=> selectedFile && renameFile(selectedFile.id));
    $("btnModalMove").addEventListener("click", ()=> selectedFile && moveFile(selectedFile.id));
    $("btnModalDelete").addEventListener("click", ()=> { if(selectedFile) { closeModal(); deleteFile(selectedFile.id); } });

    function openModal(id){
      const f = files.find(x=>x.id===id);
      if(!f) return;

      selectedFile = f;
      $("modalTitle").textContent = f.name || "Arquivo";
      $("modalSub").textContent = `${f.folderName||"‚Äî"} ‚Ä¢ ${f.type||"‚Äî"} ${f.bytes?("‚Ä¢ "+prettyBytes(f.bytes)):""}`;
      $("btnModalOpen").href = f.url;

      const box = $("previewBox");
      box.innerHTML = "";

      if(f.type === "image"){
        const img = document.createElement("img");
        img.src = f.url;
        img.alt = f.name || "";
        img.addEventListener("error", ()=>{
          box.innerHTML = `<div style="padding:18px;text-align:center;color:var(--muted2)">N√£o foi poss√≠vel carregar a imagem.</div>`;
        }, { once:true });
        box.appendChild(img);
      }else if(f.type === "video"){
        const v = document.createElement("video");
        v.src = f.url;
        v.controls = true;
        v.playsInline = true;
        box.appendChild(v);
      }else{
        // PDF tenta iframe, sen√£o mostra link
        const iframe = document.createElement("iframe");
        iframe.src = f.url;
        iframe.referrerPolicy = "no-referrer";
        iframe.addEventListener("error", ()=>{
          box.innerHTML = `<div style="padding:18px;text-align:center;color:var(--muted2)">Preview indispon√≠vel. Use "Abrir".</div>`;
        }, { once:true });
        box.appendChild(iframe);
      }

      modal.style.display = "flex";
    }

    function closeModal(){
      modal.style.display = "none";
      $("previewBox").innerHTML = "";
      selectedFile = null;
    }
  </script>
</body>
</html>
