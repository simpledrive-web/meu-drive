<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b57d0" />
  <title>Meu Drive</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon-192.png" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    :root{
      --bg1:#071022;
      --bg2:#0b2a66;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --brand:#4f7cf0;
      --brand2:#2dd4bf;
      --danger:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    /* Fix geral pro ‚Äúlist√£o branco‚Äù no Chrome/Android */
    html { color-scheme: dark; }
    select, option { color-scheme: dark; }

    body{
      margin:0;
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 30% 20%, rgba(79,124,240,.35), transparent 60%),
        radial-gradient(900px 600px at 80% 60%, rgba(45,212,191,.22), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{
      width:min(1180px, 92vw);
      margin: 26px auto 40px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .appIcon{
      width:48px; height:48px; border-radius:14px;
      overflow:hidden;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
    }
    .appIcon img{ width:100%; height:100%; object-fit:cover; display:block; }

    .titleWrap{ min-width:0; }
    h1{
      font-size:28px;
      margin:0;
      letter-spacing:.2px;
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .subtitle{
      margin:4px 0 0;
      color:var(--muted);
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 65vw;
    }

    .userChip{
      display:none;
      align-items:center;
      gap:10px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:8px 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      max-width: 48%;
    }
    .avatar{
      width:34px; height:34px; border-radius:999px;
      background: linear-gradient(135deg, rgba(79,124,240,.9), rgba(45,212,191,.9));
      display:grid; place-items:center;
      font-weight:900;
      flex:0 0 auto;
    }
    .userMeta{ min-width:0; }
    .userName{
      font-size:13px; font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .userEmail{
      font-size:12px; color:var(--muted2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* Layout principal: esquerda (upload+sess√£o) / direita (arquivos) */
    .mainGrid{
      display:grid;
      gap:16px;
      grid-template-columns: 1fr;
    }

    .leftCol, .rightCol{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    @media (min-width: 980px){
      .mainGrid{ grid-template-columns: 420px 1fr; align-items:start; }
    }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead b{ font-size:14px; }
    .cardBody{ padding:14px 16px; }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .field{
      flex:1 1 220px;
      min-width: 180px;
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,18,32,.55);
      color: var(--txt);
      outline:none;
      font-size:14px;
    }

    input::placeholder{ color: rgba(255,255,255,.45); }

    /* Dropdown com apar√™ncia dark */
    select{
      appearance:none;
      -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.75) 50%),
        linear-gradient(135deg, rgba(255,255,255,.75) 50%, transparent 50%),
        linear-gradient(to right, rgba(255,255,255,.10), rgba(255,255,255,.10));
      background-position:
        calc(100% - 18px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px),
        calc(100% - 38px) 50%;
      background-size: 6px 6px, 6px 6px, 1px 18px;
      background-repeat:no-repeat;
      padding-right: 44px;
    }

    option{
      background-color: #0b1220;
      color: #fff;
    }

    .btn{
      border:0;
      border-radius:16px;
      padding:12px 16px;
      font-weight:900;
      cursor:pointer;
      background: rgba(255,255,255,.10);
      color: var(--txt);
      border:1px solid rgba(255,255,255,.14);
      transition: transform .06s ease, filter .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(79,124,240,.95), rgba(79,124,240,.65));
      border-color: rgba(79,124,240,.55);
    }
    .btnDanger{
      background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(239,68,68,.55));
      border-color: rgba(239,68,68,.55);
    }
    .btnSmall{
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      font-weight:900;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }

    .tabs{
      display:flex;
      gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px;
      border-radius:999px;
      width: fit-content;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      border:1px solid transparent;
      color: rgba(255,255,255,.75);
      background: transparent;
    }
    .tab.active{
      background: rgba(79,124,240,.35);
      border-color: rgba(79,124,240,.45);
      color: var(--txt);
    }

    /* Lista de arquivos */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }

    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }

    .left{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }

    .badge{
      width:38px; height:38px;
      border-radius:14px;
      display:grid; place-items:center;
      background: rgba(79,124,240,.22);
      border:1px solid rgba(79,124,240,.25);
      flex:0 0 auto;
      font-weight:900;
    }

    .meta{ min-width:0; }
    .name{
      font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 64vw;
    }
    .sub{
      font-size:12px;
      color: var(--muted2);
      margin-top:2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 64vw;
    }

    @media(min-width: 980px){
      .name{ max-width: 520px; }
      .sub{ max-width: 520px; }
    }

    .right{
      display:flex; gap:8px; flex:0 0 auto; align-items:center;
    }

    .empty{
      margin-top:12px;
      color: var(--muted2);
      text-align:center;
      padding:18px 10px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
    }

    /* Galeria */
    .gallery{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
      margin-top:12px;
    }
    @media(min-width: 720px){
      .gallery{ grid-template-columns: repeat(3, 1fr); }
    }
    @media(min-width: 1060px){
      .gallery{ grid-template-columns: repeat(4, 1fr); }
    }
    .thumb{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      min-height: 160px;
    }
    .thumbTop{
      flex:1;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.15);
      position:relative;
    }
    .thumbTop img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumbTop .fileIcon{
      font-size:34px;
      opacity:.9;
    }
    .thumbBottom{
      padding:10px 10px 12px;
    }
    .thumbName{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .thumbSub{
      margin-top:4px;
      font-size:12px;
      color:var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Views + anima√ß√£o */
    .view{
      transition: opacity .25s ease, transform .25s ease;
    }
    .hide{
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      height:0;
      overflow:hidden;
    }

    /* Loader overlay */
    .loaderOverlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(2,8,18,.60);
      backdrop-filter: blur(8px);
      z-index:9999;
    }
    .spinner{
      width:56px; height:56px;
      border-radius:50%;
      border: 5px solid rgba(255,255,255,.18);
      border-top-color: rgba(79,124,240,.95);
      animation: spin .9s linear infinite;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* Modal preview */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9998;
      padding: 18px;
    }
    .modalCard{
      width:min(980px, 94vw);
      max-height: 86vh;
      background: rgba(10,18,32,.86);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .modalTitle{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modalBody{
      padding: 12px;
      overflow:auto;
      display:grid;
      place-items:center;
      min-height: 40vh;
    }
    .modalBody img, .modalBody video{
      max-width: 100%;
      max-height: 70vh;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
    }
    .modalBody iframe{
      width: 100%;
      height: 70vh;
      border:0;
      border-radius: 16px;
      background: rgba(0,0,0,.25);
    }
    .mutedNote{
      font-size:12px;
      color: var(--muted2);
      margin-top:8px;
      text-align:center;
    }
  </style>
</head>

<body>
  <!-- Loader -->
  <div id="loaderOverlay" class="loaderOverlay" aria-hidden="true">
    <div class="spinner" aria-label="Carregando"></div>
  </div>

  <!-- Modal Preview -->
  <div id="previewModal" class="modal" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalHead">
        <div class="modalTitle" id="previewTitle">Preview</div>
        <div class="row" style="gap:8px;">
          <a id="previewOpenNew" class="btn btnSmall" href="#" target="_blank" rel="noopener">Abrir em nova aba</a>
          <button id="previewClose" class="btn btnSmall">Fechar</button>
        </div>
      </div>
      <div class="modalBody" id="previewBody"></div>
    </div>
  </div>

  <div class="wrap">
    <!-- Top -->
    <div class="topbar">
      <div class="brand">
        <div class="appIcon">
          <img src="./icon-192.png" alt="Meu Drive">
        </div>
        <div class="titleWrap">
          <h1>Meu Drive ‚òÅÔ∏è</h1>
          <div class="subtitle">Seus arquivos em um s√≥ lugar.</div>
        </div>
      </div>

      <div id="userChip" class="userChip">
        <div id="avatar" class="avatar">U</div>
        <div class="userMeta">
          <div id="userName" class="userName">Usu√°rio</div>
          <div id="userEmail" class="userEmail">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- LOGIN VIEW -->
    <div id="loginView" class="view card">
      <div class="cardHead">
        <b>Entrar / Criar conta</b>
      </div>
      <div class="cardBody">
        <div class="row">
          <div class="field">
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="seuemail@gmail.com" autocomplete="email" />
          </div>
          <div class="field">
            <label for="password">Senha</label>
            <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="btnLogin" class="btn btnPrimary">Entrar</button>
          <button id="btnRegister" class="btn">Criar conta</button>
        </div>

        <div class="mutedNote" style="margin-top:12px;">
          Dica: cada usu√°rio v√™ s√≥ os pr√≥prios arquivos.
        </div>
      </div>
    </div>

    <!-- APP VIEW -->
    <div id="appView" class="view hide">
      <div class="mainGrid">
        <!-- Left column -->
        <div class="leftCol">
          <!-- Sess√£o -->
          <div class="card">
            <div class="cardHead">
              <b>Sess√£o</b>
              <button id="btnLogout" class="btn btnSmall btnDanger">Sair</button>
            </div>
            <div class="cardBody">
              <div style="color:var(--muted); font-size:12px;">Logado como:</div>
              <div id="sessionEmail" style="margin-top:6px; font-weight:900; word-break:break-word;">‚Äî</div>
            </div>
          </div>

          <!-- Upload -->
          <div class="card">
            <div class="cardHead">
              <b>Upload</b>
              <div style="font-size:12px;color:var(--muted)">Cloudinary + Firestore</div>
            </div>
            <div class="cardBody">
              <div class="row">
                <div class="field" style="flex: 1 1 100%;">
                  <label for="fileInput">Arquivo</label>
                  <input id="fileInput" type="file" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="field">
                  <label for="folderSelect">Pasta</label>
                  <select id="folderSelect">
                    <option value="Imagens">Imagens</option>
                    <option value="V√≠deos">V√≠deos</option>
                    <option value="PDFs">PDFs</option>
                    <option value="Outros">Outros</option>
                  </select>
                </div>

                <div class="field">
                  <label for="newFolder">Criar pasta</label>
                  <div class="row" style="flex-wrap:nowrap;">
                    <input id="newFolder" type="text" placeholder="Ex: Trabalho" />
                    <button id="btnAddFolder" class="btn btnSmall">Adicionar</button>
                  </div>
                </div>
              </div>

              <div class="row" style="margin-top:12px;">
                <button id="btnUpload" class="btn btnPrimary">Enviar arquivo</button>
                <span id="uploadStatus" style="color:var(--muted); font-size:13px;"></span>
              </div>

              <div class="mutedNote" style="margin-top:10px;">
                Obs: arquivos ficam organizados no Cloudinary por usu√°rio/pasta.
              </div>
            </div>
          </div>

          <!-- Filtros -->
          <div class="card">
            <div class="cardHead">
              <b>Filtros</b>
            </div>
            <div class="cardBody">
              <div class="row">
                <div class="field">
                  <label for="searchInput">Buscar por nome</label>
                  <input id="searchInput" type="text" placeholder="Ex: contrato, foto, video..." />
                </div>
                <div class="field">
                  <label for="filterType">Filtrar por</label>
                  <select id="filterType">
                    <option value="all">Todos</option>
                    <option value="image">Imagens</option>
                    <option value="video">V√≠deos</option>
                    <option value="pdf">PDFs</option>
                    <option value="other">Outros</option>
                  </select>
                </div>
                <div class="field">
                  <label for="filterFolder">Pasta</label>
                  <select id="filterFolder">
                    <option value="all">Todas</option>
                  </select>
                </div>
              </div>

              <div class="row" style="margin-top:10px; justify-content:space-between;">
                <div class="tabs">
                  <button id="tabList" class="tab active" type="button">Lista</button>
                  <button id="tabGallery" class="tab" type="button">Galeria</button>
                </div>
                <button id="btnRefresh" class="btn btnSmall">Atualizar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Right column -->
        <div class="rightCol">
          <div class="card">
            <div class="cardHead">
              <b>Arquivos</b>
              <div style="font-size:12px;color:var(--muted)">
                <span id="countLabel">0</span> itens
              </div>
            </div>
            <div class="cardBody">
              <div id="listView" class="list"></div>
              <div id="galleryView" class="gallery" style="display:none;"></div>
              <div id="emptyState" class="empty" style="display:none;">Nenhum arquivo ainda.</div>
            </div>
            
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat (ordem correta) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- ‚úÖ CONFIG DEFINIDA (isso resolve o erro FIREBASE_CONFIG is not defined) -->
  <script>
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAYAwMfCDcXALBVM1uemmJA4aWQK5MNcc0",
      authDomain: "meu-drive-beb33.firebaseapp.com",
      projectId: "meu-drive-beb33",
      storageBucket: "meu-drive-beb33.firebasestorage.app",
      messagingSenderId: "661176300748",
      appId: "1:661176300748:web:68ab970ae9e668fdb67e69"
    };

    // Cloudinary (unsigned)
    const CLOUDINARY_CLOUD = "dilyddwkg";
    const CLOUDINARY_PRESET = "kv9sjt0g";
  </script>

  <script>
    // Init Firebase
    firebase.initializeApp(FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM
    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");

    const loaderOverlay = document.getElementById("loaderOverlay");

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const btnLogin = document.getElementById("btnLogin");
    const btnRegister = document.getElementById("btnRegister");

    const userChip = document.getElementById("userChip");
    const avatarEl = document.getElementById("avatar");
    const userNameEl = document.getElementById("userName");
    const userEmailEl = document.getElementById("userEmail");
    const sessionEmail = document.getElementById("sessionEmail");
    const btnLogout = document.getElementById("btnLogout");

    const fileInput = document.getElementById("fileInput");
    const folderSelect = document.getElementById("folderSelect");
    const newFolder = document.getElementById("newFolder");
    const btnAddFolder = document.getElementById("btnAddFolder");
    const btnUpload = document.getElementById("btnUpload");
    const uploadStatus = document.getElementById("uploadStatus");

    const searchInput = document.getElementById("searchInput");
    const filterType = document.getElementById("filterType");
    const filterFolder = document.getElementById("filterFolder");
    const btnRefresh = document.getElementById("btnRefresh");

    const tabList = document.getElementById("tabList");
    const tabGallery = document.getElementById("tabGallery");

    const listView = document.getElementById("listView");
    const galleryView = document.getElementById("galleryView");
    const emptyState = document.getElementById("emptyState");
    const countLabel = document.getElementById("countLabel");

    // Modal
    const previewModal = document.getElementById("previewModal");
    const previewTitle = document.getElementById("previewTitle");
    const previewBody = document.getElementById("previewBody");
    const previewClose = document.getElementById("previewClose");
    const previewOpenNew = document.getElementById("previewOpenNew");

    // State
    let currentUser = null;
    let allFiles = [];
    let currentMode = "list"; // list | gallery

    // Helpers
    function showLoader(msg){
      loaderOverlay.style.display = "flex";
      loaderOverlay.setAttribute("aria-hidden", "false");
      uploadStatus.textContent = msg || "";
    }
    function hideLoader(){
      loaderOverlay.style.display = "none";
      loaderOverlay.setAttribute("aria-hidden", "true");
      uploadStatus.textContent = "";
    }

    function toast(msg){
      alert(msg);
    }

    function setView(isLogged){
      if(isLogged){
        loginView.classList.add("hide");
        appView.classList.remove("hide");
        userChip.style.display = "flex";
      } else {
        appView.classList.add("hide");
        loginView.classList.remove("hide");
        userChip.style.display = "none";
      }
    }

    function getInitials(email){
      if(!email) return "U";
      return email.trim().charAt(0).toUpperCase();
    }

    function niceType(mime){
      if(!mime) return "other";
      if(mime.startsWith("image/")) return "image";
      if(mime.startsWith("video/")) return "video";
      if(mime === "application/pdf") return "pdf";
      return "other";
    }

    function typeBadge(t){
      if(t==="image") return "üñºÔ∏è";
      if(t==="video") return "üé¨";
      if(t==="pdf") return "üìÑ";
      return "üì¶";
    }

    function bytesToSize(bytes){
      if(!bytes && bytes !== 0) return "";
      const sizes = ["B","KB","MB","GB"];
      let i = 0;
      let v = bytes;
      while(v >= 1024 && i < sizes.length-1){ v/=1024; i++; }
      return `${v.toFixed(v >= 10 || i===0 ? 0 : 1)} ${sizes[i]}`;
    }

    function formatDate(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
        if(!d) return "";
        return d.toLocaleString("pt-BR");
      }catch{ return ""; }
    }

    function closePreview(){
      previewModal.style.display = "none";
      previewBody.innerHTML = "";
      previewOpenNew.href = "#";
    }

    function openPreview(file){
      previewTitle.textContent = file.name || "Preview";
      previewOpenNew.href = file.url || "#";
      previewBody.innerHTML = "";

      const t = file.type;
      if(t === "image"){
        const img = document.createElement("img");
        img.src = file.url;
        img.alt = file.name || "Imagem";
        previewBody.appendChild(img);
      } else if(t === "video"){
        const video = document.createElement("video");
        video.src = file.url;
        video.controls = true;
        video.playsInline = true;
        previewBody.appendChild(video);
      } else if(t === "pdf"){
        const iframe = document.createElement("iframe");
        iframe.src = file.url;
        previewBody.appendChild(iframe);
      } else {
        const box = document.createElement("div");
        box.style.textAlign = "center";
        box.innerHTML = `
          <div style="font-size:54px;margin-bottom:10px;">${typeBadge(t)}</div>
          <div style="font-weight:900;font-size:16px;">${file.name || "Arquivo"}</div>
          <div class="mutedNote">Sem preview nativo. Use ‚ÄúAbrir em nova aba‚Äù.</div>
        `;
        previewBody.appendChild(box);
      }

      previewModal.style.display = "flex";
    }

    previewClose.addEventListener("click", closePreview);
    previewModal.addEventListener("click", (e) => {
      if(e.target === previewModal) closePreview();
    });

    // Folders (para filtros)
    function refreshFolderFilter(){
      const unique = Array.from(new Set(allFiles.map(f => f.folder || "Outros"))).sort();
      const current = filterFolder.value || "all";
      filterFolder.innerHTML = `<option value="all">Todas</option>` + unique.map(f => `<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join("");
      // tenta manter
      const exists = Array.from(filterFolder.options).some(o => o.value === current);
      filterFolder.value = exists ? current : "all";
    }

    function escapeHtml(str){
      return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
    }

    function applyFilters(){
      const q = (searchInput.value || "").trim().toLowerCase();
      const t = filterType.value;
      const f = filterFolder.value;

      let filtered = allFiles.slice();

      if(q){
        filtered = filtered.filter(x => (x.name||"").toLowerCase().includes(q));
      }
      if(t !== "all"){
        filtered = filtered.filter(x => x.type === t);
      }
      if(f !== "all"){
        filtered = filtered.filter(x => (x.folder || "Outros") === f);
      }

      renderFiles(filtered);
    }

    function renderFiles(files){
      countLabel.textContent = String(files.length);

      // empty state
      emptyState.style.display = files.length ? "none" : "block";

      // list
      listView.innerHTML = "";
      galleryView.innerHTML = "";

      if(currentMode === "list"){
        listView.style.display = "flex";
        galleryView.style.display = "none";
        files.forEach(file => listView.appendChild(renderListItem(file)));
      } else {
        listView.style.display = "none";
        galleryView.style.display = "grid";
        files.forEach(file => galleryView.appendChild(renderThumb(file)));
      }
    }

    function renderListItem(file){
      const item = document.createElement("div");
      item.className = "item";

      const left = document.createElement("div");
      left.className = "left";

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = typeBadge(file.type);

      const meta = document.createElement("div");
      meta.className = "meta";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = file.name || "Arquivo";

      const sub = document.createElement("div");
      sub.className = "sub";
      const parts = [
        file.folder ? `üìÅ ${file.folder}` : null,
        file.size ? `üì¶ ${bytesToSize(file.size)}` : null,
        file.createdAt ? `üïí ${formatDate(file.createdAt)}` : null
      ].filter(Boolean);
      sub.textContent = parts.join(" ‚Ä¢ ");

      meta.appendChild(name);
      meta.appendChild(sub);

      left.appendChild(badge);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.className = "right";

      const btnPreview = document.createElement("button");
      btnPreview.className = "btn btnSmall";
      btnPreview.textContent = "Ver";
      btnPreview.addEventListener("click", () => openPreview(file));

      const btnDelete = document.createElement("button");
      btnDelete.className = "btn btnSmall btnDanger";
      btnDelete.textContent = "Excluir";
      btnDelete.addEventListener("click", () => deleteFile(file));

      right.appendChild(btnPreview);
      right.appendChild(btnDelete);

      item.appendChild(left);
      item.appendChild(right);

      return item;
    }

    function renderThumb(file){
      const thumb = document.createElement("div");
      thumb.className = "thumb";
      thumb.addEventListener("click", () => openPreview(file));

      const top = document.createElement("div");
      top.className = "thumbTop";

      if(file.type === "image"){
        const img = document.createElement("img");
        img.src = file.url;
        img.alt = file.name || "Imagem";
        top.appendChild(img);
      } else {
        const icon = document.createElement("div");
        icon.className = "fileIcon";
        icon.textContent = typeBadge(file.type);
        top.appendChild(icon);
      }

      const bottom = document.createElement("div");
      bottom.className = "thumbBottom";

      const n = document.createElement("div");
      n.className = "thumbName";
      n.textContent = file.name || "Arquivo";

      const s = document.createElement("div");
      s.className = "thumbSub";
      s.textContent = `${file.folder ? file.folder : "Outros"} ‚Ä¢ ${bytesToSize(file.size || 0)}`;

      bottom.appendChild(n);
      bottom.appendChild(s);

      thumb.appendChild(top);
      thumb.appendChild(bottom);

      return thumb;
    }

    // Firestore paths
    function filesCol(){
      return db.collection("files");
    }

    async function loadFiles(){
      if(!currentUser) return;

      showLoader("Carregando arquivos...");
      try{
        const snap = await filesCol()
          .where("uid","==", currentUser.uid)
          .orderBy("createdAt","desc")
          .get();

        allFiles = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        refreshFolderFilter();
        applyFilters();
      }catch(err){
        console.error(err);
        toast("Erro ao carregar arquivos.");
      } finally {
        hideLoader();
      }
    }

    async function deleteFile(file){
      if(!currentUser) return;
      const ok = confirm(`Excluir "${file.name}"?`);
      if(!ok) return;

      showLoader("Excluindo...");
      try{
        await filesCol().doc(file.id).delete();
        // Atualiza local
        allFiles = allFiles.filter(x => x.id !== file.id);
        refreshFolderFilter();
        applyFilters();

        // Aviso sobre Cloudinary
        if(file.public_id){
          // n√£o bloqueia, s√≥ informa
          console.log("public_id (Cloudinary):", file.public_id);
        }
      }catch(err){
        console.error(err);
        toast("Erro ao excluir.");
      } finally {
        hideLoader();
      }
    }

    // Upload Cloudinary
    async function uploadToCloudinary(file, folderName){
      const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/auto/upload`;
      const form = new FormData();
      form.append("file", file);
      form.append("upload_preset", CLOUDINARY_PRESET);

      // organiza√ß√£o por user/pasta
      const cloudFolder = `${currentUser.uid}/${folderName || "Outros"}`;
      form.append("folder", cloudFolder);

      const res = await fetch(url, { method:"POST", body: form });
      const data = await res.json();
      if(!res.ok){
        console.error("Cloudinary error:", data);
        throw new Error(data?.error?.message || "Erro no Cloudinary");
      }
      return data; // secure_url, public_id, bytes, format, resource_type...
    }

    async function doUpload(){
      if(!currentUser) return;

      const f = fileInput.files?.[0];
      if(!f){
        toast("Escolha um arquivo primeiro.");
        return;
      }

      const folderName = folderSelect.value || "Outros";

      btnUpload.disabled = true;
      showLoader("Enviando arquivo...");
      uploadStatus.textContent = "Enviando...";

      try{
        const cloud = await uploadToCloudinary(f, folderName);

        const record = {
          uid: currentUser.uid,
          name: f.name,
          folder: folderName,
          type: niceType(f.type),
          mime: f.type || "",
          size: cloud.bytes ?? f.size ?? 0,
          url: cloud.secure_url || cloud.url,
          public_id: cloud.public_id || "",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await filesCol().add(record);

        fileInput.value = "";
        uploadStatus.textContent = "Upload conclu√≠do ‚úÖ";
        await loadFiles();
      }catch(err){
        console.error(err);
        toast(`Erro no upload: ${err.message || err}`);
      } finally {
        btnUpload.disabled = false;
        hideLoader();
      }
    }

    // Auth
    btnLogin.addEventListener("click", async () => {
      const email = (emailEl.value || "").trim();
      const pass = passEl.value || "";
      if(!email || !pass) return toast("Preencha email e senha.");

      showLoader("Entrando...");
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        // onAuthStateChanged cuida do resto
      }catch(err){
        console.error(err);
        toast(err?.message || "Erro ao entrar.");
      } finally {
        hideLoader();
      }
    });

    btnRegister.addEventListener("click", async () => {
      const email = (emailEl.value || "").trim();
      const pass = passEl.value || "";
      if(!email || !pass) return toast("Preencha email e senha.");

      showLoader("Criando conta...");
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
      }catch(err){
        console.error(err);
        toast(err?.message || "Erro ao criar conta.");
      } finally {
        hideLoader();
      }
    });

    btnLogout.addEventListener("click", async () => {
      showLoader("Saindo...");
      try{
        await auth.signOut();
      }catch(err){
        console.error(err);
        toast("Erro ao sair.");
      } finally {
        hideLoader();
      }
    });

    // Tabs
    tabList.addEventListener("click", () => {
      currentMode = "list";
      tabList.classList.add("active");
      tabGallery.classList.remove("active");
      applyFilters();
    });
    tabGallery.addEventListener("click", () => {
      currentMode = "gallery";
      tabGallery.classList.add("active");
      tabList.classList.remove("active");
      applyFilters();
    });

    // Filters
    searchInput.addEventListener("input", applyFilters);
    filterType.addEventListener("change", applyFilters);
    filterFolder.addEventListener("change", applyFilters);
    btnRefresh.addEventListener("click", loadFiles);

    // Folder add
    btnAddFolder.addEventListener("click", () => {
      const v = (newFolder.value || "").trim();
      if(!v) return;
      const exists = Array.from(folderSelect.options).some(o => o.value.toLowerCase() === v.toLowerCase());
      if(exists){
        newFolder.value = "";
        return toast("Essa pasta j√° existe.");
      }
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      folderSelect.appendChild(opt);
      folderSelect.value = v;
      newFolder.value = "";
      toast("Pasta adicionada ‚úÖ");
    });

    btnUpload.addEventListener("click", doUpload);

    // Auth state (evita bolinha infinita)
    auth.onAuthStateChanged(async (user) => {
      showLoader("Validando sess√£o...");
      try{
        currentUser = user || null;

        if(currentUser){
          const email = currentUser.email || "‚Äî";
          setView(true);

          sessionEmail.textContent = email;
          userEmailEl.textContent = email;
          userNameEl.textContent = (email.split("@")[0] || "Usu√°rio");
          avatarEl.textContent = getInitials(email);

          await loadFiles();
        } else {
          setView(false);
          allFiles = [];
          listView.innerHTML = "";
          galleryView.innerHTML = "";
          emptyState.style.display = "none";
        }
      } finally {
        hideLoader();
      }
    });

    // Service Worker
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("./service-worker.js").catch(console.warn);
    }
  </script>
</body>
</html>
