<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b57d0" />
  <title>Meu Drive</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon-192.png" />

  <style>
    :root{
      --bg1:#071022;
      --bg2:#0b2a66;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --brand:#4f7cf0;
      --brand2:#2dd4bf;
      --danger:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 30% 20%, rgba(79,124,240,.35), transparent 60%),
        radial-gradient(900px 600px at 80% 60%, rgba(45,212,191,.22), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Fix geral pro ‚Äúlist√£o branco‚Äù no Chrome/Android (melhor esfor√ßo) */
    html { color-scheme: dark; }
    select, option { color-scheme: dark; }

    .wrap{
      width:min(1120px, 92vw);
      margin: 26px auto 40px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .appIcon{
      width:48px; height:48px; border-radius:14px;
      overflow:hidden;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
    }
    .appIcon img{ width:100%; height:100%; object-fit:cover; display:block; }

    .titleWrap{ min-width:0; }
    h1{
      font-size:28px;
      margin:0;
      letter-spacing:.2px;
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .subtitle{
      margin:4px 0 0;
      color:var(--muted);
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .userChip{
      display:none;
      align-items:center;
      gap:10px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:8px 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      max-width: 48%;
    }
    .avatar{
      width:34px; height:34px; border-radius:999px;
      background: linear-gradient(135deg, rgba(79,124,240,.9), rgba(45,212,191,.9));
      display:grid; place-items:center;
      font-weight:900;
      flex:0 0 auto;
      text-transform:uppercase;
    }
    .userMeta{ min-width:0; }
    .userName{
      font-size:13px; font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .userEmail{
      font-size:12px; color:var(--muted2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* GRID: mobile 1 coluna, desktop esquerda + direita */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }

    .leftCol, .rightCol{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    @media (min-width: 980px){
      .grid{
        grid-template-columns: 420px 1fr;
        align-items:start;
      }
      .leftCol{
        position: sticky;
        top: 18px;
        align-self:start;
      }
      .userChip{ max-width: 44%; }
    }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead b{ font-size:14px; }
    .cardBody{ padding:14px 16px; }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .field{
      flex:1 1 220px;
      min-width: 180px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,18,32,.55);
      color: var(--txt);
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color: rgba(255,255,255,.45); }

    select{
      appearance:none;
      -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.75) 50%),
        linear-gradient(135deg, rgba(255,255,255,.75) 50%, transparent 50%),
        linear-gradient(to right, rgba(255,255,255,.10), rgba(255,255,255,.10));
      background-position:
        calc(100% - 18px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px),
        calc(100% - 38px) 50%;
      background-size: 6px 6px, 6px 6px, 1px 18px;
      background-repeat:no-repeat;
      padding-right: 44px;
    }
    option{
      background-color: #0b1220;
      color: #fff;
    }

    .btn{
      border:0;
      border-radius:16px;
      padding:12px 16px;
      font-weight:900;
      cursor:pointer;
      background: rgba(255,255,255,.10);
      color: var(--txt);
      border:1px solid rgba(255,255,255,.14);
      transition: transform .06s ease, filter .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(79,124,240,.95), rgba(79,124,240,.65));
      border-color: rgba(79,124,240,.55);
    }
    .btnDanger{
      background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(239,68,68,.55));
      border-color: rgba(239,68,68,.55);
    }
    .btnSmall{
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      font-weight:900;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btnWide{ width:100%; }

    .tabs{
      display:flex;
      gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px;
      border-radius:999px;
      width: fit-content;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      border:1px solid transparent;
      color: rgba(255,255,255,.75);
      background: transparent;
    }
    .tab.active{
      background: rgba(79,124,240,.35);
      border-color: rgba(79,124,240,.45);
      color: var(--txt);
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }

    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .left{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .badge{
      width:38px; height:38px;
      border-radius:14px;
      display:grid; place-items:center;
      background: rgba(79,124,240,.22);
      border:1px solid rgba(79,124,240,.25);
      flex:0 0 auto;
      font-weight:900;
    }
    .meta{ min-width:0; }
    .name{
      font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 52vw;
    }
    .sub{
      font-size:12px;
      color: var(--muted2);
      margin-top:2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 52vw;
    }

    .right{ display:flex; gap:8px; flex:0 0 auto; }

    .empty{
      margin-top:12px;
      color: var(--muted2);
      text-align:center;
      padding:18px 10px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
    }

    /* Galeria */
    .gallery{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (min-width: 720px){
      .gallery{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .gItem{
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      cursor:pointer;
      transition: transform .08s ease;
    }
    .gItem:active{ transform: scale(.99); }
    .gThumb{
      width:100%;
      aspect-ratio: 1 / 1;
      display:block;
      object-fit:cover;
      background: rgba(0,0,0,.25);
    }
    .gMeta{
      padding:10px;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Views + anima√ß√£o */
    .view{
      transition: opacity .25s ease, transform .25s ease;
    }
    .hide{
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      height:0;
      overflow:hidden;
    }

    /* Loader overlay */
    .loaderOverlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(2,8,18,.60);
      backdrop-filter: blur(8px);
      z-index:9999;
    }
    .spinner{
      width:56px; height:56px;
      border-radius:50%;
      border: 5px solid rgba(255,255,255,.18);
      border-top-color: rgba(79,124,240,.95);
      animation: spin .9s linear infinite;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* Modal preview */
    .modal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(2,8,18,.72);
      backdrop-filter: blur(10px);
      z-index: 99999;
      padding: 18px;
    }
    .modalCard{
      width: min(980px, 96vw);
      max-height: 88vh;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .modalTitle{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modalBody{
      padding: 14px;
      overflow:auto;
      display:grid;
      place-items:center;
      gap:12px;
      background: rgba(0,0,0,.14);
    }
    .modalBody img, .modalBody video{
      max-width: 100%;
      max-height: 70vh;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
    }
    .modalBody iframe{
      width: 100%;
      height: 70vh;
      border:0;
      border-radius: 16px;
      background: #0b1220;
      border:1px solid rgba(255,255,255,.14);
    }
    .modalFoot{
      padding: 12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    @media (min-width: 860px){
      .name{ max-width: 360px; }
      .sub{ max-width: 360px; }
    }
  </style>
</head>

<body>
  <!-- Loader -->
  <div id="loader" class="loaderOverlay" aria-hidden="true">
    <div class="spinner"></div>
  </div>

  <!-- Modal Preview -->
  <div id="previewModal" class="modal" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalHead">
        <div id="previewTitle" class="modalTitle">Preview</div>
        <button id="btnClosePreview" class="btn btnSmall">Fechar</button>
      </div>
      <div id="previewBody" class="modalBody"></div>
      <div class="modalFoot">
        <a id="previewOpenNew" class="btn btnSmall" href="#" target="_blank" rel="noopener">Abrir em nova aba</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="appIcon"><img src="./icon-192.png" alt="Meu Drive"></div>
        <div class="titleWrap">
          <h1>Meu Drive <span style="opacity:.9">‚òÅÔ∏è</span></h1>
          <div class="subtitle">Seus arquivos em um s√≥ lugar.</div>
        </div>
      </div>

      <div id="userChip" class="userChip">
        <div id="avatar" class="avatar">?</div>
        <div class="userMeta">
          <div id="userName" class="userName">Conectado</div>
          <div id="userEmail" class="userEmail">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- LOGIN VIEW -->
    <div id="loginView" class="view card">
      <div class="cardHead"><b>Entrar</b></div>
      <div class="cardBody">
        <div class="row">
          <div class="field">
            <label>Email</label>
            <input id="email" type="email" placeholder="seuemail@gmail.com" autocomplete="email" />
          </div>
          <div class="field">
            <label>Senha</label>
            <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="btnLogin" class="btn btnPrimary">Entrar</button>
          <button id="btnRegister" class="btn">Criar conta</button>
        </div>
      </div>
    </div>

    <!-- APP VIEW -->
    <div id="appView" class="view hide">
      <div class="grid">
        <!-- LEFT -->
        <div class="leftCol">
          <div class="card">
            <div class="cardHead">
              <b>Sess√£o</b>
              <button id="btnLogout" class="btn btnSmall btnDanger">Sair</button>
            </div>
            <div class="cardBody">
              <div style="color:var(--muted); font-size:13px;">
                Voc√™ est√° conectado ‚úÖ
              </div>
            </div>
          </div>

          <div class="card">
            <div class="cardHead"><b>Upload</b></div>
            <div class="cardBody">
              <div class="row">
                <div class="field">
                  <label>Arquivo</label>
                  <input id="fileInput" type="file" />
                </div>
              </div>

              <div class="row" style="margin-top:12px;">
                <div class="field">
                  <label>Pasta</label>
                  <select id="folderSelect"></select>
                </div>
                <div class="field">
                  <label>Criar pasta</label>
                  <div class="row" style="flex-wrap:nowrap;">
                    <input id="newFolder" placeholder="Ex: Contratos" />
                    <button id="btnAddFolder" class="btn btnSmall">Adicionar</button>
                  </div>
                </div>
              </div>

              <div class="row" style="margin-top:12px;">
                <button id="btnUpload" class="btn btnPrimary btnWide">Enviar arquivo</button>
              </div>

              <div style="margin-top:10px; color:var(--muted2); font-size:12px;">
                Upload: Cloudinary + Firestore
              </div>
            </div>
          </div>

          <div class="card">
            <div class="cardHead"><b>Filtros</b></div>
            <div class="cardBody">
              <div class="row">
                <div class="field">
                  <label>Buscar por nome</label>
                  <input id="searchInput" placeholder="Ex: contrato, foto, v√≠deo..." />
                </div>
                <div class="field">
                  <label>Filtrar por</label>
                  <select id="typeFilter">
                    <option value="all">Todos</option>
                    <option value="image">Imagens</option>
                    <option value="video">V√≠deos</option>
                    <option value="pdf">PDF</option>
                    <option value="other">Outros</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="rightCol">
          <div class="card">
            <div class="cardHead" style="gap:12px; flex-wrap:wrap;">
              <b>Arquivos</b>
              <div class="tabs">
                <button id="tabList" class="tab active">Lista</button>
                <button id="tabGallery" class="tab">Galeria</button>
              </div>
            </div>
            <div class="cardBody">
              <div id="listContainer" class="list"></div>
              <div id="galleryContainer" class="gallery" style="display:none;"></div>
              <div id="emptyState" class="empty" style="display:none;">Nenhum arquivo ainda.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /*****************************************************************
     * 1) COLE AQUI SUAS CONFIGS (sem expor em repo p√∫blico)
     *****************************************************************/

    // üî• Firebase config (cole a sua aqui)
  const firebaseConfig = {
  apiKey: "AIzaSyAYAwMfCDcXALBVM1uemmJA4aWQK5MNcc0",
  authDomain: "meu-drive-beb33.firebaseapp.com",
  projectId: "meu-drive-beb33",
  storageBucket: "meu-drive-beb33.firebasestorage.app",
  messagingSenderId: "661176300748",
  appId: "1:661176300748:web:68ab970ae9e668fdb67e69"
};

    // ‚òÅÔ∏è Cloudinary (cole aqui)
    const CLOUDINARY_CLOUD_NAME = "dilyddwkg";
    const CLOUDINARY_UPLOAD_PRESET = "kv9sjt0g";

    /*****************************************************************
     * 2) INIT
     *****************************************************************/
    firebase.initializeApp(FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const $ = (id) => document.getElementById(id);

    const loader = $("loader");
    const loginView = $("loginView");
    const appView = $("appView");

    const userChip = $("userChip");
    const avatar = $("avatar");
    const userName = $("userName");
    const userEmail = $("userEmail");

    const emailInput = $("email");
    const passwordInput = $("password");
    const btnLogin = $("btnLogin");
    const btnRegister = $("btnRegister");
    const btnLogout = $("btnLogout");

    const fileInput = $("fileInput");
    const folderSelect = $("folderSelect");
    const newFolder = $("newFolder");
    const btnAddFolder = $("btnAddFolder");
    const btnUpload = $("btnUpload");

    const tabList = $("tabList");
    const tabGallery = $("tabGallery");
    const listContainer = $("listContainer");
    const galleryContainer = $("galleryContainer");
    const emptyState = $("emptyState");

    const searchInput = $("searchInput");
    const typeFilter = $("typeFilter");

    const previewModal = $("previewModal");
    const previewTitle = $("previewTitle");
    const previewBody = $("previewBody");
    const previewOpenNew = $("previewOpenNew");
    const btnClosePreview = $("btnClosePreview");

    let currentUser = null;
    let filesCache = [];
    let currentTab = "list";

    const DEFAULT_FOLDERS = ["Imagens", "V√≠deos", "PDFs", "Outros"];

    function showLoader(on){
      loader.style.display = on ? "flex" : "none";
      loader.setAttribute("aria-hidden", on ? "false" : "true");
    }

    function showView(view){
      // Anima√ß√£o suave na troca
      if(view === "login"){
        loginView.classList.remove("hide");
        appView.classList.add("hide");
      } else {
        loginView.classList.add("hide");
        appView.classList.remove("hide");
      }
    }

    function setUserChip(user){
      if(!user){
        userChip.style.display = "none";
        return;
      }
      const email = user.email || "‚Äî";
      userChip.style.display = "flex";
      userEmail.textContent = email;

      // Avatar com inicial
      const initial = (email.trim()[0] || "?").toUpperCase();
      avatar.textContent = initial;
      userName.textContent = "Conectado";
    }

    function safeText(s){
      return (s || "").toString();
    }

    function guessTypeFromUrl(url){
      const u = (url || "").toLowerCase();
      if(u.includes(".pdf")) return "pdf";
      if(u.match(/\.(png|jpg|jpeg|gif|webp|bmp|svg)(\?|$)/)) return "image";
      if(u.match(/\.(mp4|webm|mov|mkv)(\?|$)/)) return "video";
      return "other";
    }

    function typeLabel(t){
      if(t === "image") return "IMG";
      if(t === "video") return "VID";
      if(t === "pdf") return "PDF";
      return "ARQ";
    }

    function normalizeFolder(name){
      return safeText(name).trim().replace(/\s+/g, " ").slice(0, 40);
    }

    function getUserRoot(){
      return db.collection("users").doc(currentUser.uid);
    }

    async function ensureFolders(){
      const docRef = getUserRoot().collection("meta").doc("folders");
      const snap = await docRef.get();
      if(!snap.exists){
        await docRef.set({ list: DEFAULT_FOLDERS, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        return DEFAULT_FOLDERS;
      }
      const data = snap.data() || {};
      const list = Array.isArray(data.list) ? data.list : DEFAULT_FOLDERS;
      return list.length ? list : DEFAULT_FOLDERS;
    }

    async function saveFolders(list){
      const docRef = getUserRoot().collection("meta").doc("folders");
      await docRef.set({ list, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    }

    function renderFolderSelect(folders){
      folderSelect.innerHTML = "";
      folders.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f;
        opt.textContent = f;
        folderSelect.appendChild(opt);
      });
    }

    function applyFilters(items){
      const q = safeText(searchInput.value).toLowerCase().trim();
      const tf = typeFilter.value;

      return items.filter(it => {
        const nameOk = !q || safeText(it.name).toLowerCase().includes(q);
        const type = it.type || guessTypeFromUrl(it.url);
        const typeOk = (tf === "all") || (tf === type);
        return nameOk && typeOk;
      });
    }

    function setTab(tab){
      currentTab = tab;
      const isList = tab === "list";
      tabList.classList.toggle("active", isList);
      tabGallery.classList.toggle("active", !isList);

      listContainer.style.display = isList ? "flex" : "none";
      galleryContainer.style.display = isList ? "none" : "grid";
      renderFiles();
    }

    function showEmptyIfNeeded(hasItems){
      emptyState.style.display = hasItems ? "none" : "block";
    }

    function openPreview(file){
      const url = file.url;
      const type = file.type || guessTypeFromUrl(url);

      previewTitle.textContent = file.name || "Preview";
      previewOpenNew.href = url;

      previewBody.innerHTML = "";

      if(type === "image"){
        const img = document.createElement("img");
        img.src = url;
        img.alt = file.name || "imagem";
        previewBody.appendChild(img);
      } else if(type === "video"){
        const v = document.createElement("video");
        v.src = url;
        v.controls = true;
        v.playsInline = true;
        previewBody.appendChild(v);
      } else if(type === "pdf"){
        const iframe = document.createElement("iframe");
        iframe.src = url;
        previewBody.appendChild(iframe);
      } else {
        const box = document.createElement("div");
        box.style.color = "rgba(255,255,255,.85)";
        box.style.textAlign = "center";
        box.innerHTML = `
          <div style="font-weight:900; font-size:16px; margin-bottom:6px;">Arquivo</div>
          <div style="color:rgba(255,255,255,.65); font-size:13px;">Sem preview autom√°tico.</div>
          <div style="margin-top:12px;">
            <a class="btn btnSmall" href="${url}" target="_blank" rel="noopener">Abrir / baixar</a>
          </div>
        `;
        previewBody.appendChild(box);
      }

      previewModal.style.display = "flex";
    }

    function closePreview(){
      previewModal.style.display = "none";
      previewBody.innerHTML = "";
    }

    btnClosePreview.addEventListener("click", closePreview);
    previewModal.addEventListener("click", (e) => {
      if(e.target === previewModal) closePreview();
    });
    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape") closePreview();
    });

    async function renderFiles(){
      const items = applyFilters(filesCache);

      // empty
      showEmptyIfNeeded(items.length > 0);

      // list
      listContainer.innerHTML = "";
      galleryContainer.innerHTML = "";

      if(!items.length) return;

      if(currentTab === "list"){
        items.forEach((f) => {
          const el = document.createElement("div");
          el.className = "item";

          const left = document.createElement("div");
          left.className = "left";

          const badge = document.createElement("div");
          badge.className = "badge";
          badge.textContent = typeLabel(f.type || guessTypeFromUrl(f.url));

          const meta = document.createElement("div");
          meta.className = "meta";

          const name = document.createElement("div");
          name.className = "name";
          name.textContent = f.name || "Sem nome";

          const sub = document.createElement("div");
          sub.className = "sub";
          const folder = f.folder ? `üìÅ ${f.folder}` : "üìÅ ‚Äî";
          const size = f.bytes ? ` ‚Ä¢ ${Math.round(f.bytes/1024)} KB` : "";
          sub.textContent = `${folder}${size}`;

          meta.appendChild(name);
          meta.appendChild(sub);

          left.appendChild(badge);
          left.appendChild(meta);

          const right = document.createElement("div");
          right.className = "right";

          const btnPrev = document.createElement("button");
          btnPrev.className = "btn btnSmall";
          btnPrev.textContent = "Preview";
          btnPrev.addEventListener("click", () => openPreview(f));

          const btnOpen = document.createElement("a");
          btnOpen.className = "btn btnSmall";
          btnOpen.textContent = "Abrir";
          btnOpen.href = f.url;
          btnOpen.target = "_blank";
          btnOpen.rel = "noopener";

          right.appendChild(btnPrev);
          right.appendChild(btnOpen);

          el.appendChild(left);
          el.appendChild(right);

          listContainer.appendChild(el);
        });
      } else {
        // gallery
        items.forEach((f) => {
          const type = f.type || guessTypeFromUrl(f.url);
          const g = document.createElement("div");
          g.className = "gItem";
          g.addEventListener("click", () => openPreview(f));

          let thumb;
          if(type === "image"){
            thumb = document.createElement("img");
            thumb.src = f.url;
            thumb.alt = f.name || "imagem";
            thumb.className = "gThumb";
          } else {
            thumb = document.createElement("div");
            thumb.className = "gThumb";
            thumb.style.display = "grid";
            thumb.style.placeItems = "center";
            thumb.style.fontWeight = "900";
            thumb.style.opacity = ".9";
            thumb.textContent = typeLabel(type);
          }

          const meta = document.createElement("div");
          meta.className = "gMeta";
          meta.textContent = f.name || "Sem nome";

          g.appendChild(thumb);
          g.appendChild(meta);
          galleryContainer.appendChild(g);
        });
      }
    }

    async function loadFiles(){
      if(!currentUser) return;
      showLoader(true);

      try{
        const snap = await getUserRoot()
          .collection("files")
          .orderBy("createdAt", "desc")
          .get();

        filesCache = snap.docs.map(d => ({ id: d.id, ...(d.data() || {}) }));
        await renderFiles();
      }catch(err){
        alert("Erro ao carregar arquivos: " + err.message);
      }finally{
        showLoader(false);
      }
    }

    async function uploadToCloudinary(file, folder){
      const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;
      const form = new FormData();
      form.append("file", file);
      form.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      // organiza√ß√£o (pasta) no Cloudinary
      // dica: salva como "meu-drive/<uid>/<folder>"
      const cleanFolder = normalizeFolder(folder) || "Outros";
      form.append("folder", `meu-drive/${currentUser.uid}/${cleanFolder}`);

      const res = await fetch(url, { method:"POST", body: form });
      const data = await res.json();
      if(!res.ok){
        throw new Error(data?.error?.message || "Falha no upload Cloudinary");
      }
      return data;
    }

    function normalizeFileTypeFromCloudinary(resourceType, url){
      // cloudinary manda resource_type "image", "video", "raw"
      if(resourceType === "image") return "image";
      if(resourceType === "video") return "video";
      // raw pode ser pdf, zip, etc
      if((url || "").toLowerCase().includes(".pdf")) return "pdf";
      return "other";
    }

    async function saveFileToFirestore(info){
      await getUserRoot().collection("files").add({
        uid: currentUser.uid,
        name: info.name,
        url: info.url,
        type: info.type,
        folder: info.folder,
        bytes: info.bytes || null,
        public_id: info.public_id || null,
        resource_type: info.resource_type || null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    async function handleUpload(){
      if(!currentUser){
        alert("Voc√™ precisa estar logado.");
        return;
      }

      const file = fileInput.files && fileInput.files[0];
      if(!file){
        alert("Escolha um arquivo primeiro.");
        return;
      }

      const folder = folderSelect.value || "Outros";

      // valida se cloudinary foi preenchido
      if(!CLOUDINARY_CLOUD_NAME || CLOUDINARY_CLOUD_NAME.includes("COLE_AQUI")){
        alert("Preencha o CLOUDINARY_CLOUD_NAME no c√≥digo.");
        return;
      }
      if(!CLOUDINARY_UPLOAD_PRESET || CLOUDINARY_UPLOAD_PRESET.includes("COLE_AQUI")){
        alert("Preencha o CLOUDINARY_UPLOAD_PRESET no c√≥digo.");
        return;
      }

      showLoader(true);
      btnUpload.disabled = true;

      try{
        const up = await uploadToCloudinary(file, folder);

        const url = up.secure_url;
        const type = normalizeFileTypeFromCloudinary(up.resource_type, url);

        await saveFileToFirestore({
          name: file.name,
          url,
          type,
          folder,
          bytes: file.size,
          public_id: up.public_id,
          resource_type: up.resource_type
        });

        fileInput.value = "";
        await loadFiles();
      }catch(err){
        alert("Erro no upload: " + err.message);
      }finally{
        btnUpload.disabled = false;
        showLoader(false);
      }
    }

    async function addFolder(){
      const name = normalizeFolder(newFolder.value);
      if(!name){
        alert("Digite o nome da pasta.");
        return;
      }

      showLoader(true);
      try{
        const folders = await ensureFolders();
        if(folders.includes(name)){
          alert("Essa pasta j√° existe.");
          return;
        }
        const updated = [...folders, name];
        await saveFolders(updated);
        renderFolderSelect(updated);
        folderSelect.value = name;
        newFolder.value = "";
      }catch(err){
        alert("Erro ao criar pasta: " + err.message);
      }finally{
        showLoader(false);
      }
    }

    async function initAppForUser(user){
      currentUser = user;

      setUserChip(user);

      const folders = await ensureFolders();
      renderFolderSelect(folders);

      await loadFiles();

      showView("app");
      // Mostra chip no topo depois de logar
      userChip.style.display = "flex";
    }

    /*****************************************************************
     * AUTH
     *****************************************************************/
    btnLogin.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const pass = passwordInput.value.trim();
      if(!email || !pass) return alert("Preencha email e senha.");

      showLoader(true);
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(err){
        alert("Erro: " + err.message);
      }finally{
        showLoader(false);
      }
    });

    btnRegister.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const pass = passwordInput.value.trim();
      if(!email || !pass) return alert("Preencha email e senha.");

      showLoader(true);
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
      }catch(err){
        alert("Erro: " + err.message);
      }finally{
        showLoader(false);
      }
    });

    btnLogout.addEventListener("click", async () => {
      showLoader(true);
      try{
        await auth.signOut();
      }catch(err){
        alert("Erro ao sair: " + err.message);
      }finally{
        showLoader(false);
      }
    });

    auth.onAuthStateChanged(async (user) => {
      showLoader(true);
      try{
        if(user){
          await initAppForUser(user);
        }else{
          currentUser = null;
          setUserChip(null);
          userChip.style.display = "none";
          showView("login");
        }
      }finally{
        showLoader(false);
      }
    });

    /*****************************************************************
     * UI EVENTS
     *****************************************************************/
    btnUpload.addEventListener("click", handleUpload);
    btnAddFolder.addEventListener("click", addFolder);

    tabList.addEventListener("click", () => setTab("list"));
    tabGallery.addEventListener("click", () => setTab("gallery"));

    searchInput.addEventListener("input", renderFiles);
    typeFilter.addEventListener("change", renderFiles);

    /*****************************************************************
     * PWA SW
     *****************************************************************/
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }
  </script>
</body>
</html>

