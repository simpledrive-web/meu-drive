<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meu Drive</title>

  <style>
    :root{
      --bg1:#071022; --bg2:#0b2a66;
      --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --brand:#4f7cf0;
      --danger:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:22px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; color-scheme:dark; }
    body{
      margin:0; color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 30% 20%, rgba(79,124,240,.35), transparent 60%),
        radial-gradient(900px 600px at 80% 60%, rgba(45,212,191,.22), transparent 55%),
        linear-gradient(160deg,var(--bg1),var(--bg2));
      overflow-x:hidden;
    }
    select, option { color-scheme: dark; }
    .wrap{ width:min(1050px,92vw); margin:20px auto 40px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:14px; margin-bottom:16px; }
    .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .appIcon{
      width:44px; height:44px; border-radius:14px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      display:grid; place-items:center;
      font-weight:900;
    }
    h1{ font-size:28px; margin:0; white-space:nowrap; }
    .subtitle{ margin:4px 0 0; color:var(--muted); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .userChip{
      display:none; align-items:center; gap:10px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:8px 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      max-width: 52%;
      min-width: 220px;
    }
    .avatar{
      width:34px; height:34px; border-radius:999px;
      background: linear-gradient(135deg, rgba(79,124,240,.9), rgba(45,212,191,.9));
      display:grid; place-items:center;
      font-weight:900;
      flex:0 0 auto;
    }
    .userMeta{ min-width:0; line-height:1.1; }
    .userName{ font-size:13px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .userEmail{ font-size:12px; color:var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .grid{ display:grid; grid-template-columns:1fr; gap:16px; }
    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .cardHead b{ font-size:14px; }
    .cardBody{ padding:14px 16px; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    .field{ flex:1 1 220px; min-width:180px; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,18,32,.55);
      color: var(--txt);
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color: rgba(255,255,255,.45); }
    select{
      appearance:none; -webkit-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.75) 50%),
        linear-gradient(135deg, rgba(255,255,255,.75) 50%, transparent 50%),
        linear-gradient(to right, rgba(255,255,255,.10), rgba(255,255,255,.10));
      background-position:
        calc(100% - 18px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px),
        calc(100% - 38px) 50%;
      background-size: 6px 6px, 6px 6px, 1px 18px;
      background-repeat:no-repeat;
      padding-right: 44px;
    }
    option{ background-color:#0b1220; color:#fff; }

    .btn{
      border:0;
      border-radius:16px;
      padding:12px 16px;
      font-weight:900;
      cursor:pointer;
      background: rgba(255,255,255,.10);
      color: var(--txt);
      border:1px solid rgba(255,255,255,.14);
      transition: transform .06s ease, filter .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{ background: linear-gradient(135deg, rgba(79,124,240,.95), rgba(79,124,240,.65)); border-color: rgba(79,124,240,.55); }
    .btnDanger{ background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(239,68,68,.55)); border-color: rgba(239,68,68,.55); }
    .btnSmall{ padding:10px 12px; border-radius:14px; font-size:13px; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }

    .tabs{
      display:flex; gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px; border-radius:999px;
      width: fit-content;
    }
    .tab{
      padding:10px 14px; border-radius:999px;
      font-weight:900; cursor:pointer;
      border:1px solid transparent;
      color: rgba(255,255,255,.75);
      background: transparent;
    }
    .tab.active{ background: rgba(79,124,240,.35); border-color: rgba(79,124,240,.45); color: var(--txt); }

    .list{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .item{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px; border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .left{ display:flex; align-items:center; gap:10px; min-width:0; cursor:pointer; }
    .badge{
      width:42px; height:42px; border-radius:14px;
      display:grid; place-items:center;
      background: rgba(79,124,240,.22);
      border:1px solid rgba(79,124,240,.25);
      overflow:hidden; flex:0 0 auto;
      font-weight:900;
    }
    .thumb{ width:42px; height:42px; border-radius:14px; object-fit:cover; display:block; }
    .meta{ min-width:0; }
    .name{ font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:52vw; }
    .sub{ font-size:12px; color:var(--muted2); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:52vw; }
    .right{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .gallery{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .gItem{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:hidden;
      cursor:pointer;
    }
    .gTop{
      aspect-ratio: 4/3;
      width:100%;
      background: rgba(0,0,0,.18);
      display:grid; place-items:center;
    }
    .gTop img, .gTop video{ width:100%; height:100%; object-fit:cover; display:block; }
    .gMeta{ padding:10px; }
    .gName{ font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .gSub{ font-size:12px; color:var(--muted2); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .empty{
      margin-top:12px;
      color: var(--muted2);
      text-align:center;
      padding:18px 10px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(2,8,18,.70);
      backdrop-filter: blur(8px);
      z-index:9999;
      padding:16px;
    }
    .modalCard{
      width:min(900px, 95vw);
      max-height: 92vh;
      overflow:auto;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: var(--shadow);
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalBody{ padding:14px; }
    .previewBox{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      overflow:hidden;
    }
    .previewBox img, .previewBox video, .previewBox iframe{
      width:100%;
      height: min(70vh, 520px);
      display:block;
      object-fit:contain;
      background: rgba(0,0,0,.35);
    }

    /* Loader */
    .loaderOverlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(2,8,18,.60);
      backdrop-filter: blur(8px);
      z-index:99999;
    }
    .spinner{
      width:56px; height:56px;
      border-radius:50%;
      border: 5px solid rgba(255,255,255,.18);
      border-top-color: rgba(79,124,240,.95);
      animation: spin .9s linear infinite;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
      .gallery{ grid-template-columns: repeat(3, 1fr); }
      .name, .sub{ max-width:360px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="appIcon">MD</div>
        <div style="min-width:0">
          <h1>Meu Drive ‚òÅÔ∏è</h1>
          <div class="subtitle">Seus arquivos em um s√≥ lugar.</div>
        </div>
      </div>

      <div class="userChip" id="userChip">
        <div class="avatar" id="avatar">U</div>
        <div class="userMeta">
          <div class="userName" id="userName">üëã Ol√°</div>
          <div class="userEmail" id="userEmail">‚Äî</div>
        </div>
        <button class="btn btnSmall btnDanger" id="btnLogout">Sair</button>
      </div>
    </div>

    <!-- AUTH -->
    <div class="grid" id="authView">
      <div class="card">
        <div class="cardHead">
          <b>Entrar</b><span style="font-size:12px;color:var(--muted2)">Login</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="field">
              <label>Email</label>
              <input id="loginEmail" type="email" placeholder="seuemail@gmail.com" />
            </div>
            <div class="field">
              <label>Senha</label>
              <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btnPrimary" id="btnLogin">Entrar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <b>Criar conta</b><span style="font-size:12px;color:var(--muted2)">Nome + Email + Senha</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="field">
              <label>Nome (vis√≠vel no topo)</label>
              <input id="signupName" type="text" placeholder="Ex: Isaias" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Email</label>
              <input id="signupEmail" type="email" placeholder="seuemail@gmail.com" />
            </div>
            <div class="field">
              <label>Senha</label>
              <input id="signupPass" type="password" placeholder="Crie uma senha (min 6)" />
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btnPrimary" id="btnSignup">Criar conta</button>
          </div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div class="grid" id="appView" style="display:none;">
      <div class="card">
        <div class="cardHead">
          <b>Upload</b><span style="font-size:12px;color:var(--muted2)">Cloudinary (direto) + Firestore</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="field">
              <label>Arquivo</label>
              <input id="fileInput" type="file" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Pasta</label>
              <select id="folderSelect"></select>
            </div>
            <div class="field">
              <label>Nome do arquivo (opcional)</label>
              <input id="customName" type="text" placeholder="Ex: Contrato aluguel 2026" />
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btnPrimary" id="btnUpload">Enviar arquivo</button>
            <button class="btn" id="btnNewFolder">+ Nova pasta</button>
          </div>

          <hr style="margin:16px 0;border:0;border-top:1px solid rgba(255,255,255,.10)" />

          <div class="row">
            <div class="field">
              <label>Buscar por nome</label>
              <input id="searchInput" type="text" placeholder="Ex: contrato, foto, v√≠deo..." />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Filtrar por pasta</label>
              <select id="filterFolder"></select>
            </div>
            <div class="field">
              <label>Filtrar por tipo</label>
              <select id="filterType">
                <option value="all">Todos</option>
                <option value="image">Imagens</option>
                <option value="video">V√≠deos</option>
                <option value="raw">PDF/Outros</option>
              </select>
            </div>
          </div>

          <div style="margin-top:8px;font-size:12px;color:var(--muted2)" id="statusLine"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <b>Arquivos</b>
          <div class="tabs">
            <button class="tab active" id="tabList">Lista</button>
            <button class="tab" id="tabGallery">Galeria</button>
          </div>
        </div>
        <div class="cardBody">
          <div id="listView"></div>
          <div id="galleryView" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal preview -->
  <div class="modal" id="modal">
    <div class="modalCard">
      <div class="modalHead">
        <div style="min-width:0">
          <div style="font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="modalTitle">Arquivo</div>
          <div style="font-size:12px;color:var(--muted2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="modalSub">‚Äî</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btnSmall" id="btnModalRename">Renomear</button>
          <button class="btn btnSmall" id="btnModalMove">Mover</button>
          <a class="btn btnSmall" id="btnModalOpen" target="_blank" rel="noopener">Abrir</a>
          <button class="btn btnSmall btnDanger" id="btnModalDelete">Excluir</button>
          <button class="btn btnSmall" id="btnModalClose">Fechar</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="previewBox" id="previewBox"></div>
      </div>
    </div>
  </div>

  <div class="loaderOverlay" id="loader"><div class="spinner"></div></div>

  <script type="module">
    // =========================
    // CONFIG (PREENCHA AQUI)
    // =========================
    const FIREBASE_CONFIG = {
      // COLE AQUI seu firebaseConfig (apiKey, authDomain, projectId, storageBucket, messagingSenderId, appId)
    };

    // ‚úÖ Para testar no PC:
    const API_BASE = "http://localhost:3333";
    // ‚úÖ Depois de publicar no Render, voc√™ troca pra:
    // const API_BASE = "https://seu-backend.onrender.com";
    // =========================

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      updateProfile,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc,
      addDoc, updateDoc, deleteDoc,
      onSnapshot, query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);
    const showLoader = (v) => { $("loader").style.display = v ? "flex" : "none"; };
    const setStatus = (t) => { $("statusLine").textContent = t || ""; };

    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI
    const authView = $("authView");
    const appView  = $("appView");
    const userChip = $("userChip");

    // State
    let currentUser = null;
    let folders = [];
    let files = [];
    let selectedFile = null;
    let unsubFolders = null;
    let unsubFiles = null;

    // ---------------- AUTH ----------------
    $("btnLogin").onclick = async () => {
      try{
        showLoader(true);
        const email = $("loginEmail").value.trim();
        const pass  = $("loginPass").value.trim();
        await signInWithEmailAndPassword(auth, email, pass);
      } catch(e){
        console.error(e);
        alert("Erro no login. Veja o console.");
      } finally {
        showLoader(false);
      }
    };

    $("btnSignup").onclick = async () => {
      try{
        showLoader(true);
        const name  = $("signupName").value.trim();
        const email = $("signupEmail").value.trim();
        const pass  = $("signupPass").value.trim();

        if(!name) return alert("Digite seu nome.");
        if(!email) return alert("Digite seu email.");
        if(pass.length < 6) return alert("Senha precisa ter no m√≠nimo 6 caracteres.");

        const cred = await createUserWithEmailAndPassword(auth, email, pass);

        await updateProfile(cred.user, { displayName: name });

        await setDoc(doc(db, "users", cred.user.uid), {
          uid: cred.user.uid,
          name,
          email,
          createdAt: serverTimestamp(),
        }, { merge:true });

      } catch(e){
        console.error(e);
        alert("Erro ao criar conta. Veja o console.");
      } finally {
        showLoader(false);
      }
    };

    $("btnLogout").onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (u) => {
      currentUser = u || null;

      if(!currentUser){
        if(unsubFolders) unsubFolders();
        if(unsubFiles) unsubFiles();
        folders = [];
        files = [];
        selectedFile = null;

        userChip.style.display = "none";
        appView.style.display = "none";
        authView.style.display = "grid";
        return;
      }

      authView.style.display = "none";
      appView.style.display = "grid";
      userChip.style.display = "flex";

      await loadProfileHeader();
      listenFolders();
      listenFiles();
    });

    async function loadProfileHeader(){
      try{
        let displayName = currentUser.displayName || "";
        const email = currentUser.email || "";

        if(!displayName){
          const snap = await getDoc(doc(db,"users",currentUser.uid));
          if(snap.exists()) displayName = snap.data().name || "";
        }
        const finalName = displayName || (email ? email.split("@")[0] : "Usu√°rio");

        $("userName").textContent = `üëã Ol√°, ${capitalize(finalName)}`;
        $("userEmail").textContent = email || "‚Äî";
        $("avatar").textContent = (finalName || "U").trim().slice(0,1).toUpperCase();
      } catch(e){
        console.error(e);
        alert("Erro ao carregar seu perfil. Veja o console.");
      }
    }
    function capitalize(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

    // ---------------- FOLDERS ----------------
    $("btnNewFolder").onclick = async () => {
      const name = prompt("Nome da nova pasta:");
      if(!name) return;

      try{
        showLoader(true);
        await addDoc(collection(db,"folders"), {
          uid: currentUser.uid,
          name: name.trim(),
          createdAt: serverTimestamp(),
        });
      } catch(e){
        console.error(e);
        alert("Erro ao criar pasta.");
      } finally {
        showLoader(false);
      }
    };

    function listenFolders(){
      if(unsubFolders) unsubFolders();

      const qFolders = query(collection(db,"folders"), where("uid","==", currentUser.uid));

      unsubFolders = onSnapshot(qFolders, (snap) => {
        folders = snap.docs.map(d => ({ id:d.id, ...(d.data()||{}) }))
          .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

        renderFolderSelects();
      }, (err)=> console.error(err));
    }

    function renderFolderSelects(){
      $("folderSelect").innerHTML = "";
      $("filterFolder").innerHTML = "";

      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "Todas";
      $("filterFolder").appendChild(allOpt);

      const defaults = [
        { id:"images", name:"Imagens" },
        { id:"videos", name:"V√≠deos" },
        { id:"docs", name:"Documentos" },
        { id:"others", name:"Outros" },
      ];

      const merged = [
        ...defaults,
        ...folders.filter(f => !defaults.some(d => d.name.toLowerCase() === (f.name||"").toLowerCase()))
      ];

      for(const f of merged){
        const o1 = document.createElement("option");
        o1.value = f.id;
        o1.textContent = f.name;
        $("folderSelect").appendChild(o1);

        const o2 = document.createElement("option");
        o2.value = f.id;
        o2.textContent = f.name;
        $("filterFolder").appendChild(o2);
      }
    }

    // ---------------- FILES (Firestore) ----------------
    function listenFiles(){
      if(unsubFiles) unsubFiles();

      const qFiles = query(collection(db,"files"), where("uid","==", currentUser.uid));
      unsubFiles = onSnapshot(qFiles, (snap) => {
        files = snap.docs.map(d => ({ id:d.id, ...(d.data()||{}) }));

        files.sort((a,b)=>{
          const ta = a.createdAt?.seconds || 0;
          const tb = b.createdAt?.seconds || 0;
          return tb - ta;
        });

        renderFiles();
      }, (err)=> console.error(err));
    }

    // ---------------- Upload direto (Cloudinary) + salvar no Firestore ----------------
    $("btnUpload").onclick = async () => {
      const file = $("fileInput").files?.[0];
      if(!file) return alert("Escolha um arquivo.");

      const folderId = $("folderSelect").value;
      const folderName = $("folderSelect").selectedOptions?.[0]?.textContent || "‚Äî";
      const customName = $("customName").value.trim();
      const finalName = customName || file.name;

      try{
        setStatus("Enviando...");
        showLoader(true);

        const up = await uploadDirectSigned(file, folderId, customName);

        const type = up.resource_type || guessType(file);
        await addDoc(collection(db,"files"), {
          uid: currentUser.uid,
          name: finalName,
          originalName: file.name,
          url: up.secure_url,
          public_id: up.public_id,        // <- importante pra deletar depois
          type,                           // image | video | raw
          bytes: up.bytes || file.size,
          folderId,
          folderName,
          createdAt: serverTimestamp()
        });

        $("fileInput").value = "";
        $("customName").value = "";
        setStatus("Upload conclu√≠do ‚úÖ");

      } catch(e){
        console.error(e);
        setStatus("");
        alert("Erro no upload: " + (e.message || "Veja o console"));
      } finally {
        showLoader(false);
        setTimeout(()=> setStatus(""), 2200);
      }
    };

    function guessType(file){
      const t = (file.type||"").toLowerCase();
      if(t.startsWith("image/")) return "image";
      if(t.startsWith("video/")) return "video";
      return "raw";
    }

    async function uploadDirectSigned(file, folderId, customName){
      // 1) pede assinatura pro backend
      const sigRes = await fetch(`${API_BASE}/signature`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          folder: folderId || "",
          customName: customName || "",
          mimeType: file.type || ""
        })
      });

      const sig = await sigRes.json();
      if(!sigRes.ok || !sig.ok) throw new Error(sig.error || "Falha ao gerar assinatura");

      // 2) manda pro endpoint certo conforme tipo
      const resourceType = sig.resource_type || guessType(file);
      const uploadUrl = `https://api.cloudinary.com/v1_1/${sig.cloudName}/${resourceType}/upload`;

      const form = new FormData();
      form.append("file", file);
      form.append("api_key", sig.apiKey);
      form.append("timestamp", String(sig.timestamp));
      form.append("signature", sig.signature);
      form.append("overwrite", "false");

      if(sig.folder) form.append("folder", sig.folder);
      if(sig.public_id) form.append("public_id", sig.public_id);

      const upRes = await fetch(uploadUrl, { method:"POST", body: form });
      const upData = await upRes.json();
      if(!upRes.ok) throw new Error(upData?.error?.message || "Cloudinary upload falhou");

      return upData;
    }

    // ---------------- Filters + render ----------------
    $("searchInput").addEventListener("input", renderFiles);
    $("filterFolder").addEventListener("change", renderFiles);
    $("filterType").addEventListener("change", renderFiles);

    $("tabList").onclick = () => switchView("list");
    $("tabGallery").onclick = () => switchView("gallery");

    function switchView(v){
      const isList = v === "list";
      $("tabList").classList.toggle("active", isList);
      $("tabGallery").classList.toggle("active", !isList);
      $("listView").style.display = isList ? "block" : "none";
      $("galleryView").style.display = isList ? "none" : "block";
      renderFiles();
    }

    function renderFiles(){
      const search = $("searchInput").value.trim().toLowerCase();
      const ff = $("filterFolder").value;
      const ft = $("filterType").value;

      let arr = [...files];
      if(search) arr = arr.filter(x => (x.name||"").toLowerCase().includes(search));
      if(ff && ff !== "all") arr = arr.filter(x => x.folderId === ff);
      if(ft && ft !== "all") arr = arr.filter(x => x.type === ft);

      const isList = $("tabList").classList.contains("active");
      if(isList) renderList(arr);
      else renderGallery(arr);
    }

    function iconForType(type){
      if(type === "image") return "üñºÔ∏è";
      if(type === "video") return "üé¨";
      return "üìÑ";
    }
    function prettyBytes(n){
      if(!n && n !== 0) return "";
      const u=["B","KB","MB","GB"]; let i=0; let v=n;
      while(v>=1024 && i<u.length-1){ v/=1024; i++; }
      return `${v.toFixed(i===0?0:1)} ${u[i]}`;
    }
    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function renderList(arr){
      const box = $("listView");
      if(!arr.length){
        box.innerHTML = `<div class="empty">Nenhum arquivo ainda.</div>`;
        return;
      }
      const html = arr.map(f=>{
        const sub = `${f.folderName||"‚Äî"} ‚Ä¢ ${f.type||"‚Äî"} ${f.bytes?("‚Ä¢ "+prettyBytes(f.bytes)):""}`;
        const isImg = f.type === "image";
        return `
          <div class="item">
            <div class="left" data-open="${f.id}">
              <div class="badge">
                ${isImg ? `<img class="thumb" alt="" src="${esc(f.url)}" data-thumb="${f.id}">`
                        : `<span>${iconForType(f.type)}</span>`}
              </div>
              <div class="meta">
                <div class="name">${esc(f.name||"Sem nome")}</div>
                <div class="sub">${esc(sub)}</div>
              </div>
            </div>
            <div class="right">
              <button class="btn btnSmall" data-rename="${f.id}">Renomear</button>
              <button class="btn btnSmall" data-move="${f.id}">Mover</button>
              <button class="btn btnSmall btnDanger" data-delete="${f.id}">Excluir</button>
            </div>
          </div>
        `;
      }).join("");

      box.innerHTML = `<div class="list">${html}</div>`;

      // fallback seguro thumb
      box.querySelectorAll("img.thumb").forEach(img=>{
        img.addEventListener("error", ()=>{
          const badge = img.closest(".badge");
          if(!badge) return;
          badge.innerHTML = `<span>${iconForType("image")}</span>`;
        }, { once:true });
      });

      box.querySelectorAll("[data-open]").forEach(el=>{
        el.addEventListener("click", ()=> openModal(el.getAttribute("data-open")));
      });
      box.querySelectorAll("[data-rename]").forEach(btn=>{
        btn.addEventListener("click",(e)=>{ e.stopPropagation(); renameFile(btn.dataset.rename); });
      });
      box.querySelectorAll("[data-move]").forEach(btn=>{
        btn.addEventListener("click",(e)=>{ e.stopPropagation(); moveFile(btn.dataset.move); });
      });
      box.querySelectorAll("[data-delete]").forEach(btn=>{
        btn.addEventListener("click",(e)=>{ e.stopPropagation(); deleteFile(btn.dataset.delete); });
      });
    }

    function renderGallery(arr){
      const box = $("galleryView");
      if(!arr.length){
        box.innerHTML = `<div class="empty">Nenhum arquivo ainda.</div>`;
        return;
      }
      const html = arr.map(f=>{
        const sub = `${f.folderName||"‚Äî"} ‚Ä¢ ${f.type||"‚Äî"}`;
        const isImg = f.type === "image";
        const isVideo = f.type === "video";
        return `
          <div class="gItem" data-open="${f.id}">
            <div class="gTop">
              ${
                isImg ? `<img alt="" src="${esc(f.url)}" data-gthumb="${f.id}">`
                : isVideo ? `<video src="${esc(f.url)}" muted playsinline></video>`
                : `<div style="font-size:40px">${iconForType(f.type)}</div>`
              }
            </div>
            <div class="gMeta">
              <div class="gName">${esc(f.name||"Sem nome")}</div>
              <div class="gSub">${esc(sub)}</div>
            </div>
          </div>
        `;
      }).join("");

      box.innerHTML = `<div class="gallery">${html}</div>`;

      box.querySelectorAll("img[data-gthumb]").forEach(img=>{
        img.addEventListener("error", ()=>{
          const top = img.parentElement;
          if(!top) return;
          top.innerHTML = `<div style="font-size:40px">${iconForType("image")}</div>`;
        }, { once:true });
      });

      box.querySelectorAll("[data-open]").forEach(el=>{
        el.addEventListener("click", ()=> openModal(el.getAttribute("data-open")));
      });
    }

    // ---------------- Actions (Firestore + Backend delete) ----------------
    async function renameFile(id){
      const f = files.find(x=>x.id===id);
      if(!f) return;
      const newName = prompt("Novo nome:", f.name || "");
      if(!newName) return;

      try{
        showLoader(true);
        await updateDoc(doc(db,"files",id), { name: newName.trim() });
      } catch(e){
        console.error(e);
        alert("Erro ao renomear.");
      } finally {
        showLoader(false);
      }
    }

    async function moveFile(id){
      const f = files.find(x=>x.id===id);
      if(!f) return;

      const opts = [...$("folderSelect").options].map(o=>({id:o.value, name:o.textContent}));
      const list = opts.map((o,i)=> `${i+1}) ${o.name}`).join("\n");
      const pick = prompt("Mover para qual pasta?\n\n" + list + "\n\nDigite o n√∫mero:");
      const idx = Number(pick) - 1;
      if(Number.isNaN(idx) || idx < 0 || idx >= opts.length) return;

      try{
        showLoader(true);
        await updateDoc(doc(db,"files",id), { folderId: opts[idx].id, folderName: opts[idx].name });
      } catch(e){
        console.error(e);
        alert("Erro ao mover.");
      } finally {
        showLoader(false);
      }
    }

    async function deleteFile(id){
      const f = files.find(x=>x.id===id);
      if(!f) return;
      if(!confirm(`Excluir "${f.name}"?\n\nIsso remove do Cloudinary e da lista.`)) return;

      try{
        showLoader(true);

        // 1) deletar no Cloudinary via backend
        if(f.public_id){
          const delRes = await fetch(`${API_BASE}/files/${encodeURIComponent(f.public_id)}`, { method:"DELETE" });
          const delJson = await delRes.json().catch(()=> ({}));
          if(!delRes.ok || !delJson.ok){
            throw new Error(delJson.error || "Falha ao deletar no Cloudinary");
          }
        }

        // 2) deletar no Firestore
        await deleteDoc(doc(db,"files",id));

      } catch(e){
        console.error(e);
        alert("Erro ao excluir: " + (e.message || ""));
      } finally {
        showLoader(false);
      }
    }

    // ---------------- Modal Preview ----------------
    const modal = $("modal");
    $("btnModalClose").onclick = closeModal;
    modal.addEventListener("click",(e)=>{ if(e.target === modal) closeModal(); });

    $("btnModalRename").onclick = ()=> selectedFile && renameFile(selectedFile.id);
    $("btnModalMove").onclick   = ()=> selectedFile && moveFile(selectedFile.id);
    $("btnModalDelete").onclick = ()=> { if(selectedFile){ const id=selectedFile.id; closeModal(); deleteFile(id); } };

    function openModal(id){
      const f = files.find(x=>x.id===id);
      if(!f) return;
      selectedFile = f;

      $("modalTitle").textContent = f.name || "Arquivo";
      $("modalSub").textContent = `${f.folderName||"‚Äî"} ‚Ä¢ ${f.type||"‚Äî"} ${f.bytes?("‚Ä¢ "+prettyBytes(f.bytes)):""}`;
      $("btnModalOpen").href = f.url;

      const box = $("previewBox");
      box.innerHTML = "";

      if(f.type === "image"){
        const img = document.createElement("img");
        img.src = f.url; img.alt = f.name || "";
        img.onerror = ()=> box.innerHTML = `<div style="padding:18px;text-align:center;color:var(--muted2)">N√£o foi poss√≠vel carregar a imagem.</div>`;
        box.appendChild(img);
      } else if(f.type === "video"){
        const v = document.createElement("video");
        v.src = f.url; v.controls = true; v.playsInline = true;
        box.appendChild(v);
      } else {
        const iframe = document.createElement("iframe");
        iframe.src = f.url;
        iframe.onerror = ()=> box.innerHTML = `<div style="padding:18px;text-align:center;color:var(--muted2)">Preview indispon√≠vel. Use "Abrir".</div>`;
        box.appendChild(iframe);
      }

      modal.style.display = "flex";
    }

    function closeModal(){
      modal.style.display = "none";
      $("previewBox").innerHTML = "";
      selectedFile = null;
    }
  </script>
</body>
</html>
