<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b57d0" />
  <title>Meu Drive</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon-192.png" />

  <style>
    :root{
      --bg1:#071022;
      --bg2:#0b57d0;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --good:#27d07d;
      --danger:#ff4d4d;
      --accent:#5aa7ff;
      --accent2:#4a7cff;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --r: 22px;
      --r2: 16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 15%, rgba(92,240,199,.18), transparent 55%),
        radial-gradient(1000px 600px at 85% 30%, rgba(86,168,255,.22), transparent 55%),
        linear-gradient(155deg, var(--bg1), #0a1540 38%, #0a2c7a 72%, #0b57d0);
      overflow-x:hidden;
    }

    .wrap{
      width:min(980px, 92vw);
      margin: 26px auto 36px;
      display:flex;
      flex-direction:column;
      gap: 18px;
    }

    /* header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      user-select:none;
    }
    .logo{
      width:56px; height:56px;
      border-radius: 18px;
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; }
    .brand h1{
      margin:0;
      font-size: 26px;
      letter-spacing:.2px;
    }
    .brand p{
      margin: 2px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 13px;
      backdrop-filter: blur(10px);
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(255,255,255,.25);
    }
    .dot.ok{ background: var(--good); }

    /* cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      padding: 18px;
    }

    /* views + transitions */
    .view{
      opacity:0;
      transform: translateY(8px);
      pointer-events:none;
      transition: .28s ease;
      display:none;
    }
    .view.show{
      display:block;
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
    }

    /* loader overlay */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      backdrop-filter: blur(6px);
    }
    .overlay.show{ display:flex; }
    .spinner{
      width: 54px;
      height: 54px;
      border-radius: 999px;
      border: 5px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,255,255,.85);
      animation: spin .8s linear infinite;
    }
    .overlay .label{
      margin-top: 12px;
      text-align:center;
      color: rgba(255,255,255,.85);
      font-size: 14px;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* form */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .grid1{ display:grid; gap: 14px; }

    input, select{
      width:100%;
      padding: 13px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      color: var(--text);
      outline:none;
      font-size: 15px;
    }
    input::placeholder{ color: rgba(255,255,255,.55); }
    select{ appearance:none; }

    .btnrow{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn{
      padding: 13px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      color: var(--text);
      font-weight: 650;
      cursor:pointer;
      transition: .18s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.14); }
    .btn.primary{
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 14px 30px rgba(74,124,255,.25);
    }
    .btn.danger{
      background: rgba(255,77,77,.12);
      border-color: rgba(255,77,77,.30);
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(255,255,255,.16);
    }

    .muted{ color: var(--muted); font-size: 13px; }
    .hr{ height:1px; background: rgba(255,255,255,.10); margin: 14px 0; }

    /* tabs */
    .tabs{
      display:inline-flex;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 6px;
      gap: 6px;
    }
    .tab{
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      cursor:pointer;
      background: transparent;
      color: rgba(255,255,255,.75);
      font-weight: 700;
    }
    .tab.active{
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.95);
    }

    /* list */
    .list{
      display:grid;
      gap: 10px;
      margin-top: 12px;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .item .meta{
      min-width:0;
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .thumb{
      width:46px;height:46px;border-radius: 14px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      flex: 0 0 auto;
      display:grid;
      place-items:center;
      color: rgba(255,255,255,.75);
      font-weight:800;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .meta .name{
      font-weight: 750;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 46vw;
    }
    .meta .sub{
      font-size: 12px;
      color: rgba(255,255,255,.65);
      margin-top: 2px;
    }
    .item .actions{ display:flex; gap: 10px; }
    .linkbtn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.88);
      cursor:pointer;
      font-weight: 700;
    }
    .linkbtn:hover{ background: rgba(255,255,255,.12); }

    /* gallery */
    .gallery{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .gcard{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      aspect-ratio: 1 / 1;
      position:relative;
      cursor:pointer;
    }
    .gcard img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.05);
      transform: scale(1.02);
    }
    .gcard .badge{
      position:absolute;
      left: 10px;
      bottom: 10px;
      background: rgba(0,0,0,.45);
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.18);
      padding: 6px 8px;
      border-radius: 999px;
      font-size: 12px;
      backdrop-filter: blur(10px);
      max-width: 85%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      z-index: 9999;
      padding: 18px;
      backdrop-filter: blur(8px);
    }
    .modal.show{ display:flex; }
    .modalCard{
      width:min(760px, 92vw);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(15,22,40,.72);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalTitle{
      display:grid;
      gap:2px;
      min-width:0;
    }
    .modalTitle b{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modalTitle span{ color: var(--muted); font-size: 12px; }
    .modalBody{
      padding: 16px;
      display:flex;
      justify-content:center;
    }
    .modalBody img{
      width:min(560px, 86vw);
      max-height: 62vh;
      object-fit: contain;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .xbtn{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.9);
      cursor:pointer;
      font-weight:900;
    }

    /* responsive */
    @media (max-width: 780px){
      .grid2{ grid-template-columns: 1fr; }
      .gallery{ grid-template-columns: repeat(2, 1fr); }
      .meta .name{ max-width: 52vw; }
      .brand h1{ font-size: 22px; }
      .logo{ width:52px; height:52px; }
    }
  </style>
</head>

<body>
  <div class="overlay" id="overlay">
    <div style="display:flex;flex-direction:column;align-items:center;">
      <div class="spinner"></div>
      <div class="label" id="overlayLabel">Carregando…</div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modalCard">
      <div class="modalTop">
        <div class="modalTitle">
          <b id="modalName">Arquivo</b>
          <span id="modalSub">—</span>
        </div>
        <button class="xbtn" id="modalClose">✕</button>
      </div>
      <div class="modalBody">
        <img id="modalImg" alt="preview" />
      </div>
      <div style="padding: 0 16px 16px;">
        <div class="btnrow" style="justify-content:flex-end;">
          <button class="btn primary" id="modalOpen">Abrir / Download</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <img src="./icon-192.png" alt="logo" />
        </div>
        <div>
          <h1>Meu Drive ☁️</h1>
          <p id="subtitle" class="muted">Seus arquivos, do seu jeito.</p>
        </div>
      </div>

      <div class="pill" id="pwaPill">
        <span class="dot" id="pwaDot"></span>
        <span id="pwaText">PWA: verificando…</span>
      </div>
    </div>

    <!-- LOGIN VIEW -->
    <div class="card view show" id="loginView">
      <div class="grid1" style="max-width:540px;">
        <input id="email" type="email" placeholder="Email" autocomplete="email" />
        <input id="password" type="password" placeholder="Senha" autocomplete="current-password" />

        <div class="btnrow">
          <button class="btn primary" id="btnLogin">Entrar</button>
          <button class="btn ghost" id="btnRegister">Criar conta</button>
        </div>

        <div class="muted" id="loginHint"></div>
      </div>
    </div>

    <!-- APP VIEW -->
    <div class="card view" id="appView">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <div class="pill" style="gap:10px;">
          <span class="dot ok"></span>
          <span id="userLabel">Logado</span>
        </div>
        <button class="btn danger" id="btnLogout">Sair</button>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div class="grid1">
          <input id="fileInput" type="file" />
          <div class="btnrow">
            <button class="btn primary" id="btnUpload">Enviar arquivo</button>
          </div>
          <div class="muted" id="uploadHint">Dica: arquivos vão pro Cloudinary e a lista fica salva no Firestore.</div>
        </div>

        <div class="grid1">
          <select id="folderSelect"></select>
          <input id="search" placeholder="Buscar por nome…" />
          <select id="typeFilter">
            <option value="all">Todos</option>
            <option value="image">Imagens</option>
            <option value="video">Vídeos</option>
            <option value="pdf">PDFs</option>
            <option value="other">Outros</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <div class="tabs">
          <button class="tab active" id="tabList">Lista</button>
          <button class="tab" id="tabGallery">Galeria</button>
        </div>
        <div class="muted" id="countLabel">0 arquivo(s)</div>
      </div>

      <div id="emptyState" class="card" style="margin-top:12px; background: rgba(255,255,255,.05); border-radius: 18px; box-shadow:none;">
        <div class="muted">Nenhum arquivo ainda. (ou filtros escondendo tudo)</div>
      </div>

      <div id="listView" class="list"></div>
      <div id="galleryView" class="gallery" style="display:none;"></div>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ========= CONFIGS =========

    // Firebase config (o seu do Firebase)
    const firebaseConfig = {
      apiKey: "AIzaSyAYAwMfCDcXALBVM1uemmJA4aWQK5MNcc0",
      authDomain: "meu-drive-beb33.firebaseapp.com",
      projectId: "meu-drive-beb33",
      storageBucket: "meu-drive-beb33.firebasestorage.app",
      messagingSenderId: "661176300748",
      appId: "1:661176300748:web:68ab970ae9e668fdb67e69"
    };

    // Cloudinary (os seus dados)
    const CLOUDINARY_CLOUD_NAME = "dilyddwkg";
    const CLOUDINARY_UPLOAD_PRESET = "kv9sjt0g";

    // ========= UI HELPERS =========
    const $ = (id) => document.getElementById(id);

    const overlay = $("overlay");
    const overlayLabel = $("overlayLabel");
    const loginView = $("loginView");
    const appView = $("appView");

    function setLoading(on, text="Carregando…"){
      overlayLabel.textContent = text;
      overlay.classList.toggle("show", !!on);
    }

    function showView(view){
      // animação suave
      if(view === "login"){
        appView.classList.remove("show");
        setTimeout(()=> loginView.classList.add("show"), 60);
      }else{
        loginView.classList.remove("show");
        setTimeout(()=> appView.classList.add("show"), 60);
      }
    }

    function bytesToSize(bytes){
      if(!bytes && bytes !== 0) return "";
      const sizes = ["B","KB","MB","GB","TB"];
      const i = Math.min(Math.floor(Math.log(bytes)/Math.log(1024)), sizes.length-1);
      return (bytes/Math.pow(1024,i)).toFixed(i===0?0:1) + " " + sizes[i];
    }

    function fileKind(mime){
      if(!mime) return "other";
      if(mime.startsWith("image/")) return "image";
      if(mime.startsWith("video/")) return "video";
      if(mime === "application/pdf") return "pdf";
      return "other";
    }

    function iconText(kind){
      if(kind==="image") return "IMG";
      if(kind==="video") return "VID";
      if(kind==="pdf") return "PDF";
      return "ARQ";
    }

    // ========= FIREBASE INIT =========
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ========= STATE =========
    let currentUser = null;
    let allFiles = [];
    let currentTab = "list";

    // folders (simples: salva em localStorage + opção padrão)
    const FOLDERS_KEY = "simpledrive_folders_v1";
    function getFolders(){
      const base = ["Imagens", "Vídeos", "PDFs", "Outros"];
      try{
        const saved = JSON.parse(localStorage.getItem(FOLDERS_KEY) || "[]");
        const merged = [...new Set([...base, ...saved])];
        return merged;
      }catch{
        return base;
      }
    }
    function addFolder(name){
      const clean = (name||"").trim();
      if(!clean) return;
      const cur = getFolders();
      if(cur.includes(clean)) return;
      const saved = JSON.parse(localStorage.getItem(FOLDERS_KEY) || "[]");
      saved.push(clean);
      localStorage.setItem(FOLDERS_KEY, JSON.stringify(saved));
      renderFolderSelect();
    }

    function renderFolderSelect(){
      const sel = $("folderSelect");
      const folders = getFolders();
      sel.innerHTML = "";
      folders.forEach(f=>{
        const opt = document.createElement("option");
        opt.value = f;
        opt.textContent = "Pasta: " + f;
        sel.appendChild(opt);
      });
      const optNew = document.createElement("option");
      optNew.value = "__new__";
      optNew.textContent = "➕ Nova pasta…";
      sel.appendChild(optNew);
    }

    // ========= AUTH =========
    $("btnLogin").addEventListener("click", async ()=>{
      const email = $("email").value.trim();
      const pass = $("password").value;
      if(!email || !pass) return alert("Preencha email e senha.");
      setLoading(true, "Entrando…");
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        alert(e.message);
      }finally{
        setLoading(false);
      }
    });

    $("btnRegister").addEventListener("click", async ()=>{
      const email = $("email").value.trim();
      const pass = $("password").value;
      if(!email || !pass) return alert("Preencha email e senha.");
      setLoading(true, "Criando conta…");
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
      }catch(e){
        alert(e.message);
      }finally{
        setLoading(false);
      }
    });

    $("btnLogout").addEventListener("click", async ()=>{
      setLoading(true, "Saindo…");
      try{
        await auth.signOut();
      }finally{
        setLoading(false);
      }
    });

    // ========= FILES: FIRESTORE =========
    function filesRef(uid){
      return db.collection("users").doc(uid).collection("files");
    }

    function listenFiles(uid){
      return filesRef(uid).orderBy("createdAt","desc").onSnapshot((snap)=>{
        allFiles = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        render();
      });
    }

    let unsubscribeFiles = null;

    // ========= UPLOAD: CLOUDINARY =========
    async function uploadToCloudinary(file, folderName){
      const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;
      const form = new FormData();
      form.append("file", file);
      form.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      // cria “pastinha” no Cloudinary (organização)
      // obs: no Cloudinary isso é só um prefixo
      if(folderName) form.append("folder", `meu-drive/${folderName}`);

      const res = await fetch(url, { method:"POST", body: form });
      const data = await res.json();
      if(!res.ok) throw new Error(data?.error?.message || "Falha no upload");
      return data; // secure_url, public_id, bytes, format...
    }

    $("btnUpload").addEventListener("click", async ()=>{
      if(!currentUser) return alert("Você precisa estar logado.");
      const file = $("fileInput").files?.[0];
      if(!file) return alert("Escolha um arquivo primeiro.");

      // folder
      let folder = $("folderSelect").value;
      if(folder === "__new__"){
        const name = prompt("Nome da nova pasta:");
        if(name) addFolder(name);
        folder = getFolders().includes(name) ? name : getFolders()[0];
        $("folderSelect").value = folder;
      }

      setLoading(true, "Enviando arquivo…");
      try{
        const kind = fileKind(file.type);
        const cloud = await uploadToCloudinary(file, folder);

        await filesRef(currentUser.uid).add({
          name: file.name,
          bytes: cloud.bytes || file.size || 0,
          type: kind,
          mime: file.type || "",
          folder: folder || "Outros",
          url: cloud.secure_url,
          publicId: cloud.public_id, // importante pro delete depois
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        $("fileInput").value = "";
      }catch(e){
        alert("Erro no upload: " + e.message);
      }finally{
        setLoading(false);
      }
    });

    // ========= RENDER =========
    function getFiltered(){
      const q = $("search").value.trim().toLowerCase();
      const type = $("typeFilter").value;
      const folderLabel = ($("folderSelect").value || "").replace("Pasta: ","");
      const folder = $("folderSelect").value === "__new__" ? "" : $("folderSelect").value;

      return allFiles.filter(f=>{
        const matchesQ = !q || (f.name || "").toLowerCase().includes(q);
        const matchesType = (type==="all") || (f.type===type);
        const matchesFolder = !folder || (f.folder===folder);
        return matchesQ && matchesType && matchesFolder;
      });
    }

    function render(){
      const arr = getFiltered();
      $("countLabel").textContent = `${arr.length} arquivo(s)`;

      $("emptyState").style.display = arr.length ? "none" : "block";

      if(currentTab==="list"){
        $("listView").style.display = "grid";
        $("galleryView").style.display = "none";
        renderList(arr);
      }else{
        $("listView").style.display = "none";
        $("galleryView").style.display = "grid";
        renderGallery(arr);
      }
    }

    function renderList(arr){
      const root = $("listView");
      root.innerHTML = "";
      arr.forEach(f=>{
        const row = document.createElement("div");
        row.className = "item";

        const meta = document.createElement("div");
        meta.className = "meta";

        const th = document.createElement("div");
        th.className = "thumb";

        if(f.type==="image" && f.url){
          const img = document.createElement("img");
          img.src = f.url;
          img.alt = f.name || "imagem";
          th.appendChild(img);
        }else{
          th.textContent = iconText(f.type);
        }

        const txt = document.createElement("div");
        const name = document.createElement("div");
        name.className = "name";
        name.textContent = f.name || "arquivo";

        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = `${f.folder || "—"} • ${bytesToSize(f.bytes)} • ${f.type || "outro"}`;

        txt.appendChild(name);
        txt.appendChild(sub);

        meta.appendChild(th);
        meta.appendChild(txt);

        const actions = document.createElement("div");
        actions.className = "actions";

        const open = document.createElement("button");
        open.className = "linkbtn";
        open.textContent = "Abrir";
        open.onclick = ()=> window.open(f.url, "_blank");

        const del = document.createElement("button");
        del.className = "linkbtn";
        del.textContent = "Remover";
        del.style.borderColor = "rgba(255,77,77,.30)";
        del.style.background = "rgba(255,77,77,.10)";
        del.onclick = ()=> removeFile(f);

        actions.appendChild(open);
        actions.appendChild(del);

        row.appendChild(meta);
        row.appendChild(actions);
        root.appendChild(row);
      });
    }

    function renderGallery(arr){
      const root = $("galleryView");
      root.innerHTML = "";
      arr.filter(f=>f.type==="image" && f.url).forEach(f=>{
        const card = document.createElement("div");
        card.className = "gcard";

        const img = document.createElement("img");
        img.src = f.url;
        img.alt = f.name || "imagem";

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = f.name || "imagem";

        card.appendChild(img);
        card.appendChild(badge);

        card.onclick = ()=> openModal(f);
        root.appendChild(card);
      });
    }

    // ========= DELETE (por enquanto só remove do Firestore / lista)
    // Cloudinary delete: precisa endpoint seguro (não dá pra deletar direto do front com segurança)
    async function removeFile(file){
      if(!currentUser) return;
      if(!confirm(`Remover "${file.name}" da lista?`)) return;

      setLoading(true, "Removendo…");
      try{
        await filesRef(currentUser.uid).doc(file.id).delete();
        // (depois a gente faz o delete real do Cloudinary via Cloud Function / server)
      }catch(e){
        alert("Erro ao remover: " + e.message);
      }finally{
        setLoading(false);
      }
    }

    // ========= MODAL =========
    const modal = $("modal");
    $("modalClose").onclick = ()=> modal.classList.remove("show");
    modal.addEventListener("click", (e)=>{ if(e.target===modal) modal.classList.remove("show"); });

    function openModal(f){
      $("modalName").textContent = f.name || "Arquivo";
      $("modalSub").textContent = `${f.folder || "—"} • ${bytesToSize(f.bytes)}`;
      $("modalImg").src = f.url;
      $("modalOpen").onclick = ()=> window.open(f.url, "_blank");
      modal.classList.add("show");
    }

    // ========= TABS / FILTERS =========
    $("tabList").onclick = ()=>{
      currentTab = "list";
      $("tabList").classList.add("active");
      $("tabGallery").classList.remove("active");
      render();
    };
    $("tabGallery").onclick = ()=>{
      currentTab = "gallery";
      $("tabGallery").classList.add("active");
      $("tabList").classList.remove("active");
      render();
    };

    ["search","typeFilter","folderSelect"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        if(id==="folderSelect" && $("folderSelect").value==="__new__"){
          const name = prompt("Nome da nova pasta:");
          if(name) addFolder(name);
          $("folderSelect").value = name ? name : getFolders()[0];
        }
        render();
      });
      $(id).addEventListener("change", ()=>{
        if(id==="folderSelect" && $("folderSelect").value==="__new__"){
          const name = prompt("Nome da nova pasta:");
          if(name) addFolder(name);
          $("folderSelect").value = name ? name : getFolders()[0];
        }
        render();
      });
    });

    // ========= PWA STATUS =========
    function setPwaStatus(text, ok=false){
      $("pwaText").textContent = text;
      $("pwaDot").classList.toggle("ok", !!ok);
    }

    window.addEventListener("load", ()=>{
      // registra SW
      if("serviceWorker" in navigator){
        navigator.serviceWorker.register("./service-worker.js")
          .then(()=> setPwaStatus("PWA: pronto ✅", true))
          .catch(()=> setPwaStatus("PWA: falhou", false));
      } else {
        setPwaStatus("PWA: não suportado", false);
      }
    });

    // ========= AUTH STATE (o que estava te prendendo no loader) =========
    setLoading(true, "Validando sessão…");
    renderFolderSelect();

    auth.onAuthStateChanged((user)=>{
      currentUser = user || null;

      if(unsubscribeFiles){
        unsubscribeFiles();
        unsubscribeFiles = null;
      }

      if(!user){
        $("userLabel").textContent = "Deslogado";
        showView("login");
        setLoading(false);
        return;
      }

      $("userLabel").textContent = "Logado: " + (user.email || "usuário");
      showView("app");

      // começa a ouvir arquivos
      unsubscribeFiles = listenFiles(user.uid);

      // tira o loader (IMPORTANTÍSSIMO)
      setLoading(false);
    });

  </script>

  <script>
    // Evita cache velho do PWA no primeiro acesso
    // (não é obrigatório, mas ajuda quando troca muita coisa)
  </script>
</body>
</html>
